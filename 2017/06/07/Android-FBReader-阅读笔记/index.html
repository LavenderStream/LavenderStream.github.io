<!DOCTYPE html>
<html lang=en>
<head><meta name="generator" content="Hexo 3.8.0">
    <!-- so meta -->
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="HandheldFriendly" content="True">
    <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
    <meta name="description" content="FBREADER 源码阅读笔记前言这篇文章是我在读源码时候的笔记。是我的一个习惯吧！在阅读源码的时候会记录一下思路，省得自己会忘记，相当于“保护现场”了吧。由于是一边看代码一边记录，一定会有很多的错误，请大家见谅。 一、代码导入在 https://github.com/geometer/FBReaderJ 这个地址上就是fbreader的java项目。 版本库上面的项目是eclipse编写的，所以">
<meta name="keywords" content="top">
<meta property="og:type" content="article">
<meta property="og:title" content="Android -- FBReader 阅读笔记 （一）">
<meta property="og:url" content="https://lavenderstream.github.io/2017/06/07/Android-FBReader-阅读笔记/index.html">
<meta property="og:site_name" content="Tiny hexo">
<meta property="og:description" content="FBREADER 源码阅读笔记前言这篇文章是我在读源码时候的笔记。是我的一个习惯吧！在阅读源码的时候会记录一下思路，省得自己会忘记，相当于“保护现场”了吧。由于是一边看代码一边记录，一定会有很多的错误，请大家见谅。 一、代码导入在 https://github.com/geometer/FBReaderJ 这个地址上就是fbreader的java项目。 版本库上面的项目是eclipse编写的，所以">
<meta property="og:locale" content="en">
<meta property="og:image" content="http://upload-images.jianshu.io/upload_images/1285832-b85eda8375ed7eba.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240">
<meta property="og:image" content="http://upload-images.jianshu.io/upload_images/1285832-64150c323157d15b.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240">
<meta property="og:image" content="http://upload-images.jianshu.io/upload_images/1285832-5f91e1961d40a697.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240">
<meta property="og:image" content="http://upload-images.jianshu.io/upload_images/1285832-fef31aaa09c24d3b.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240">
<meta property="og:image" content="http://upload-images.jianshu.io/upload_images/1285832-9f467aaa18ed9b94.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240">
<meta property="og:image" content="http://upload-images.jianshu.io/upload_images/1285832-0f11ada01dfdcc4e.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240">
<meta property="og:image" content="http://upload-images.jianshu.io/upload_images/1285832-748d5e53cba5441a.png">
<meta property="og:image" content="http://upload-images.jianshu.io/upload_images/1285832-9d1fe7bbd2f273e4.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240">
<meta property="og:image" content="http://upload-images.jianshu.io/upload_images/1285832-8f2047c238f09216.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240">
<meta property="og:image" content="http://upload-images.jianshu.io/upload_images/1285832-da2718c32da2c4c5.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240">
<meta property="og:image" content="http://upload-images.jianshu.io/upload_images/1285832-293224e691cf1053.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240">
<meta property="og:image" content="http://upload-images.jianshu.io/upload_images/1285832-6db0ded4df8dd286.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240">
<meta property="og:image" content="http://upload-images.jianshu.io/upload_images/1285832-aad6afda339e53dd.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240">
<meta property="og:image" content="http://upload-images.jianshu.io/upload_images/1285832-84ea417bf7ba3a04.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240">
<meta property="og:image" content="http://upload-images.jianshu.io/upload_images/1285832-c4dbe0cfdaebc3d6.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240">
<meta property="og:image" content="http://upload-images.jianshu.io/upload_images/1285832-74a9c42083f5c1fa.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240">
<meta property="og:image" content="http://upload-images.jianshu.io/upload_images/1285832-73fff0f4033aa646.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240">
<meta property="og:updated_time" content="2018-10-27T05:20:22.646Z">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="Android -- FBReader 阅读笔记 （一）">
<meta name="twitter:description" content="FBREADER 源码阅读笔记前言这篇文章是我在读源码时候的笔记。是我的一个习惯吧！在阅读源码的时候会记录一下思路，省得自己会忘记，相当于“保护现场”了吧。由于是一边看代码一边记录，一定会有很多的错误，请大家见谅。 一、代码导入在 https://github.com/geometer/FBReaderJ 这个地址上就是fbreader的java项目。 版本库上面的项目是eclipse编写的，所以">
<meta name="twitter:image" content="http://upload-images.jianshu.io/upload_images/1285832-b85eda8375ed7eba.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240">
    
    
        
          
              <link rel="shortcut icon" href="/images/favicon.ico">
          
        
        
          
            <link rel="icon" type="image/png" href="/images/favicon-192x192.png" sizes="192x192">
          
        
        
          
            <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon.png">
          
        
    
    <!-- title -->
    <title>Android -- FBReader 阅读笔记 （一）</title>
    <!-- styles -->
    <link rel="stylesheet" href="/css/style.css">
    <!-- persian styles -->
    
      <link rel="stylesheet" href="/css/rtl.css">
    
    <!-- rss -->
    
    
</head>

<body class="max-width mx-auto px3 ltr">
    
      <div id="header-post">
  <a id="menu-icon" href="#"><i class="fas fa-bars fa-lg"></i></a>
  <a id="menu-icon-tablet" href="#"><i class="fas fa-bars fa-lg"></i></a>
  <a id="top-icon-tablet" href="#" onclick="$('html, body').animate({ scrollTop: 0 }, 'fast');" style="display:none;"><i class="fas fa-chevron-up fa-lg"></i></a>
  <span id="menu">
    <span id="nav">
      <ul>
         
          <li><a href="/">Home</a></li>
         
          <li><a href="/archives/">Writing</a></li>
         
          <li><a href="https://www.jianshu.com/u/4215db84d54e">JianShu</a></li>
         
          <li><a href="https://github.com/LavenderStream">GitHub</a></li>
         
          <li><a href="/about/">About</a></li>
        
      </ul>
    </span>
    <br>
    <span id="actions">
      <ul>
        
        <li><a class="icon" href="/2017/06/14/Android-FBReader-阅读笔记-（二）/"><i class="fas fa-chevron-left" aria-hidden="true" onmouseover="$('#i-prev').toggle();" onmouseout="$('#i-prev').toggle();"></i></a></li>
        
        
        <li><a class="icon" href="/2017/05/19/AndroidStudio-自动生成ViewModel的IDE插件/"><i class="fas fa-chevron-right" aria-hidden="true" onmouseover="$('#i-next').toggle();" onmouseout="$('#i-next').toggle();"></i></a></li>
        
        <li><a class="icon" href="#" onclick="$('html, body').animate({ scrollTop: 0 }, 'fast');"><i class="fas fa-chevron-up" aria-hidden="true" onmouseover="$('#i-top').toggle();" onmouseout="$('#i-top').toggle();"></i></a></li>
        <li><a class="icon" href="#"><i class="fas fa-share-alt" aria-hidden="true" onmouseover="$('#i-share').toggle();" onmouseout="$('#i-share').toggle();" onclick="$('#share').toggle();return false;"></i></a></li>
      </ul>
      <span id="i-prev" class="info" style="display:none;">Previous post</span>
      <span id="i-next" class="info" style="display:none;">Next post</span>
      <span id="i-top" class="info" style="display:none;">Back to top</span>
      <span id="i-share" class="info" style="display:none;">Share post</span>
    </span>
    <br>
    <div id="share" style="display: none">
      <ul>
  <li><a class="icon" href="http://www.facebook.com/sharer.php?u=https://lavenderstream.github.io/2017/06/07/Android-FBReader-阅读笔记/"><i class="fab fa-facebook " aria-hidden="true"></i></a></li>
  <li><a class="icon" href="https://twitter.com/share?url=https://lavenderstream.github.io/2017/06/07/Android-FBReader-阅读笔记/&text=Android -- FBReader 阅读笔记 （一）"><i class="fab fa-twitter " aria-hidden="true"></i></a></li>
  <li><a class="icon" href="http://www.linkedin.com/shareArticle?url=https://lavenderstream.github.io/2017/06/07/Android-FBReader-阅读笔记/&title=Android -- FBReader 阅读笔记 （一）"><i class="fab fa-linkedin " aria-hidden="true"></i></a></li>
  <li><a class="icon" href="https://pinterest.com/pin/create/bookmarklet/?url=https://lavenderstream.github.io/2017/06/07/Android-FBReader-阅读笔记/&is_video=false&description=Android -- FBReader 阅读笔记 （一）"><i class="fab fa-pinterest " aria-hidden="true"></i></a></li>
  <li><a class="icon" href="mailto:?subject=Android -- FBReader 阅读笔记 （一）&body=Check out this article: https://lavenderstream.github.io/2017/06/07/Android-FBReader-阅读笔记/"><i class="fas fa-envelope " aria-hidden="true"></i></a></li>
  <li><a class="icon" href="https://getpocket.com/save?url=https://lavenderstream.github.io/2017/06/07/Android-FBReader-阅读笔记/&title=Android -- FBReader 阅读笔记 （一）"><i class="fab fa-get-pocket " aria-hidden="true"></i></a></li>
  <li><a class="icon" href="http://reddit.com/submit?url=https://lavenderstream.github.io/2017/06/07/Android-FBReader-阅读笔记/&title=Android -- FBReader 阅读笔记 （一）"><i class="fab fa-reddit " aria-hidden="true"></i></a></li>
  <li><a class="icon" href="http://www.stumbleupon.com/submit?url=https://lavenderstream.github.io/2017/06/07/Android-FBReader-阅读笔记/&title=Android -- FBReader 阅读笔记 （一）"><i class="fab fa-stumbleupon " aria-hidden="true"></i></a></li>
  <li><a class="icon" href="http://digg.com/submit?url=https://lavenderstream.github.io/2017/06/07/Android-FBReader-阅读笔记/&title=Android -- FBReader 阅读笔记 （一）"><i class="fab fa-digg " aria-hidden="true"></i></a></li>
  <li><a class="icon" href="http://www.tumblr.com/share/link?url=https://lavenderstream.github.io/2017/06/07/Android-FBReader-阅读笔记/&name=Android -- FBReader 阅读笔记 （一）&description="><i class="fab fa-tumblr " aria-hidden="true"></i></a></li>
</ul>

    </div>
    <div id="toc">
      <ol class="toc"><li class="toc-item toc-level-1"><a class="toc-link" href="#FBREADER-源码阅读笔记"><span class="toc-number">1.</span> <span class="toc-text">FBREADER 源码阅读笔记</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#前言"><span class="toc-number">1.1.</span> <span class="toc-text">前言</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#一、代码导入"><span class="toc-number">1.2.</span> <span class="toc-text">一、代码导入</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#1、目的"><span class="toc-number">1.2.0.1.</span> <span class="toc-text">1、目的</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#2、导入"><span class="toc-number">1.2.0.2.</span> <span class="toc-text">2、导入</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#3、运行"><span class="toc-number">1.2.0.3.</span> <span class="toc-text">3、运行</span></a></li></ol></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#二、源码目录"><span class="toc-number">1.3.</span> <span class="toc-text">二、源码目录</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#三、无目的的瞎看"><span class="toc-number">1.4.</span> <span class="toc-text">三、无目的的瞎看</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#六、跳转到固定章节"><span class="toc-number">1.5.</span> <span class="toc-text">六、跳转到固定章节</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#七、字体加大与缩小"><span class="toc-number">1.6.</span> <span class="toc-text">七、字体加大与缩小</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#八、音量键功能"><span class="toc-number">1.7.</span> <span class="toc-text">八、音量键功能</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#九、更换背景，字体颜色"><span class="toc-number">1.8.</span> <span class="toc-text">九、更换背景，字体颜色</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#十、动画类型"><span class="toc-number">1.9.</span> <span class="toc-text">十、动画类型</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#十一、点击区域"><span class="toc-number">1.10.</span> <span class="toc-text">十一、点击区域</span></a></li></ol>
    </div>
  </span>
</div>

    
    <div class="content index py4">
        
        <article class="post" itemscope="" itemtype="http://schema.org/BlogPosting">
  <header>
    
    <h1 class="posttitle" itemprop="name headline">
        Android -- FBReader 阅读笔记 （一）
    </h1>



    <div class="meta">
      <span class="author" itemprop="author" itemscope="" itemtype="http://schema.org/Person">
        <span itemprop="name">Tiny</span>
      </span>
      
    <div class="postdate">
        <time datetime="2017-06-07T02:49:00.000Z" itemprop="datePublished">2017-06-07</time>
    </div>


      

      
    <div class="article-tag">
        <i class="fas fa-tag"></i>
        <a class="tag-link" href="/tags/top/">top</a>
    </div>


    </div>
  </header>
  

  <div class="content" itemprop="articleBody">
    <h1 id="FBREADER-源码阅读笔记"><a href="#FBREADER-源码阅读笔记" class="headerlink" title="FBREADER 源码阅读笔记"></a>FBREADER 源码阅读笔记</h1><h2 id="前言"><a href="#前言" class="headerlink" title="前言"></a>前言</h2><p>这篇文章是我在读源码时候的笔记。是我的一个习惯吧！在阅读源码的时候会记录一下思路，省得自己会忘记，相当于“保护现场”了吧。由于是一边看代码一边记录，一定会有很多的错误，请大家见谅。</p>
<h2 id="一、代码导入"><a href="#一、代码导入" class="headerlink" title="一、代码导入"></a>一、代码导入</h2><p>在 <a href="https://github.com/geometer/FBReaderJ" target="_blank" rel="noopener">https://github.com/geometer/FBReaderJ</a> 这个地址上就是fbreader的java项目。</p>
<p>版本库上面的项目是eclipse编写的，所以第一步，想办法把这个项目变成AS上开发的</p>
<p>（因为种种原因，我并没有clone github上的源码，在我们svn存在着之前的一个fbreader版本，是2.0的）</p>
<h4 id="1、目的"><a href="#1、目的" class="headerlink" title="1、目的"></a>1、目的</h4><p>导入fbreader这个项目是想在自己的程序中加入阅读器的功能。但从头开始开发时间长，并且没做过。所以参考了fbreader，在源码的基础上做二次开发。</p>
<p>代码同步下来之后，发现。fbreader并不是一个开源库（SDK）,而是一个完整的项目，部分功能使用了jni开发，并且支持插件化，通过aidl，进行组件之间的通讯</p>
<p>因为要导入现有的项目（重构ing），想法是将fbreader整个项目编译成aar，然后导入现有项目。因为时间短，起初可以先把整个fbreader导入，之后对fbreader研究之后，或去掉相应模块或者重新开发</p>
<h4 id="2、导入"><a href="#2、导入" class="headerlink" title="2、导入"></a>2、导入</h4><p>导入过程比较繁琐，又没什么技术含量。主要就是将之前ant构建的项目换成gradle构建。</p>
<p>这里设计jni和aidl的目录结构有所变化，按照android studio上面的结构统一创建就好</p>
<p>（这里我犯了一个错误，fbreader的主项目千万别改报名，就按照之前的来，否则要改掉很多文件的import，相当费事儿。千万别改，千万别改，千万别改）</p>
<h4 id="3、运行"><a href="#3、运行" class="headerlink" title="3、运行"></a>3、运行</h4><p>先用ndk-build编出so， 然后在导入或者直接用android studio 带c++ 一起编， 都可以。反正 studio 也支持编译c语言了。</p>
<p>这里我直接使用ndk-build 编出so库，然后将so库添加到我的项目中去。省着clean项目的时候还要去重新编译，挺耗时间的。</p>
<h2 id="二、源码目录"><a href="#二、源码目录" class="headerlink" title="二、源码目录"></a>二、源码目录</h2><p>源码中的目录结构，其实我是在公司的svn里看到的，不知道谁写的，看时间，写这个文章的时候我刚上大学。</p>
<p>我就直接撸过来了。<br><img src="http://upload-images.jianshu.io/upload_images/1285832-b85eda8375ed7eba.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240" alt=""></p>
<p>用红笔画掉的是fbreader的一些三方以来，fbreader是主要的源码目录，</p>
<p>app 是我用来模仿公司的主项目的，其实就是一句startActivity。</p>
<p>以下是源码的一些目录<br><img src="http://upload-images.jianshu.io/upload_images/1285832-64150c323157d15b.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240" alt=""></p>
<p>jni 的文件目录</p>
<p><img src="http://upload-images.jianshu.io/upload_images/1285832-5f91e1961d40a697.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240" alt=""></p>
<p>整个项目的， 大概看一看</p>
<p><img src="http://upload-images.jianshu.io/upload_images/1285832-fef31aaa09c24d3b.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240" alt=""></p>
<h2 id="三、无目的的瞎看"><a href="#三、无目的的瞎看" class="headerlink" title="三、无目的的瞎看"></a>三、无目的的瞎看</h2><p>网上的资源不是很多，项目也较老了。再加上从未接触过阅读相关的项目。扎铁了老心。没有头绪就从头看代码吧。</p>
<p>再 AndroidManifest 能知道应用的主activity是<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"></span><br><span class="line">(这里强插一句， 想运行fbreader这个项目，application是要继承自FBReaderApplication；还要修改FBReaderIntents类的第一行的包名，保持与项目的包名一致)</span><br><span class="line"></span><br><span class="line">在FBReader先无目的看一下</span><br></pre></td></tr></table></figure></p>
<p>FBReader::onCreate<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"></span><br></pre></td></tr></table></figure></p>
<p>@Override<br>    protected void onCreate(Bundle icicle) {<br>        super.onCreate(icicle);<br>        // 捕获错误<br>        Thread.setDefaultUncaughtExceptionHandler(new UncaughtExceptionHandler(this));</p>
<pre><code>    bindService(
            new Intent(this, DataService.class),
            DataConnection,
            DataService.BIND_AUTO_CREATE
    );

    final Config config = Config.Instance();
    config.runOnConnect(new Runnable() {
        public void run() {
            config.requestAllValuesForGroup(&quot;Options&quot;);
            config.requestAllValuesForGroup(&quot;Style&quot;);
            config.requestAllValuesForGroup(&quot;LookNFeel&quot;);
            config.requestAllValuesForGroup(&quot;Fonts&quot;);
            config.requestAllValuesForGroup(&quot;Colors&quot;);
            config.requestAllValuesForGroup(&quot;Files&quot;);
        }
    });

    final ZLAndroidLibrary zlibrary = getZLibrary();
    myShowStatusBarFlag = zlibrary.ShowStatusBarOption.getValue();

    requestWindowFeature(Window.FEATURE_NO_TITLE);
    setContentView(R.layout.main);
    myRootView = (RelativeLayout) findViewById(R.id.root_view);
    myMainView = (ZLAndroidWidget) findViewById(R.id.main_view);
    // setting keyboard default mode
    setDefaultKeyMode(DEFAULT_KEYS_SEARCH_LOCAL);

    zlibrary.setActivity(this);

    myFBReaderApp = (FBReaderApp) FBReaderApp.Instance();
    if (myFBReaderApp == null) {
        myFBReaderApp = new FBReaderApp(new BookCollectionShadow());
    }
    getCollection().bindToService(this, null);
    myBook = null;

    myFBReaderApp.setWindow(this);
    myFBReaderApp.initWindow();

    myFBReaderApp.setExternalFileOpener(new ExternalFileOpener(this));

    getWindow().setFlags(
            WindowManager.LayoutParams.FLAG_FULLSCREEN,
            myShowStatusBarFlag ? 0 : WindowManager.LayoutParams.FLAG_FULLSCREEN
    );

    if (myFBReaderApp.getPopupById(TextSearchPopup.ID) == null) {
        new TextSearchPopup(myFBReaderApp);
    }
    if (myFBReaderApp.getPopupById(NavigationPopup.ID) == null) {
        new NavigationPopup(myFBReaderApp);
    }
    if (myFBReaderApp.getPopupById(SelectionPopup.ID) == null) {
        new SelectionPopup(myFBReaderApp);
    }

    myFBReaderApp.addAction(ActionCode.SHOW_LIBRARY, new ShowLibraryAction(this, myFBReaderApp));
    myFBReaderApp.addAction(ActionCode.SHOW_PREFERENCES, new ShowPreferencesAction(this, myFBReaderApp));
    myFBReaderApp.addAction(ActionCode.SHOW_BOOK_INFO, new ShowBookInfoAction(this, myFBReaderApp));
    myFBReaderApp.addAction(ActionCode.SHOW_TOC, new ShowTOCAction(this, myFBReaderApp));
    myFBReaderApp.addAction(ActionCode.SHOW_BOOKMARKS, new ShowBookmarksAction(this, myFBReaderApp));
    myFBReaderApp.addAction(ActionCode.SHOW_NETWORK_LIBRARY, new ShowNetworkLibraryAction(this, myFBReaderApp));

    myFBReaderApp.addAction(ActionCode.SHOW_MENU, new ShowMenuAction(this, myFBReaderApp));
    myFBReaderApp.addAction(ActionCode.SHOW_NAVIGATION, new ShowNavigationAction(this, myFBReaderApp));
    myFBReaderApp.addAction(ActionCode.SEARCH, new SearchAction(this, myFBReaderApp));
    myFBReaderApp.addAction(ActionCode.SHARE_BOOK, new ShareBookAction(this, myFBReaderApp));

    myFBReaderApp.addAction(ActionCode.SELECTION_SHOW_PANEL, new SelectionShowPanelAction(this, myFBReaderApp));
    myFBReaderApp.addAction(ActionCode.SELECTION_HIDE_PANEL, new SelectionHidePanelAction(this, myFBReaderApp));
    myFBReaderApp.addAction(ActionCode.SELECTION_COPY_TO_CLIPBOARD, new SelectionCopyAction(this, myFBReaderApp));
    myFBReaderApp.addAction(ActionCode.SELECTION_SHARE, new SelectionShareAction(this, myFBReaderApp));
    myFBReaderApp.addAction(ActionCode.SELECTION_TRANSLATE, new SelectionTranslateAction(this, myFBReaderApp));
    myFBReaderApp.addAction(ActionCode.SELECTION_BOOKMARK, new SelectionBookmarkAction(this, myFBReaderApp));

    myFBReaderApp.addAction(ActionCode.PROCESS_HYPERLINK, new ProcessHyperlinkAction(this, myFBReaderApp));
    myFBReaderApp.addAction(ActionCode.OPEN_VIDEO, new OpenVideoAction(this, myFBReaderApp));

    myFBReaderApp.addAction(ActionCode.SHOW_CANCEL_MENU, new ShowCancelMenuAction(this, myFBReaderApp));

    myFBReaderApp.addAction(ActionCode.SET_SCREEN_ORIENTATION_SYSTEM, new SetScreenOrientationAction(this, myFBReaderApp, ZLibrary.SCREEN_ORIENTATION_SYSTEM));
    myFBReaderApp.addAction(ActionCode.SET_SCREEN_ORIENTATION_SENSOR, new SetScreenOrientationAction(this, myFBReaderApp, ZLibrary.SCREEN_ORIENTATION_SENSOR));
    myFBReaderApp.addAction(ActionCode.SET_SCREEN_ORIENTATION_PORTRAIT, new SetScreenOrientationAction(this, myFBReaderApp, ZLibrary.SCREEN_ORIENTATION_PORTRAIT));
    myFBReaderApp.addAction(ActionCode.SET_SCREEN_ORIENTATION_LANDSCAPE, new SetScreenOrientationAction(this, myFBReaderApp, ZLibrary.SCREEN_ORIENTATION_LANDSCAPE));
    if (ZLibrary.Instance().supportsAllOrientations()) {
        myFBReaderApp.addAction(ActionCode.SET_SCREEN_ORIENTATION_REVERSE_PORTRAIT, new SetScreenOrientationAction(this, myFBReaderApp, ZLibrary.SCREEN_ORIENTATION_REVERSE_PORTRAIT));
        myFBReaderApp.addAction(ActionCode.SET_SCREEN_ORIENTATION_REVERSE_LANDSCAPE, new SetScreenOrientationAction(this, myFBReaderApp, ZLibrary.SCREEN_ORIENTATION_REVERSE_LANDSCAPE));
    }
    myFBReaderApp.addAction(ActionCode.OPEN_WEB_HELP, new OpenWebHelpAction(this, myFBReaderApp));
    myFBReaderApp.addAction(ActionCode.INSTALL_PLUGINS, new InstallPluginsAction(this, myFBReaderApp));

    final Intent intent = getIntent();
    final String action = intent.getAction();

    myOpenBookIntent = intent;
    if ((intent.getFlags() &amp; Intent.FLAG_ACTIVITY_LAUNCHED_FROM_HISTORY) == 0) {
        if (FBReaderIntents.Action.CLOSE.equals(action)) {
            myCancelIntent = intent;
            myOpenBookIntent = null;
        } else if (FBReaderIntents.Action.PLUGIN_CRASH.equals(action)) {
            myFBReaderApp.ExternalBook = null;
            myOpenBookIntent = null;
            getCollection().bindToService(this, new Runnable() {
                public void run() {
                    myFBReaderApp.openBook(null, null, null);
                }
            });
        }
    }
}
</code></pre><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">onCreate的代码好长一堆，还什么都看不懂。最后一段貌似是openBook 的操作， 但是intent和action 都是空的，根本不执行FBReader也不存在父类，只能是在```onResume()```中了</span><br></pre></td></tr></table></figure>
<p>FBReader::onResume()<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br></pre></td><td class="code"><pre><span class="line">```</span><br><span class="line">    @Override</span><br><span class="line">    protected void onResume() &#123;</span><br><span class="line">        super.onResume();</span><br><span class="line"></span><br><span class="line">        SyncOperations.enableSync(this, true);</span><br><span class="line"></span><br><span class="line">        myStartTimer = true;</span><br><span class="line">        Config.Instance().runOnConnect(new Runnable() &#123;</span><br><span class="line">            public void run() &#123;</span><br><span class="line">                final int brightnessLevel =</span><br><span class="line">                        getZLibrary().ScreenBrightnessLevelOption.getValue();</span><br><span class="line">                if (brightnessLevel != 0) &#123;</span><br><span class="line">                    setScreenBrightness(brightnessLevel);</span><br><span class="line">                &#125; else &#123;</span><br><span class="line">                    setScreenBrightnessAuto();</span><br><span class="line">                &#125;</span><br><span class="line">                if (getZLibrary().DisableButtonLightsOption.getValue()) &#123;</span><br><span class="line">                    setButtonLight(false);</span><br><span class="line">                &#125;</span><br><span class="line"></span><br><span class="line">                getCollection().bindToService(FBReader.this, new Runnable() &#123;</span><br><span class="line">                    public void run() &#123;</span><br><span class="line">                        final BookModel model = myFBReaderApp.Model;</span><br><span class="line">                        if (model == null || model.Book == null) &#123;</span><br><span class="line">                            return;</span><br><span class="line">                        &#125;</span><br><span class="line">                        onPreferencesUpdate(myFBReaderApp.Collection.getBookById(model.Book.getId()));</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;);</span><br><span class="line"></span><br><span class="line">        registerReceiver(myBatteryInfoReceiver, new IntentFilter(Intent.ACTION_BATTERY_CHANGED));</span><br><span class="line">        IsPaused = false;</span><br><span class="line">        myResumeTimestamp = System.currentTimeMillis();</span><br><span class="line">        if (OnResumeAction != null) &#123;</span><br><span class="line">            final Runnable action = OnResumeAction;</span><br><span class="line">            OnResumeAction = null;</span><br><span class="line">            action.run();</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        registerReceiver(mySyncUpdateReceiver, new IntentFilter(SyncOperations.UPDATED));</span><br><span class="line"></span><br><span class="line">        SetScreenOrientationAction.setOrientation(this, ZLibrary.Instance().getOrientationOption().getValue());</span><br><span class="line"></span><br><span class="line">        LogUtils.d(&quot;FBReader -&gt; onResume cancelIntent: &quot; + myCancelIntent);</span><br><span class="line">        LogUtils.d(&quot;FBReader -&gt; onResume myOpenBookIntent: &quot; + myOpenBookIntent);</span><br><span class="line"></span><br><span class="line">        if (myCancelIntent != null) &#123;</span><br><span class="line">            final Intent intent = myCancelIntent;</span><br><span class="line">            myCancelIntent = null;</span><br><span class="line">            getCollection().bindToService(this, new Runnable() &#123;</span><br><span class="line">                public void run() &#123;</span><br><span class="line">                    runCancelAction(intent);</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;);</span><br><span class="line">            return;</span><br><span class="line">        &#125; else if (myOpenBookIntent != null) &#123;</span><br><span class="line">            // it&apos;s maybe run here</span><br><span class="line">            final Intent intent = myOpenBookIntent;</span><br><span class="line">            myOpenBookIntent = null;</span><br><span class="line">            getCollection().bindToService(this, new Runnable() &#123;</span><br><span class="line">                public void run() &#123;</span><br><span class="line">                    openBook(intent, null, true);</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;);</span><br><span class="line">        &#125; else if (myFBReaderApp.getCurrentServerBook() != null) &#123;</span><br><span class="line">            getCollection().bindToService(this, new Runnable() &#123;</span><br><span class="line">                public void run() &#123;</span><br><span class="line">                    myFBReaderApp.useSyncInfo(true);</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;);</span><br><span class="line">        &#125; else if (myFBReaderApp.Model == null &amp;&amp; myFBReaderApp.ExternalBook != null) &#123;</span><br><span class="line">            getCollection().bindToService(this, new Runnable() &#123;</span><br><span class="line">                public void run() &#123;</span><br><span class="line">                    myFBReaderApp.openBook(myFBReaderApp.ExternalBook, null, null);</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;);</span><br><span class="line">        &#125; else &#123;</span><br><span class="line">            getCollection().bindToService(this, new Runnable() &#123;</span><br><span class="line">                public void run() &#123;</span><br><span class="line">                    myFBReaderApp.useSyncInfo(true);</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        PopupPanel.restoreVisibilities(myFBReaderApp);</span><br><span class="line">        ApiServerImplementation.sendEvent(this, ApiListener.EVENT_READ_MODE_OPENED);</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure></p>
<p>通过一顿的输出log并且debug代码，发现执行了onResume中最后的几个分支语句的第二个分支。</p>
<p>bindToService 这个是什么？ 先不管它，往下看</p>
<p>接下来调用了<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">FBReader::openBook(Intent intent, final Runnable action, boolean force)</span><br></pre></td></tr></table></figure></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br></pre></td><td class="code"><pre><span class="line">private synchronized void openBook(Intent intent, final Runnable action, boolean force) &#123;</span><br><span class="line">        if (!force &amp;&amp; myBook != null) &#123;</span><br><span class="line">            return;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        myBook = FBReaderIntents.getBookExtra(intent);</span><br><span class="line">        final Bookmark bookmark = FBReaderIntents.getBookmarkExtra(intent);</span><br><span class="line">        LogUtils.d(&quot;FBReader -&gt; openBook myBook: &quot; + myBook);</span><br><span class="line">        if (myBook == null) &#123;</span><br><span class="line">            final Uri data = intent.getData();</span><br><span class="line">            LogUtils.d(&quot;FBReader -&gt; openBook data: &quot; + data);</span><br><span class="line">            if (data != null) &#123;</span><br><span class="line">                myBook = createBookForFile(ZLFile.createFileByPath(data.getPath()));</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        if (myBook != null) &#123;</span><br><span class="line">            ZLFile file = myBook.File;</span><br><span class="line">            LogUtils.d(&quot;FBReader -&gt; openBook file path: &quot; + file.getPath());</span><br><span class="line">            LogUtils.d(&quot;FBReader -&gt; openBook file exists: &quot; + file.exists());</span><br><span class="line">            if (!file.exists()) &#123;</span><br><span class="line">                if (file.getPhysicalFile() != null) &#123;</span><br><span class="line">                    file = file.getPhysicalFile();</span><br><span class="line">                &#125;</span><br><span class="line">                UIUtil.showErrorMessage(this, &quot;fileNotFound&quot;, file.getPath());</span><br><span class="line">                myBook = null;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">        // 打开app 时 正常myBook为空 intent.getData 为空</span><br><span class="line">        /*</span><br><span class="line">        * 在主线程运行</span><br><span class="line">		*</span><br><span class="line">		* 正常打开时myBook， bookmark， action 三个参数都是空</span><br><span class="line">		* */</span><br><span class="line">        Config.Instance().runOnConnect(new Runnable() &#123;</span><br><span class="line">            public void run() &#123;</span><br><span class="line">                LogUtils.d(&quot;FBReader -&gt; openBook run thread: &quot; + Thread.currentThread());</span><br><span class="line">                LogUtils.d(&quot;FBReader -&gt; openBook run myBook: &quot; + myBook);</span><br><span class="line">                LogUtils.d(&quot;FBReader -&gt; openBook run bookmark: &quot; + bookmark);</span><br><span class="line">                LogUtils.d(&quot;FBReader -&gt; openBook run action: &quot; + action);</span><br><span class="line">                myFBReaderApp.openBook(myBook, bookmark, action);</span><br><span class="line">                AndroidFontUtil.clearFontCache();</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;);</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>
<p>直接能跟到最后几行的 <figure class="highlight plain"><figcaption><span>bookmark, action);``` 这一句</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">log输出，这三个参数都是空的。执行了FBReaderApp的openBook方法</span><br></pre></td></tr></table></figure></p>
<p>FBReaderApp::(Book book, final Bookmark bookmark, Runnable postAction)<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><span class="line">```</span><br><span class="line">public void openBook(Book book, final Bookmark bookmark, Runnable postAction) &#123;</span><br><span class="line">		LogUtils.d(&quot;FBReaderApp -&gt; openBook: &quot; + Model);</span><br><span class="line">		if (Model != null) &#123;</span><br><span class="line">			if (book == null || bookmark == null &amp;&amp; book.File.equals(Model.Book.File)) &#123;</span><br><span class="line">				return;</span><br><span class="line">			&#125;</span><br><span class="line">		&#125;</span><br><span class="line"></span><br><span class="line">		if (book == null) &#123;</span><br><span class="line">			book = getCurrentServerBook();</span><br><span class="line">			if (book == null) &#123;</span><br><span class="line">				showBookNotFoundMessage();</span><br><span class="line">				book = Collection.getRecentBook(0);</span><br><span class="line">			&#125;</span><br><span class="line">			if (book == null || !book.File.exists()) &#123;</span><br><span class="line">				// get helpfile</span><br><span class="line">				book = Collection.getBookByFile(BookUtil.getHelpFile());</span><br><span class="line">			&#125;</span><br><span class="line">			if (book == null) &#123;</span><br><span class="line">				return;</span><br><span class="line">			&#125;</span><br><span class="line">		&#125;</span><br><span class="line">		final Book bookToOpen = book;</span><br><span class="line">		bookToOpen.addLabel(Book.READ_LABEL);</span><br><span class="line">		Collection.saveBook(bookToOpen);</span><br><span class="line"></span><br><span class="line">		LogUtils.d(&quot;FBReaderApp -&gt; openBook bookToOpen: &quot; + bookToOpen);</span><br><span class="line"></span><br><span class="line">		final SynchronousExecutor executor = createExecutor(&quot;loadingBook&quot;);</span><br><span class="line">		executor.execute(new Runnable() &#123;</span><br><span class="line">			public void run() &#123;</span><br><span class="line">				openBookInternal(bookToOpen, bookmark, false);</span><br><span class="line">			&#125;</span><br><span class="line">		&#125;, postAction);</span><br><span class="line">	&#125;</span><br></pre></td></tr></table></figure></p>
<p>三个参数，大体上能猜测出是什么意思，但是，并不是很清晰。<br>执行到getCurrentServerBook一句时，但我们第一次启动应用是，此时的book对象是空，即使是getCurrentServerBook执行完之后还是空的。之后便去找到这个帮助文档getHelpFile。 然后转化成book对象。<br>之后，貌似创建了线程。</p>
<p>SynchronousExecutor这个东西是个接口由<figure class="highlight plain"><figcaption><span>createExecutor(String key)``` 创建</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"></span><br></pre></td></tr></table></figure></p>
<p>ZLApplication:: createExecutor(String key)<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">```</span><br><span class="line"> protected SynchronousExecutor createExecutor(String key) &#123;</span><br><span class="line">        if (myWindow != null) &#123;</span><br><span class="line">            return myWindow.createExecutor(key);</span><br><span class="line">        &#125; else &#123;</span><br><span class="line">            return myDummyExecutor;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure></p>
<p>这里调用了myWindow的createExecutor方法，myWindow（ZLApplicationWindow）是 一个接口，FBReader实现了这个接口。</p>
<p>接着，调用了UIUtil的createExecutor方法<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">UIUtil::createExecutor(final Activity activity, final String key)</span><br></pre></td></tr></table></figure></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br></pre></td><td class="code"><pre><span class="line">public static ZLApplication.SynchronousExecutor createExecutor(final Activity activity, final String key) &#123;</span><br><span class="line">    return new ZLApplication.SynchronousExecutor() &#123;</span><br><span class="line">        // 获得相应的文字资源</span><br><span class="line">        private final ZLResource myResource =</span><br><span class="line">                ZLResource.resource(&quot;dialog&quot;).getResource(&quot;waitMessage&quot;);</span><br><span class="line">        private final String myMessage = myResource.getResource(key).getValue();</span><br><span class="line">        private volatile ProgressDialog myProgress;</span><br><span class="line"></span><br><span class="line">        public void execute(final Runnable action, final Runnable uiPostAction) &#123;</span><br><span class="line">            activity.runOnUiThread(new Runnable() &#123;</span><br><span class="line">                public void run() &#123;</span><br><span class="line">                    // 在ui线程中创建一个对话框</span><br><span class="line">                    myProgress = ProgressDialog.show(activity, null, myMessage, true, false);</span><br><span class="line">                    // 在线程中执行第一个参数</span><br><span class="line">                    final Thread runner = new Thread() &#123;</span><br><span class="line">                        public void run() &#123;</span><br><span class="line">                            // 在线程中运行第一个参数，也就是打开图书（在）</span><br><span class="line">                            action.run();</span><br><span class="line">                            // 执行完之后，关闭这个对话框</span><br><span class="line">                            activity.runOnUiThread(new Runnable() &#123;</span><br><span class="line">                                public void run() &#123;</span><br><span class="line">                                    try &#123;</span><br><span class="line">                                        myProgress.dismiss();</span><br><span class="line">                                        myProgress = null;</span><br><span class="line">                                    &#125; catch (Exception e) &#123;</span><br><span class="line">                                        e.printStackTrace();</span><br><span class="line">                                    &#125;</span><br><span class="line">                                    if (uiPostAction != null) &#123;</span><br><span class="line">                                        uiPostAction.run();</span><br><span class="line">                                    &#125;</span><br><span class="line">                                &#125;</span><br><span class="line">                            &#125;);</span><br><span class="line">                        &#125;</span><br><span class="line">                    &#125;;</span><br><span class="line">                    runner.setPriority(Thread.MAX_PRIORITY);</span><br><span class="line">                    runner.start();</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        private void setMessage(final ProgressDialog progress, final String message) &#123;</span><br><span class="line">            if (progress == null) &#123;</span><br><span class="line">                return;</span><br><span class="line">            &#125;</span><br><span class="line">            activity.runOnUiThread(new Runnable() &#123;</span><br><span class="line">                public void run() &#123;</span><br><span class="line">                    progress.setMessage(message);</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        public void executeAux(String key, Runnable runnable) &#123;</span><br><span class="line">            setMessage(myProgress, myResource.getResource(key).getValue());</span><br><span class="line">            runnable.run();</span><br><span class="line">            setMessage(myProgress, myMessage);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>主要看execute方法，这里先显示一个进度框，然后执行第一个参数<figure class="highlight plain"><figcaption><span>就是在 ```FBReaderApp::openBook(Book book, final Bookmark bookmark, Runnable postAction)```中的</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"></span><br></pre></td></tr></table></figure></p>
<p>FBReaderApp::openBookInternal(bookToOpen, bookmark, false);<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br></pre></td><td class="code"><pre><span class="line">```</span><br><span class="line"></span><br><span class="line">    /**</span><br><span class="line">     * 打开内部的图书</span><br><span class="line">     */</span><br><span class="line">    private synchronized void openBookInternal(Book book, Bookmark bookmark, boolean force) &#123;</span><br><span class="line">        // 可能是跳转书签, 书签为空</span><br><span class="line">        LogUtils.d(&quot;FBReaderApp -&gt; openBookInternal bookmark: &quot; + bookmark);</span><br><span class="line">        if (!force &amp;&amp; Model != null &amp;&amp; book.equals(Model.Book)) &#123;</span><br><span class="line">            if (bookmark != null) &#123;</span><br><span class="line">                gotoBookmark(bookmark, false);</span><br><span class="line">            &#125;</span><br><span class="line">            return;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        onViewChanged();</span><br><span class="line">        storePosition();</span><br><span class="line"></span><br><span class="line">        BookTextView.setModel(null);</span><br><span class="line">        FootnoteView.setModel(null);</span><br><span class="line">        clearTextCaches();</span><br><span class="line">        Model = null;</span><br><span class="line">        ExternalBook = null;</span><br><span class="line">        System.gc();</span><br><span class="line">        System.gc();</span><br><span class="line"></span><br><span class="line">        // 猜测是根据book，加载一个用来读取这个book的插件</span><br><span class="line">        final FormatPlugin plugin = book.getPluginOrNull();</span><br><span class="line">        // 此时，阅读默认帮助文档时，插件为fb2</span><br><span class="line">        LogUtils.d(&quot;FBReaderApp -&gt; openBookInternal plugin: &quot; + plugin);</span><br><span class="line">        if (plugin instanceof ExternalFormatPlugin) &#123;</span><br><span class="line">            ExternalBook = book;</span><br><span class="line">            final Bookmark bm;</span><br><span class="line">            if (bookmark != null) &#123;</span><br><span class="line">                bm = bookmark;</span><br><span class="line">            &#125; else &#123;</span><br><span class="line">                ZLTextPosition pos = getStoredPosition(book);</span><br><span class="line">                if (pos == null) &#123;</span><br><span class="line">                    pos = new ZLTextFixedPosition(0, 0, 0);</span><br><span class="line">                &#125;</span><br><span class="line">                bm = new Bookmark(book, &quot;&quot;, pos, pos, &quot;&quot;, false);</span><br><span class="line">            &#125;</span><br><span class="line">            myExternalFileOpener.openFile((ExternalFormatPlugin) plugin, book, bm);</span><br><span class="line">            return;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        try &#123;</span><br><span class="line">            // 创建一个BookModel， 通过判断插件的type</span><br><span class="line">            Model = BookModel.createModel(book);</span><br><span class="line">            // BookCollectionShadow 暂时不懂</span><br><span class="line">            Collection.saveBook(book);</span><br><span class="line">            ZLTextHyphenator.Instance().load(book.getLanguage());</span><br><span class="line">            // 设置显示时的一些属性</span><br><span class="line">            BookTextView.setModel(Model.getTextModel());</span><br><span class="line">            setBookmarkHighlightings(BookTextView, null);</span><br><span class="line">            gotoStoredPosition();</span><br><span class="line">            if (bookmark == null) &#123;</span><br><span class="line">                setView(BookTextView);</span><br><span class="line">            &#125; else &#123;</span><br><span class="line">                gotoBookmark(bookmark, false);</span><br><span class="line">            &#125;</span><br><span class="line">            Collection.addBookToRecentList(book);</span><br><span class="line">            final StringBuilder title = new StringBuilder(book.getTitle());</span><br><span class="line">            if (!book.authors().isEmpty()) &#123;</span><br><span class="line">                boolean first = true;</span><br><span class="line">                for (Author a : book.authors()) &#123;</span><br><span class="line">                    title.append(first ? &quot; (&quot; : &quot;, &quot;);</span><br><span class="line">                    title.append(a.DisplayName);</span><br><span class="line">                    first = false;</span><br><span class="line">                &#125;</span><br><span class="line">                title.append(&quot;)&quot;);</span><br><span class="line">            &#125;</span><br><span class="line">            setTitle(title.toString());</span><br><span class="line">        &#125; catch (BookReadingException e) &#123;</span><br><span class="line">            processException(e);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        getViewWidget().reset();</span><br><span class="line">        getViewWidget().repaint();</span><br><span class="line"></span><br><span class="line">        try &#123;</span><br><span class="line">            for (FileEncryptionInfo info : book.getPlugin().readEncryptionInfos(book)) &#123;</span><br><span class="line">                if (info != null &amp;&amp; !EncryptionMethod.isSupported(info.Method)) &#123;</span><br><span class="line">                    showErrorMessage(&quot;unsupportedEncryptionMethod&quot;, book.File.getPath());</span><br><span class="line">                    break;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125; catch (BookReadingException e) &#123;</span><br><span class="line">            // ignore</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure></p>
<p>目前能读懂的都在注释上，貌似在执行 <figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"></span><br><span class="line">把帮助文档当成图书的话， 第一次出现对书的解析应该就是在BookUtil的getHelpFile的方法中</span><br></pre></td></tr></table></figure></p>
<p>BookUtil::getHelpFile()<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"></span><br></pre></td></tr></table></figure></p>
<p>public static ZLResourceFile getHelpFile() {<br>        final Locale locale = Locale.getDefault();<br>        // 获取local，取得帮助文档<br>        ZLResourceFile file = ZLResourceFile.createResourceFile(<br>            “data/help/MiniHelp.” + locale.getLanguage() + “_” + locale.getCountry() + “.fb2”<br>        );<br>        if (file.exists()) {<br>            return file;<br>        }</p>
<pre><code>    file = ZLResourceFile.createResourceFile(
        &quot;data/help/MiniHelp.&quot; + locale.getLanguage() + &quot;.fb2&quot;
    );
    if (file.exists()) {
        return file;
    }

    return ZLResourceFile.createResourceFile(&quot;data/help/MiniHelp.en.fb2&quot;);
}
</code></pre><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">通过固定的路径，调用了ZLResourceFile 的 createResourceFile</span><br></pre></td></tr></table></figure>
<p>ZLResourceFile :: createResourceFile(String path)<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">```</span><br><span class="line">	public static ZLResourceFile createResourceFile(String path) &#123;</span><br><span class="line">		ZLResourceFile file = ourCache.get(path);</span><br><span class="line">		if (file == null) &#123;</span><br><span class="line">			file = ZLibrary.Instance().createResourceFile(path);</span><br><span class="line">			ourCache.put(path, file);</span><br><span class="line">		&#125;</span><br><span class="line">		return file;</span><br><span class="line">	&#125;</span><br></pre></td></tr></table></figure></p>
<p>这里有个简单的缓存，然后调用了ZLibrary的createResourceFile方法。ZLibrary是个抽象类，ZLAndroidLibrary 实现了它， 并在application中进行了初始化操作。<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">ZLAndroidLibrary::createResourceFile(String path)</span><br></pre></td></tr></table></figure></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">@Override</span><br><span class="line">  public ZLResourceFile createResourceFile(String path) &#123;</span><br><span class="line">      return new AndroidAssetsFile(path);</span><br><span class="line">  &#125;</span><br></pre></td></tr></table></figure>
<p>这里，通过文件的路径，创建了一个AndroidAssetsFile。AndroidAssetsFile继承了ZLResourceFile，是ZLFile的子类。</p>
<p><img src="http://upload-images.jianshu.io/upload_images/1285832-9f467aaa18ed9b94.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240" alt=""></p>
<p>ZLFile 是fbreader对所有文件的同意描述。上图是继承树。</p>
<p>以下是从网络上摘取的资料</p>
<ul>
<li><p>ResourceFile类专门用来处理资源文件，这一章中要解析的assets文件夹下的资源文件都可以ZLResourceFile类来处理</p>
</li>
<li><p>ZLResourceFile类专门用来处理资源文件，这一章中要解析的assets文件夹下的资源文件都可以ZLResourceFile类来处理。</p>
</li>
<li><p>ZLPhysicalFile类专门用来处理普通文件，eoub文件就可以用一个ZLPhysicalFile类来代表。</p>
</li>
<li><p>ZLZipEntryFile类用来处理epub文件内部的xml文件，这个类会在第五章“epub文件处理 – 解压epub文件”中出现。</p>
</li>
</ul>
<p>这三个文件类都实现了getInputStream抽象方法，不用的文件类会通过这个方法获得针对当前文件类的字节流类。</p>
<p>AndroidAssetsFile类（ZLResourceFile类的子类）的getInputStream方法会返回AssetInputStream类，这个类可以将资源文件转换成byte数组。</p>
<p>ZLPhysicalFile类的getInputStream方法会返回FileInputStream类，这个类可以将普通的文件转换成byte数组。</p>
<p>ZLZipEntryFile类的getInputStream方法会返回FileInputStream类，这个类可以将epub内部压缩过的xml文件转换成可以正常解析的byte数组</p>
<p>下面看一下AndroidAssetsFile的getInputStream方法。可以猜测，读取帮助文档的时候调用getInputStream会返回这个文件的InputStream</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">AndroidAssetsFile:: getInputStream()</span><br></pre></td></tr></table></figure>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"> @Override</span><br><span class="line">public InputStream getInputStream() throws IOException &#123;</span><br><span class="line">     return myApplication.getAssets().open(getPath());</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>得到ZLResourceFile 对象之后，我们回到<figure class="highlight plain"><figcaption><span>这个方法中。</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">可以看到通过 ```book = Collection.getBookByFile(BookUtil.getHelpFile());</span><br></pre></td></tr></table></figure></p>
<p>将ZLResourceFile对象转成了Book 对象了。<br>Collection是一个接口IBookCollection， 这里是BookCollectionShadow实现了这个接口，在FBReaderApp的onCreate方法，我们可以看到这句</p>
<p><img src="http://upload-images.jianshu.io/upload_images/1285832-0f11ada01dfdcc4e.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240" alt=""></p>
<p>BookCollectionShadow又是什么呢？我们还要往下分析</p>
<hr>
<p>上面的代码中创建了一个FBReaderApp对象， 至于这个对象是干什么的，现在还不知道。<br>接下来，getCollection 并 调用了 bindToService方法</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">FBReader::getCollection()</span><br></pre></td></tr></table></figure>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">private BookCollectionShadow getCollection() &#123;</span><br><span class="line">        return (BookCollectionShadow) myFBReaderApp.Collection;</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>
<p>调用的正是这个主activity的一个方法。返回的对象是FBReaderApp 的 Collection变量，这个正式刚才创建的BookCollectionShadow 实现了IBookCollection接口。</p>
<p>接着调用了BookCollectionShadow的bindToService方法</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">BookCollectionShadow::bindToService(Context context, Runnable onBindAction)</span><br></pre></td></tr></table></figure>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line">public synchronized void bindToService(Context context, Runnable onBindAction) &#123;</span><br><span class="line">       if (myInterface != null &amp;&amp; myContext == context) &#123;</span><br><span class="line">		// not first connect</span><br><span class="line">		if (onBindAction != null) &#123;</span><br><span class="line">			Config.Instance().runOnConnect(onBindAction);</span><br><span class="line">		&#125;</span><br><span class="line">	&#125; else &#123;</span><br><span class="line">		// first connect</span><br><span class="line">		if (onBindAction != null) &#123;</span><br><span class="line">			myOnBindActions.add(onBindAction);</span><br><span class="line">		&#125;</span><br><span class="line">		context.bindService(</span><br><span class="line">			FBReaderIntents.internalIntent(FBReaderIntents.Action.LIBRARY_SERVICE),</span><br><span class="line">			this,</span><br><span class="line">			LibraryService.BIND_AUTO_CREATE</span><br><span class="line">		);</span><br><span class="line">		myContext = context;</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>这里执行了一句很熟悉的<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line">bindService方法有三个参数，第二个参数传了BookCollectionShadow本身， 我们知道，bindService的第二个参数传的是ServiceConnection接口，在这里面， 我们可以调用aidl文件生命的方法，进行跨进程的通讯。也不知道fbreader为什么弄这么多进程是想干什么。</span><br><span class="line"></span><br><span class="line">![](http://upload-images.jianshu.io/upload_images/1285832-c99fa50150a7cae8.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240)</span><br><span class="line"></span><br><span class="line">果然BookCollectionShadow实现了ServiceConnection，并且myInterface真是那个aidl的全局变量， 我们可以通过它，完成与服务端的沟通。</span><br><span class="line"></span><br><span class="line">----</span><br><span class="line"></span><br><span class="line">## 四、怎样获得book对象</span><br><span class="line"></span><br><span class="line">经过一下午的瞎看，大致的熟悉了一下fbreader的源码。</span><br><span class="line"></span><br><span class="line">带着问题学习总是最快的，那么，fbreader到底是怎样解析epub文件的呢。我们得找一个入口。在项目中，长按菜单键，会弹出一个功能列表，会看到一个本地书柜，一顿操作之后，我们可以找到一个我事先导入的一个电子书</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">![](http://upload-images.jianshu.io/upload_images/1285832-536bb4e37ccc3d4d.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240)</span><br><span class="line"></span><br><span class="line">最后我们会来到这个界面</span><br><span class="line"></span><br><span class="line">![](http://upload-images.jianshu.io/upload_images/1285832-fce1a35e1d34fcca.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240)</span><br><span class="line"></span><br><span class="line">在茫茫码海中怎么找到这个activity，用这样一条命令</span><br></pre></td></tr></table></figure></p>
<p>adb shell dumpsys activity top | grep ACTIVITY –color<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">![](http://upload-images.jianshu.io/upload_images/1285832-61bf63d9a9c654d6.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240)</span><br><span class="line"></span><br><span class="line">在这个activitiy中， mybook是通过intent传入的，所以找上个页面```LibraryActivity</span><br></pre></td></tr></table></figure></p>
<p><img src="http://upload-images.jianshu.io/upload_images/1285832-748d5e53cba5441a.png" alt=""></p>
<p>ListActivity是什么？ 没用过，TreeActivity自己写的， 太复杂。想着在LibraryActivity中能找到一些方法<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">LibraryActivity::onListItemClick(ListView listView, View view, int position, long rowId)</span><br></pre></td></tr></table></figure></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">@Override</span><br><span class="line">protected void onListItemClick(ListView listView, View view, int position, long rowId) &#123;</span><br><span class="line">    final LibraryTree tree = (LibraryTree)getListAdapter().getItem(position);</span><br><span class="line">    final Book book = tree.getBook();</span><br><span class="line">    LogUtils.d(&quot;LibraryActivity -&gt; onListItemClick book: &quot; + book);</span><br><span class="line">    if (book != null) &#123;</span><br><span class="line">        showBookInfo(book);</span><br><span class="line">    &#125; else &#123;</span><br><span class="line">        openTree(tree);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>在这个方法中， 是通过<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">```</span><br><span class="line">public Book getBook() &#123;</span><br><span class="line">	return null;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>这尼玛返回空！！！<br> tree是LibraryTree的一个实例，在TreeAdapter的getItem(int position) 方法中得到的<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">public FBTree getItem(int position) &#123;</span><br><span class="line">	return myItems.get(position);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>存放在了叫<figure class="highlight plain"><figcaption><span>final List<fbtree> myItems;```这样的一个list之中。</fbtree></span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">一路尾随，不是跟踪myItems， 看一下TreeAdapter的replaceAll方法</span><br><span class="line"></span><br><span class="line">![](http://upload-images.jianshu.io/upload_images/1285832-34f72c5912915c2c.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240)</span><br><span class="line"></span><br><span class="line">根据名字我们能判断。得到现在树的子树，然后添加到myItem中去的。那么我们知道现在的树， 或者现在树的子树是什么，应该就可以得到答案了。</span><br><span class="line"></span><br><span class="line">现在的树集成关系是这样的</span><br><span class="line">![](http://upload-images.jianshu.io/upload_images/1285832-5bb780b3dd24cca2.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240)</span><br><span class="line"></span><br><span class="line">又在onListItemClick方法中强装成LibraryTree， 我们只需关注LibraryTree的之类就行了</span><br><span class="line"></span><br><span class="line">这个树通过getTreeByKey得到</span><br></pre></td></tr></table></figure></p>
<p>LibraryActivity::getTreeByKey(FBTree.Key key)<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">```</span><br><span class="line">@Override</span><br><span class="line">protected LibraryTree getTreeByKey(FBTree.Key key) &#123;</span><br><span class="line">    return key != null ? myRootTree.getLibraryTree(key) : myRootTree;</span><br><span class="line">&#125;</span><br><span class="line">private synchronized void deleteRootTree() &#123;</span><br></pre></td></tr></table></figure></p>
<p>最后我们要找的这棵树实际跟<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">myRootTree在onCreate的时候创建</span><br></pre></td></tr></table></figure></p>
<p>LibraryActivity::onCreate(Bundle icicle)<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"></span><br></pre></td></tr></table></figure></p>
<p>@Override<br>protected void onCreate(Bundle icicle) {<br>    super.onCreate(icicle);<br>    Log.d(TAG, “start onCreate function: “);<br>    mySelectedBook = FBReaderIntents.getBookExtra(getIntent());<br>    new LibraryTreeAdapter(this);<br>    getListView().setTextFilterEnabled(true);<br>    getListView().setOnCreateContextMenuListener(this);<br>    deleteRootTree();<br>    myCollection.bindToService(this, new Runnable() {<br>        public void run() {<br>            setProgressBarIndeterminateVisibility(!myCollection.status().IsCompleted);<br>            myRootTree = new RootTree(myCollection);<br>            myCollection.addListener(LibraryActivity.this);<br>            init(getIntent());<br>        }<br>    });<br>}<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">在倒数第二行add的接口的回掉在这里</span><br><span class="line"></span><br><span class="line">![](http://upload-images.jianshu.io/upload_images/1285832-60b8eb000aceeeb5.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240)</span><br><span class="line">在```onBookEvent中一定是这个树的来源```，看来我们要去另一个进程里看看了</span><br><span class="line"></span><br><span class="line">这个服务和之前的一样LibraryService。我们跟进LibraryService</span><br></pre></td></tr></table></figure></p>
<p>@Override<br>public IBinder onBind(Intent intent) {<br>    return myLibrary;<br>}<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">返回的真是aidl的一个接口</span><br><span class="line"></span><br><span class="line">![](http://upload-images.jianshu.io/upload_images/1285832-89620d920299568d.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240)</span><br><span class="line"></span><br><span class="line">以上是接口创建的一部分代码</span><br><span class="line"></span><br><span class="line">![](http://upload-images.jianshu.io/upload_images/1285832-1c0cd3f0f572740c.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240)</span><br><span class="line"></span><br><span class="line">在reset中搞了一个Config.Instance().runOnConnect不知道是干嘛用的，反正是调用了以下的方法</span><br><span class="line"></span><br><span class="line">![](http://upload-images.jianshu.io/upload_images/1285832-a28e8fafc6062a50.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240)</span><br><span class="line"></span><br><span class="line">我注意到底下的两个广播，很明显是做进程间通讯。然后， 我在BookCollectionShadow中找到了这个广播的接收者</span><br></pre></td></tr></table></figure></p>
<p>private final BroadcastReceiver myReceiver = new BroadcastReceiver() {<br>    public void onReceive(Context context, Intent intent) {<br>        if (!hasListeners()) {<br>            return;<br>        }<br>        try {<br>            final String type = intent.getStringExtra(“type”);<br>            LogUtils.d(“BookCollectionShadow -&gt; onReceive type: “ + type);<br>            if (LibraryService.BOOK_EVENT_ACTION.equals(intent.getAction())) {<br>                final Book book = SerializerUtil.deserializeBook(intent.getStringExtra(“book”));<br>                fireBookEvent(BookEvent.valueOf(type), book);<br>            } else {<br>                fireBuildEvent(Status.valueOf(type));<br>            }<br>        } catch (Exception e) {<br>            // ignore<br>        }<br>    }<br>};<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">接下来看log</span><br><span class="line"></span><br><span class="line">![](http://upload-images.jianshu.io/upload_images/1285832-06ada923f3db31b6.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240)</span><br><span class="line">通过这个&lt;entry xmlns:dc=&quot;http://purl.org/dc/elements/1.1/&quot; xmlns:calibre=&quot;http://calibre.kovidgoyal.net/2009/metadata&quot;&gt; 搞成一本书？？？</span><br><span class="line"></span><br><span class="line">这个先别管，我的疑惑是tree.getBook() 怎么返回空？</span><br><span class="line"></span><br><span class="line">经过上面的弯路， 我们知道了最后回掉的是```LibraryActivity:: onBookEvent(BookEvent event, Book book)```这个方法</span><br></pre></td></tr></table></figure></p>
<p>@Override<br>public void onBookEvent(BookEvent event, Book book) {<br>    if (getCurrentTree().onBookEvent(event, book)) {<br>        getListAdapter().replaceAll(getCurrentTree().subtrees(), true);<br>    }<br>}<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">再跟一下里面的方法</span><br></pre></td></tr></table></figure></p>
<p>public boolean onBookEvent(BookEvent event, Book book) {<br>    switch (event) {<br>        default:<br>        case Added:<br>            return false;<br>        case Removed:<br>            return removeBook(book);<br>        case Updated:<br>        {<br>            boolean changed = false;<br>            for (FBTree tree : this) {<br>                if (tree instanceof BookTree) {<br>                    final Book b = ((BookTree)tree).Book;<br>                    if (b.equals(book)) {<br>                        b.updateFrom(book);<br>                        changed = true;<br>                    }<br>                }<br>            }<br>            return changed;<br>        }<br>    }<br>}<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line">我们看到了booktree这个东西，原来我们正经使用的是booktree的getBook，所以get得到的肯定是一本书</span><br><span class="line"></span><br><span class="line">### 这里留一个问题， 这个booktree是怎么来的？ 先不着急分析他</span><br><span class="line"></span><br><span class="line">---</span><br><span class="line"></span><br><span class="line">我们发现book 是从booktree 得到的， 而booktree中的book 是构造是传进来的。</span><br><span class="line"></span><br><span class="line">而这些又是在FilteredTree的抽象发方法createSubtree， 得到的</span><br><span class="line"></span><br><span class="line">![](http://upload-images.jianshu.io/upload_images/1285832-8ba92e761ff95a45.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240)</span><br><span class="line"></span><br><span class="line">接着往上看FilteredTree这个类</span><br><span class="line">![](http://upload-images.jianshu.io/upload_images/1285832-494b2e8a2f176862.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240)</span><br><span class="line"></span><br><span class="line">终于找到主进程里的book了， 原来是调用进程里的 Collection.books(query);方法， 来获得一个book的列表。</span><br><span class="line"></span><br><span class="line">## 五、怎么跳转到Fbreader这个activity</span><br><span class="line"></span><br><span class="line">本来想看看怎么解析epub的，但是感觉目前还消化不了。</span><br><span class="line"></span><br><span class="line">我们要把这个完整的项目当成一个sdk来使用，虽然说整个加到工程中fbreader的5M左右了，但是没有办法，时间紧任务重。我倒是很赞同自己去写个阅读器，但是条件不允许。</span><br><span class="line"></span><br><span class="line">我们要使用这个项目， 就得找到一个书， 然后跳转到这个activity让他显示。</span><br><span class="line"></span><br><span class="line">经过以上的分析， 可以看到，在查找书的时候 已经就装成book对象了。反正要是我写，我肯定在查找文件的时候返回的url， 然后根据这个去解析成book的对象。</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">记得最早之前分析过，在FBReader的onResume是启动的关键</span><br></pre></td></tr></table></figure></p>
<p>private synchronized void openBook(Intent intent, final Runnable action, boolean force) {<br>        if (!force &amp;&amp; myBook != null) {<br>            return;<br>        }</p>
<pre><code>myBook = FBReaderIntents.getBookExtra(intent);
final Bookmark bookmark = FBReaderIntents.getBookmarkExtra(intent);
LogUtils.d(&quot;FBReader -&gt; openBook myBook: &quot; + myBook);
if (myBook == null) {
    final Uri data = intent.getData();
    LogUtils.d(&quot;FBReader -&gt; openBook data: &quot; + data);
    if (data != null) {
        myBook = createBookForFile(ZLFile.createFileByPath(data.getPath()));
    }
}
if (myBook != null) {
    ZLFile file = myBook.File;
    LogUtils.d(&quot;FBReader -&gt; openBook file path: &quot; + file.getPath());
    LogUtils.d(&quot;FBReader -&gt; openBook file exists: &quot; + file.exists());
    if (!file.exists()) {
        if (file.getPhysicalFile() != null) {
            file = file.getPhysicalFile();
        }
        UIUtil.showErrorMessage(this, &quot;fileNotFound&quot;, file.getPath());
        myBook = null;
    }
}
</code></pre><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">这里，但书为空的时时候，在intent.getData去 拿到url， 传到ZLFile里去。也就是说，我在start这个activity 传一个url 进去， 于是我这样写了一段</span><br></pre></td></tr></table></figure>
<p>/**</p>
<ul>
<li>打开一本电子书<br>*</li>
<li>@param context 上下文</li>
<li>@param path    epub 资源的绝对路径<br>*/<br>public static void openBookActivity(Context context, String path) {<br> final Intent intent = new Intent(context, FBReader.class)<pre><code>.setAction(FBReaderIntents.Action.VIEW)
.addFlags(Intent.FLAG_ACTIVITY_CLEAR_TOP);
</code></pre> intent.setData(Uri.parse(path));<br> context.startActivity(intent);<br>}<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">这样就可以了。 我翻了几页之后， 默认就会保存阅读的位置。那么我想重新阅读这个文章应该怎么办。继续撸代码</span><br><span class="line"></span><br><span class="line">在```FBReaderApp::openBookInternal(Book book, Bookmark bookmark, boolean force)```方法中，第一次打开书是会执行```gotoStoredPosition();```这样一个方法，从字面的意思是去到存储的位置</span><br><span class="line"></span><br><span class="line">具体的方法是这样的</span><br></pre></td></tr></table></figure>
</li>
</ul>
<p>FBReaderApp::gotoStoredPosition()<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">```</span><br><span class="line">private void gotoStoredPosition() &#123;</span><br><span class="line">    myStoredPositionBook = Model != null ? Model.Book : null;</span><br><span class="line">    if (myStoredPositionBook == null) &#123;</span><br><span class="line">        return;</span><br><span class="line">    &#125;</span><br><span class="line">    myStoredPosition = getStoredPosition(myStoredPositionBook);</span><br><span class="line">    BookTextView.gotoPosition(myStoredPosition);</span><br><span class="line">    savePosition();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>是调用了BookTextView的gotoPosition这个方法。那我们看看能否在FBReader这个类上搞点事情。在openBook方法中<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br></pre></td><td class="code"><pre><span class="line">private synchronized void openBook(Intent intent, final Runnable action, boolean force) &#123;</span><br><span class="line">       if (!force &amp;&amp; myBook != null) &#123;</span><br><span class="line">           return;</span><br><span class="line">       &#125;</span><br><span class="line"></span><br><span class="line">       myBook = FBReaderIntents.getBookExtra(intent);</span><br><span class="line">       final Bookmark bookmark = FBReaderIntents.getBookmarkExtra(intent);</span><br><span class="line">       LogUtils.d(&quot;FBReader -&gt; openBook myBook: &quot; + myBook);</span><br><span class="line">       if (myBook == null) &#123;</span><br><span class="line">           final Uri data = intent.getData();</span><br><span class="line">           LogUtils.d(&quot;FBReader -&gt; openBook data: &quot; + data);</span><br><span class="line">           if (data != null) &#123;</span><br><span class="line">               myBook = createBookForFile(ZLFile.createFileByPath(data.getPath()));</span><br><span class="line">           &#125;</span><br><span class="line">       &#125;</span><br><span class="line"></span><br><span class="line">       LogUtils.d(&quot;FBReader -&gt; openBook mybook: &quot; + myBook);</span><br><span class="line">       if (myBook != null) &#123;</span><br><span class="line">           ZLFile file = myBook.File;</span><br><span class="line">           LogUtils.d(&quot;FBReader -&gt; openBook file path: &quot; + file.getPath());</span><br><span class="line">           LogUtils.d(&quot;FBReader -&gt; openBook file exists: &quot; + file.exists());</span><br><span class="line">           if (!file.exists()) &#123;</span><br><span class="line">               if (file.getPhysicalFile() != null) &#123;</span><br><span class="line">                   file = file.getPhysicalFile();</span><br><span class="line">               &#125;</span><br><span class="line">               UIUtil.showErrorMessage(this, &quot;fileNotFound&quot;, file.getPath());</span><br><span class="line">               myBook = null;</span><br><span class="line">           &#125;</span><br><span class="line">       &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">       // 打开app 时 正常myBook为空 intent.getData 为空</span><br><span class="line">       /*</span><br><span class="line">       * 在主线程运行</span><br><span class="line">	*</span><br><span class="line">	* 正常打开时myBook， bookmark， action 三个参数都是空</span><br><span class="line">	* */</span><br><span class="line">       Config.Instance().runOnConnect(new Runnable() &#123;</span><br><span class="line">           public void run() &#123;</span><br><span class="line">               LogUtils.d(&quot;FBReader -&gt; openBook run thread: &quot; + Thread.currentThread());</span><br><span class="line">               LogUtils.d(&quot;FBReader -&gt; openBook run myBook: &quot; + myBook);</span><br><span class="line">               LogUtils.d(&quot;FBReader -&gt; openBook run bookmark: &quot; + bookmark);</span><br><span class="line">               LogUtils.d(&quot;FBReader -&gt; openBook run action: &quot; + action);</span><br><span class="line">               myFBReaderApp.openBook(myBook, bookmark, action);</span><br><span class="line">               // // TODO: 6/7/2017 回到首页</span><br><span class="line">               myFBReaderApp.BookTextView.gotoHome();</span><br><span class="line">           &#125;</span><br><span class="line">       &#125;);</span><br><span class="line">   &#125;</span><br></pre></td></tr></table></figure></p>
<p>在最后一句，这个activity中可以拿到myFBReaderApp，猜想是用来控制整个阅读器的类， 调用gotohome， 竟然可以了。通过这个就可以控制是否继续阅读还是从头开始</p>
<h2 id="六、跳转到固定章节"><a href="#六、跳转到固定章节" class="headerlink" title="六、跳转到固定章节"></a>六、跳转到固定章节</h2><p>一本书有很多章节，跳转到固定章节的时候不可能进行一步步的翻页操作。碰巧fbreader提供这样的功能，而且还有快速翻看</p>
<p>找打开一本书之后Model 字段就会赋值， ‘弹幕’一下这个字段， 看到里面确实存在了章节的信息</p>
<p><img src="http://upload-images.jianshu.io/upload_images/1285832-9d1fe7bbd2f273e4.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240" alt="Paste_Image.png"></p>
<p>我知道了章节，然后怎么去跳转，我们看下面这一段代码：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">TOCActivity::openBookText(TOCTree tree)</span><br></pre></td></tr></table></figure></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">void openBookText(TOCTree tree) &#123;</span><br><span class="line">	final TOCTree.Reference reference = tree.getReference();</span><br><span class="line">	if (reference != null) &#123;</span><br><span class="line">		finish();</span><br><span class="line">		final FBReaderApp fbreader = (FBReaderApp)ZLApplication.Instance();</span><br><span class="line">		fbreader.addInvisibleBookmark();</span><br><span class="line">		fbreader.BookTextView.gotoPosition(reference.ParagraphIndex, 0, 0);</span><br><span class="line">		fbreader.showBookTextView();</span><br><span class="line">		fbreader.storePosition();</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>得到reference对象的ParagraphIndex， 然后去调用BookTextView的gotoPosition</p>
<p>在FBReaderApp中这样写试试</p>
<p><img src="http://upload-images.jianshu.io/upload_images/1285832-8f2047c238f09216.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240" alt=""></p>
<p>这样是可以达到预期效果的，但是有一定要值得注意：<br>在第一次读取书时，获取书的操作是个异步的， 也就是说，这个时候Model可能为空，所以在以后开发中，最好是用接口，将获取书的情况反到activity中， 这样，当书加载完成时再去做相应的跳转操作。</p>
<h2 id="七、字体加大与缩小"><a href="#七、字体加大与缩小" class="headerlink" title="七、字体加大与缩小"></a>七、字体加大与缩小</h2><p>源码中，改变字体大小的就在菜单的按键中</p>
<p><img src="http://upload-images.jianshu.io/upload_images/1285832-da2718c32da2c4c5.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240" alt=""></p>
<p>点击按键监听再这里，这么搞也是特殊，从未见过啊，不知道干嘛弄的这么复杂。像这样可以实现这个功能了。</p>
<p>这样只是增加与减少，万一需求上是给定几个固定的字号，然后调节怎么办？所以开始得看看源码</p>
<p><img src="http://upload-images.jianshu.io/upload_images/1285832-293224e691cf1053.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240" alt=""></p>
<p>跟进去发现，最终的action是存在于这个map， 实在主activity创建时put的，所以所有的操作都会交给ZLAction的子类去处理</p>
<p><img src="http://upload-images.jianshu.io/upload_images/1285832-6db0ded4df8dd286.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240" alt=""><br>也就是上面选中的这个类</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line">class ChangeFontSizeAction extends FBAction &#123;</span><br><span class="line">	private final int myDelta;</span><br><span class="line"></span><br><span class="line">	ChangeFontSizeAction(FBReaderApp fbreader, int delta) &#123;</span><br><span class="line">		super(fbreader);</span><br><span class="line">		myDelta = delta;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	@Override</span><br><span class="line">	protected void run(Object ... params) &#123;</span><br><span class="line">        final ZLIntegerRangeOption option =</span><br><span class="line">			Reader.ViewOptions.getTextStyleCollection().getBaseStyle().FontSizeOption;</span><br><span class="line">		option.setValue(option.getValue() + myDelta);</span><br><span class="line"></span><br><span class="line">        LogUtils.d(&quot;ChangeFontSizeAction -&gt; run: &quot; + option.getValue());</span><br><span class="line">        Reader.clearTextCaches();</span><br><span class="line">		Reader.getViewWidget().repaint();</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>执行run方法后会设置字号，这里的option.setValue(option.getValue() + myDelta);就是对字号的设置。要是愿意的话可以复写FBAction或者直接使用run方法中的参数进行传值，当然，后一种要好一点。</p>
<h2 id="八、音量键功能"><a href="#八、音量键功能" class="headerlink" title="八、音量键功能"></a>八、音量键功能</h2><p>一个功能完整的阅读器，音量键也都会派上用场。fbreader音量键也不例外</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line">ZLAndroidWidget::@Override</span><br><span class="line">	public boolean onKeyDown(int keyCode, KeyEvent event) &#123;</span><br><span class="line">		final ZLApplication application = ZLApplication.Instance();</span><br><span class="line">		final ZLKeyBindings bindings = application.keyBindings();</span><br><span class="line"></span><br><span class="line">		if (bindings.hasBinding(keyCode, true)</span><br><span class="line">				|| bindings.hasBinding(keyCode, false)) &#123;</span><br><span class="line">			if (myKeyUnderTracking != -1) &#123;</span><br><span class="line">				if (myKeyUnderTracking == keyCode) &#123;</span><br><span class="line">					return true;</span><br><span class="line">				&#125; else &#123;</span><br><span class="line">					myKeyUnderTracking = -1;</span><br><span class="line">				&#125;</span><br><span class="line">			&#125;</span><br><span class="line">			if (bindings.hasBinding(keyCode, true)) &#123;</span><br><span class="line">				myKeyUnderTracking = keyCode;</span><br><span class="line">				myTrackingStartTime = System.currentTimeMillis();</span><br><span class="line">				return true;</span><br><span class="line">			&#125; else &#123;</span><br><span class="line">				return application.runActionByKey(keyCode, false);</span><br><span class="line">			&#125;</span><br><span class="line">		&#125; else &#123;</span><br><span class="line">			return false;</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br></pre></td></tr></table></figure>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">public final boolean runActionByKey(int key, boolean longPress) &#123;</span><br><span class="line">    final String actionId = keyBindings().getBinding(key, longPress);</span><br><span class="line">    if (actionId != null) &#123;</span><br><span class="line">        final ZLAction action = myIdToActionMap.get(actionId);</span><br><span class="line">        return action != null &amp;&amp; action.checkAndRun();</span><br><span class="line">    &#125;</span><br><span class="line">    return false;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>程序在runActionByKey方法中控制这按键</p>
<p>key 是当前案件的键码，会对所有按键处理，如果你接键盘的话。<br>longPress 字面意思是是否长按，但是我试过永远的短按，永远的false</p>
<p>以后处理案件就可在这里处理，或者深入到action里面进行处理。</p>
<h2 id="九、更换背景，字体颜色"><a href="#九、更换背景，字体颜色" class="headerlink" title="九、更换背景，字体颜色"></a>九、更换背景，字体颜色</h2><p>更换背景以及字体颜色，也是实现夜间模式的一个套路。首先我们定位到PreferenceActivity，冷不丁一看，我去，这不是系统里的settings嘛。这么长的init至于么？<br><img src="http://upload-images.jianshu.io/upload_images/1285832-aad6afda339e53dd.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240" alt=""></p>
<p>这么长的代码就不全粘贴了，大概在400多行，有这么一段。是添加背景和墙纸的<br>我们跟到这个类中BackgroundPreference</p>
<p>在onBindView下面是跳转到颜色选择器的代码，在PreferenceActivity中的onActivityResult方法中返回</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">@Override</span><br><span class="line">protected void onActivityResult(int requestCode, int resultCode, Intent data) &#123;</span><br><span class="line">    if (myNetworkContext.onActivityResult(requestCode, resultCode, data)) &#123;</span><br><span class="line">        return;</span><br><span class="line">    &#125;</span><br><span class="line">    if (resultCode != RESULT_OK) &#123;</span><br><span class="line">        return;</span><br><span class="line">    &#125;</span><br><span class="line">    if (BACKGROUND_REQUEST_CODE == requestCode) &#123;</span><br><span class="line">        if (myBackgroundPreference != null) &#123;</span><br><span class="line">            myBackgroundPreference.update(data);</span><br><span class="line">        &#125;</span><br><span class="line">        return;</span><br><span class="line">    &#125;</span><br><span class="line">    myChooserCollection.update(requestCode, data);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>中间部分， 调用了yBackgroundPreference.update(data);</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">public void update(Intent data) &#123;</span><br><span class="line">	final String value = data.getStringExtra(VALUE_KEY);</span><br><span class="line">    LogUtils.d(&quot;BackgroundPreference -&gt; update: &quot; + value);</span><br><span class="line">    if (value != null) &#123;</span><br><span class="line">		myProfile.WallpaperOption.setValue(value);</span><br><span class="line">	&#125;</span><br><span class="line">	final int color = data.getIntExtra(COLOR_KEY, -1);</span><br><span class="line">    LogUtils.d(&quot;BackgroundPreference -&gt; update: &quot; + color);</span><br><span class="line">    if (color != -1) &#123;</span><br><span class="line">		myProfile.BackgroundOption.setValue(new ZLColor(color));</span><br><span class="line">	&#125;</span><br><span class="line">	notifyChanged();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>继续往里跟，方向设置颜色或者是壁纸图片， 只是设置了WallpaperOption的value。我们能在ColorProfile类中找到这些参数，那么我们怎么在主activity获取并且改变它呢</p>
<p>还是最重要的<figure class="highlight plain"><figcaption><span>的实例 ViewOptions，通过它我们就能拿到ColorProfile， 图下设置背景为红色</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">```</span><br><span class="line"> myFBReaderApp.ViewOptions.getColorProfile().BackgroundOption.setValue(new ZLColor(255, 0, 0));</span><br></pre></td></tr></table></figure></p>
<p>但是直接这么写，没有变化，仔细想想。我只设置了颜色，但是没有通知重绘，自然就没有变化。</p>
<p>那么，颜色选择怎么通知到这个activity的呢，只能是Intent传的，我们看下FBReader 的onActivityResult(int requestCode, int resultCode, Intent data)<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line">@Override</span><br><span class="line">protected void onActivityResult(int requestCode, int resultCode, Intent data) &#123;</span><br><span class="line">    switch (requestCode) &#123;</span><br><span class="line">        case REQUEST_PREFERENCES:</span><br><span class="line">            if (resultCode != RESULT_DO_NOTHING &amp;&amp; data != null) &#123;</span><br><span class="line">                final Book book = FBReaderIntents.getBookExtra(data);</span><br><span class="line">                if (book != null) &#123;</span><br><span class="line">                    getCollection().bindToService(this, new Runnable() &#123;</span><br><span class="line">                        public void run() &#123;</span><br><span class="line">                            onPreferencesUpdate(book);</span><br><span class="line">                        &#125;</span><br><span class="line">                    &#125;);</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">            break;</span><br><span class="line">        case REQUEST_CANCEL_MENU:</span><br><span class="line">            runCancelAction(data);</span><br><span class="line">            break;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>ok, 确实有我需要的东西，这个方法调用了onPreferencesUpdate<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">private void onPreferencesUpdate(Book book) &#123;</span><br><span class="line">     AndroidFontUtil.clearFontCache();</span><br><span class="line">     myFBReaderApp.onBookUpdated(book);</span><br><span class="line"> &#125;</span><br></pre></td></tr></table></figure></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">\    public void onBookUpdated(Book book) &#123;</span><br><span class="line">        if (Model == null || Model.Book == null || !Model.Book.equals(book)) &#123;</span><br><span class="line">            return;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        final String newEncoding = book.getEncodingNoDetection();</span><br><span class="line">        final String oldEncoding = Model.Book.getEncodingNoDetection();</span><br><span class="line"></span><br><span class="line">        Model.Book.updateFrom(book);</span><br><span class="line"></span><br><span class="line">        if (newEncoding != null &amp;&amp; !newEncoding.equals(oldEncoding)) &#123;</span><br><span class="line">            reloadBook();</span><br><span class="line">        &#125; else &#123;</span><br><span class="line">            ZLTextHyphenator.Instance().load(Model.Book.getLanguage());</span><br><span class="line">            clearTextCaches();</span><br><span class="line">            getViewWidget().repaint();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>
<p>起到决定性作用的就行最后一句 getViewWidget().repaint();</p>
<p>那么，更改背景颜色就是<br>（上面的代码都是等书加载完毕之后，显示在view中在去设置的， 不然书都没加载完，自然也就设置不了）</p>
<p><img src="http://upload-images.jianshu.io/upload_images/1285832-84ea417bf7ba3a04.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240" alt=""><br>BackgroundOption 是背景色<br>RegularTextOption 是文字的颜色</p>
<h2 id="十、动画类型"><a href="#十、动画类型" class="headerlink" title="十、动画类型"></a>十、动画类型</h2><p>下面开始研究应用的翻页动画。<br>我们修改颜色实际上是修改了ZLAndroidWidget。我们可以跟进这个类看一下代码</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">ZLAndroidWidget::getAnimationProvider()</span><br></pre></td></tr></table></figure>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><span class="line">private AnimationProvider getAnimationProvider() &#123;</span><br><span class="line">		final ZLView.Animation type = ZLApplication.Instance().getCurrentView()</span><br><span class="line">				.getAnimationType();</span><br><span class="line">		if (myAnimationProvider == null || myAnimationType != type) &#123;</span><br><span class="line">			myAnimationType = type;</span><br><span class="line">			switch (type) &#123;</span><br><span class="line">			case none:</span><br><span class="line">				myAnimationProvider = new NoneAnimationProvider(myBitmapManager);</span><br><span class="line">				break;</span><br><span class="line">			case curl:</span><br><span class="line">				myAnimationProvider = new CurlAnimationProvider(myBitmapManager);</span><br><span class="line">				break;</span><br><span class="line">			case slide:</span><br><span class="line">				myAnimationProvider = new SlideAnimationProvider(</span><br><span class="line">						myBitmapManager);</span><br><span class="line">				break;</span><br><span class="line">			case shift:</span><br><span class="line">				myAnimationProvider = new ShiftAnimationProvider(</span><br><span class="line">						myBitmapManager);</span><br><span class="line">				break;</span><br><span class="line">			case left2right:</span><br><span class="line">				myAnimationProvider = new Left2RightAnimationProvider(</span><br><span class="line">						myBitmapManager);</span><br><span class="line">				break;</span><br><span class="line">			case simulation:</span><br><span class="line">				// myAnimationProvider = new SimulateAnimationProvider(</span><br><span class="line">				// myBitmapManager);</span><br><span class="line">				myAnimationProvider = new EmulateAnimationProvider(</span><br><span class="line">						myBitmapManager);</span><br><span class="line">				break;</span><br><span class="line">			&#125;</span><br><span class="line">		&#125;</span><br><span class="line">		return myAnimationProvider;</span><br><span class="line">	&#125;</span><br></pre></td></tr></table></figure>
<p>代码跟你的不一样，正常，这个我改过了。<br>在绘制动画的时候，也就是onDrawInScrolling(Canvas canvas)这个方法被调用的时候，都会获取一下当前的动画。</p>
<p>那么在设置动画的时候调用的是PreferenceActivity这个activity，再init一堆东西里看以看到，这样一句话</p>
<p><img src="http://upload-images.jianshu.io/upload_images/1285832-c4dbe0cfdaebc3d6.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240" alt=""></p>
<p>原来是改变的是pageTurningOptions这个东西，我们再看主activity中能不能找到这个对象。回到FBReader当中。我们可以这样设置动画<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">myFBReaderApp.PageTurningOptions.Animation.setValue(ZLView.Animation.left2right);</span><br></pre></td></tr></table></figure></p>
<p>因为是执行每一次翻页的动作都会get一下当前的动画，所以也就不需要重绘当前页面，写这样一句就好。</p>
<h2 id="十一、点击区域"><a href="#十一、点击区域" class="headerlink" title="十一、点击区域"></a>十一、点击区域</h2><p>市场上的阅读类应用。基本都是点击左面上一页，右面下一页。中间会弹出一个设置菜单。<br>我发现我的这个version的代码，点击中间是没有任何反应的，所以。继续撸码。</p>
<p>关于点击时间， 首先去看ZLAndroidWidget的onTouchEvent方法<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">ZLAndroidWidget::onTouchEvent(MotionEvent event)</span><br></pre></td></tr></table></figure></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br></pre></td><td class="code"><pre><span class="line">@Override</span><br><span class="line">public boolean onTouchEvent(MotionEvent event) &#123;</span><br><span class="line">	int x = (int) event.getX();</span><br><span class="line">	int y = (int) event.getY();</span><br><span class="line">	final ZLView view = ZLApplication.Instance().getCurrentView();</span><br><span class="line">	switch (event.getAction()) &#123;</span><br><span class="line">	case MotionEvent.ACTION_UP:</span><br><span class="line">		if (myPendingDoubleTap) &#123;</span><br><span class="line">            view.onFingerDoubleTap(x, y);</span><br><span class="line">		&#125; else if (myLongClickPerformed) &#123;</span><br><span class="line">            view.onFingerReleaseAfterLongPress(x, y);</span><br><span class="line">		&#125; else &#123;</span><br><span class="line">			if (myPendingLongClickRunnable != null) &#123;</span><br><span class="line">				removeCallbacks(myPendingLongClickRunnable);</span><br><span class="line">				myPendingLongClickRunnable = null;</span><br><span class="line">			&#125;</span><br><span class="line">			if (myPendingPress) &#123;</span><br><span class="line">				if (view.isDoubleTapSupported()) &#123;</span><br><span class="line">					if (myPendingShortClickRunnable == null) &#123;</span><br><span class="line">						myPendingShortClickRunnable = new ShortClickRunnable();</span><br><span class="line">					&#125;</span><br><span class="line">					postDelayed(myPendingShortClickRunnable,</span><br><span class="line">							ViewConfiguration.getDoubleTapTimeout());</span><br><span class="line">				&#125; else &#123;</span><br><span class="line">                    view.onFingerSingleTap(x, y);</span><br><span class="line">				&#125;</span><br><span class="line">			&#125; else &#123;</span><br><span class="line">				view.onFingerRelease(x, y);</span><br><span class="line">			&#125;</span><br><span class="line">		&#125;</span><br><span class="line">		myPendingDoubleTap = false;</span><br><span class="line">		myPendingPress = false;</span><br><span class="line">		myScreenIsTouched = false;</span><br><span class="line">		break;</span><br><span class="line">	case MotionEvent.ACTION_DOWN:</span><br><span class="line">		if (myPendingShortClickRunnable != null) &#123;</span><br><span class="line">			removeCallbacks(myPendingShortClickRunnable);</span><br><span class="line">			myPendingShortClickRunnable = null;</span><br><span class="line">			myPendingDoubleTap = true;</span><br><span class="line">		&#125; else &#123;</span><br><span class="line">			postLongClickRunnable();</span><br><span class="line">			myPendingPress = true;</span><br><span class="line">		&#125;</span><br><span class="line">		myScreenIsTouched = true;</span><br><span class="line">		myPressedX = x;</span><br><span class="line">		myPressedY = y;</span><br><span class="line">		break;</span><br><span class="line">	case MotionEvent.ACTION_MOVE: &#123;</span><br><span class="line">		final int slop = ViewConfiguration.get(getContext())</span><br><span class="line">				.getScaledTouchSlop();</span><br><span class="line">		final boolean isAMove = Math.abs(myPressedX - x) &gt; slop</span><br><span class="line">				|| Math.abs(myPressedY - y) &gt; slop;</span><br><span class="line">		if (isAMove) &#123;</span><br><span class="line">			myPendingDoubleTap = false;</span><br><span class="line">		&#125;</span><br><span class="line">		if (myLongClickPerformed) &#123;</span><br><span class="line">			view.onFingerMoveAfterLongPress(x, y);</span><br><span class="line">		&#125; else &#123;</span><br><span class="line">			if (myPendingPress) &#123;</span><br><span class="line">				if (isAMove) &#123;</span><br><span class="line">					if (myPendingShortClickRunnable != null) &#123;</span><br><span class="line">						removeCallbacks(myPendingShortClickRunnable);</span><br><span class="line">						myPendingShortClickRunnable = null;</span><br><span class="line">					&#125;</span><br><span class="line">					if (myPendingLongClickRunnable != null) &#123;</span><br><span class="line">						removeCallbacks(myPendingLongClickRunnable);</span><br><span class="line">					&#125;</span><br><span class="line">					view.onFingerPress(myPressedX, myPressedY);</span><br><span class="line">					myPendingPress = false;</span><br><span class="line">				&#125;</span><br><span class="line">			&#125;</span><br><span class="line">			if (!myPendingPress) &#123;</span><br><span class="line">				view.onFingerMove(x, y);</span><br><span class="line">			&#125;</span><br><span class="line">		&#125;</span><br><span class="line">		break;</span><br><span class="line">	&#125;</span><br><span class="line">	&#125;</span><br><span class="line">	return true;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>当按键抬起的时候， 将手指的位置传给了     view.onFingerSingleTap(x, y);<br>view就是FBView这个类。<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br></pre></td><td class="code"><pre><span class="line">@Override</span><br><span class="line">public boolean onFingerSingleTap(int x, int y) &#123;</span><br><span class="line">    if (super.onFingerSingleTap(x, y)) &#123;</span><br><span class="line">        return true;</span><br><span class="line">    &#125;</span><br><span class="line">    final ZLTextRegion hyperlinkRegion = findRegion(x, y, MAX_SELECTION_DISTANCE, ZLTextRegion.HyperlinkFilter);</span><br><span class="line">    if (hyperlinkRegion != null) &#123;</span><br><span class="line">        // click link</span><br><span class="line">        selectRegion(hyperlinkRegion);</span><br><span class="line">        myReader.getViewWidget().reset();</span><br><span class="line">        myReader.getViewWidget().repaint();</span><br><span class="line">        myReader.runAction(ActionCode.PROCESS_HYPERLINK);</span><br><span class="line">        return true;</span><br><span class="line">    &#125;</span><br><span class="line">    final ZLTextRegion videoRegion = findRegion(x, y, 0, ZLTextRegion.VideoFilter);</span><br><span class="line">    if (videoRegion != null) &#123;</span><br><span class="line">        // click video</span><br><span class="line">        selectRegion(videoRegion);</span><br><span class="line">        myReader.getViewWidget().reset();</span><br><span class="line">        myReader.getViewWidget().repaint();</span><br><span class="line">        myReader.runAction(ActionCode.OPEN_VIDEO, (ZLTextVideoRegionSoul) videoRegion.getSoul());</span><br><span class="line">        return true;</span><br><span class="line">    &#125;</span><br><span class="line">    final ZLTextHighlighting highlighting = findHighlighting(x, y, MAX_SELECTION_DISTANCE);</span><br><span class="line">    if (highlighting instanceof BookmarkHighlighting) &#123;</span><br><span class="line">        myReader.runAction(</span><br><span class="line">                ActionCode.SELECTION_BOOKMARK,</span><br><span class="line">                ((BookmarkHighlighting) highlighting).Bookmark</span><br><span class="line">        );</span><br><span class="line">        return true;</span><br><span class="line">    &#125;</span><br><span class="line">    String actionId = getZoneMap()</span><br><span class="line">            .getActionByCoordinates(x, y, getContextWidth(), getContextHeight(),</span><br><span class="line">                    isDoubleTapSupported() ? TapZoneMap.Tap.singleNotDoubleTap : TapZoneMap.Tap.singleTap);</span><br><span class="line">    myReader.runAction(actionId, x, y);</span><br><span class="line">    return true;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>这段的最后一句就是或坐标的区域</p>
<p>一路跟下去， 发现<figure class="highlight plain"><figcaption><span>这样一个类，看它的构造</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">```</span><br><span class="line">	private TapZoneMap(String name) &#123;</span><br><span class="line">		Name = name;</span><br><span class="line">		myOptionGroupName = &quot;TapZones:&quot; + name;</span><br><span class="line"></span><br><span class="line">        LogUtils.d(&quot;TapZoneMap -&gt; TapZoneMap: &quot; + name);</span><br><span class="line">        myHeight = new ZLIntegerRangeOption(myOptionGroupName, &quot;Height&quot;, 2, 5, 3);</span><br><span class="line">		myWidth = new ZLIntegerRangeOption(myOptionGroupName, &quot;Width&quot;, 2, 5, 3);</span><br><span class="line">		final ZLFile mapFile = ZLFile.createFileByPath(</span><br><span class="line">			&quot;default/tapzones/&quot; + name.toLowerCase() + &quot;.xml&quot;</span><br><span class="line">		);</span><br><span class="line">		new Reader().readQuietly(mapFile);</span><br><span class="line">	&#125;</span><br></pre></td></tr></table></figure></p>
<p>是读了一个文件，我们在资源文件中找下</p>
<p><img src="http://upload-images.jianshu.io/upload_images/1285832-74a9c42083f5c1fa.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240" alt=""><br>果然在这里躺着一堆的文件，应该是按照屏幕的方向 选择默认的配置文件，这里默认的就是right_to_left.xml，我们打开看看。<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">&lt;tapZones v=&quot;3&quot; h=&quot;3&quot;&gt;</span><br><span class="line">	&lt;zone x=&quot;0&quot; y=&quot;0&quot; action=&quot;previousPage&quot; action2=&quot;navigate&quot;/&gt;</span><br><span class="line">	&lt;zone x=&quot;0&quot; y=&quot;1&quot; action=&quot;previousPage&quot;/&gt;</span><br><span class="line">	&lt;zone x=&quot;0&quot; y=&quot;2&quot; action=&quot;previousPage&quot; action2=&quot;menu&quot;/&gt;</span><br><span class="line">	&lt;zone x=&quot;1&quot; y=&quot;0&quot; action2=&quot;navigate&quot;/&gt;</span><br><span class="line">    &lt;zone x=&quot;1&quot; y=&quot;1&quot; action2=&quot;menu&quot;/&gt;</span><br><span class="line">	&lt;zone x=&quot;1&quot; y=&quot;2&quot; action2=&quot;menu&quot;/&gt;</span><br><span class="line">	&lt;zone x=&quot;2&quot; y=&quot;0&quot; action=&quot;nextPage&quot; action2=&quot;navigate&quot;/&gt;</span><br><span class="line">	&lt;zone x=&quot;2&quot; y=&quot;1&quot; action=&quot;nextPage&quot;/&gt;</span><br><span class="line">	&lt;zone x=&quot;2&quot; y=&quot;2&quot; action=&quot;nextPage&quot; action2=&quot;menu&quot;/&gt;</span><br><span class="line">&lt;/tapZones&gt;</span><br></pre></td></tr></table></figure></p>
<p><img src="http://upload-images.jianshu.io/upload_images/1285832-73fff0f4033aa646.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240" alt=""></p>
<p>猜测一下，fbreader应该是把屏幕分成3 x 3的区域，大概就是上面图片的意思。用这个坐标代表，我要点击屏幕中间的，自然我就加了一个1，1的坐标。</p>
<p>得到区域后，执行了<figure class="highlight plain"><figcaption><span>myReader.runAction(actionId, x, y);``` 这个方法。</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">跟音量键的一样，他会把事件分发的```ShowMenuAction```这个类里面。</span><br></pre></td></tr></table></figure></p>
<p>class ShowMenuAction extends FBAndroidAction {<br>    ShowMenuAction(FBReader baseActivity, FBReaderApp fbreader) {<br>        super(baseActivity, fbreader);<br>    }</p>
<pre><code>@Override
protected void run(Object ... params) {
    BaseActivity.openOptionsMenu();
    //BaseActivity.menu();
}
</code></pre><p>}<br><code>`</code><br>源码里调用的是openOptionsMenu，这个baseactivity就是我们的FBReader这个类。我改成自己的方法， 就可以定制自己的菜单栏了，然后抛弃源码提供的菜单栏。</p>
<p>ps：代码看到这里差不多可以进行定制了， 但是，代码里确实是有些无用的东西， 要是能把这些东西去掉的话，做一下精简。应该会更好。</p>

  </div>
</article>



        
          <div id="footer-post-container">
  <div id="footer-post">

    <div id="nav-footer" style="display: none">
      <ul>
         
          <li><a href="/">Home</a></li>
         
          <li><a href="/archives/">Writing</a></li>
         
          <li><a href="https://www.jianshu.com/u/4215db84d54e">JianShu</a></li>
         
          <li><a href="https://github.com/LavenderStream">GitHub</a></li>
         
          <li><a href="/about/">About</a></li>
        
      </ul>
    </div>

    <div id="toc-footer" style="display: none">
      <ol class="toc"><li class="toc-item toc-level-1"><a class="toc-link" href="#FBREADER-源码阅读笔记"><span class="toc-number">1.</span> <span class="toc-text">FBREADER 源码阅读笔记</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#前言"><span class="toc-number">1.1.</span> <span class="toc-text">前言</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#一、代码导入"><span class="toc-number">1.2.</span> <span class="toc-text">一、代码导入</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#1、目的"><span class="toc-number">1.2.0.1.</span> <span class="toc-text">1、目的</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#2、导入"><span class="toc-number">1.2.0.2.</span> <span class="toc-text">2、导入</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#3、运行"><span class="toc-number">1.2.0.3.</span> <span class="toc-text">3、运行</span></a></li></ol></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#二、源码目录"><span class="toc-number">1.3.</span> <span class="toc-text">二、源码目录</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#三、无目的的瞎看"><span class="toc-number">1.4.</span> <span class="toc-text">三、无目的的瞎看</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#六、跳转到固定章节"><span class="toc-number">1.5.</span> <span class="toc-text">六、跳转到固定章节</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#七、字体加大与缩小"><span class="toc-number">1.6.</span> <span class="toc-text">七、字体加大与缩小</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#八、音量键功能"><span class="toc-number">1.7.</span> <span class="toc-text">八、音量键功能</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#九、更换背景，字体颜色"><span class="toc-number">1.8.</span> <span class="toc-text">九、更换背景，字体颜色</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#十、动画类型"><span class="toc-number">1.9.</span> <span class="toc-text">十、动画类型</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#十一、点击区域"><span class="toc-number">1.10.</span> <span class="toc-text">十一、点击区域</span></a></li></ol>
    </div>

    <div id="share-footer" style="display: none">
      <ul>
  <li><a class="icon" href="http://www.facebook.com/sharer.php?u=https://lavenderstream.github.io/2017/06/07/Android-FBReader-阅读笔记/"><i class="fab fa-facebook fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" href="https://twitter.com/share?url=https://lavenderstream.github.io/2017/06/07/Android-FBReader-阅读笔记/&text=Android -- FBReader 阅读笔记 （一）"><i class="fab fa-twitter fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" href="http://www.linkedin.com/shareArticle?url=https://lavenderstream.github.io/2017/06/07/Android-FBReader-阅读笔记/&title=Android -- FBReader 阅读笔记 （一）"><i class="fab fa-linkedin fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" href="https://pinterest.com/pin/create/bookmarklet/?url=https://lavenderstream.github.io/2017/06/07/Android-FBReader-阅读笔记/&is_video=false&description=Android -- FBReader 阅读笔记 （一）"><i class="fab fa-pinterest fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" href="mailto:?subject=Android -- FBReader 阅读笔记 （一）&body=Check out this article: https://lavenderstream.github.io/2017/06/07/Android-FBReader-阅读笔记/"><i class="fas fa-envelope fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" href="https://getpocket.com/save?url=https://lavenderstream.github.io/2017/06/07/Android-FBReader-阅读笔记/&title=Android -- FBReader 阅读笔记 （一）"><i class="fab fa-get-pocket fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" href="http://reddit.com/submit?url=https://lavenderstream.github.io/2017/06/07/Android-FBReader-阅读笔记/&title=Android -- FBReader 阅读笔记 （一）"><i class="fab fa-reddit fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" href="http://www.stumbleupon.com/submit?url=https://lavenderstream.github.io/2017/06/07/Android-FBReader-阅读笔记/&title=Android -- FBReader 阅读笔记 （一）"><i class="fab fa-stumbleupon fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" href="http://digg.com/submit?url=https://lavenderstream.github.io/2017/06/07/Android-FBReader-阅读笔记/&title=Android -- FBReader 阅读笔记 （一）"><i class="fab fa-digg fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" href="http://www.tumblr.com/share/link?url=https://lavenderstream.github.io/2017/06/07/Android-FBReader-阅读笔记/&name=Android -- FBReader 阅读笔记 （一）&description="><i class="fab fa-tumblr fa-lg" aria-hidden="true"></i></a></li>
</ul>

    </div>

    <div id="actions-footer">
        <a id="menu" class="icon" href="#" onclick="$('#nav-footer').toggle();return false;"><i class="fas fa-bars fa-lg" aria-hidden="true"></i> Menu</a>
        <a id="toc" class="icon" href="#" onclick="$('#toc-footer').toggle();return false;"><i class="fas fa-list fa-lg" aria-hidden="true"></i> TOC</a>
        <a id="share" class="icon" href="#" onclick="$('#share-footer').toggle();return false;"><i class="fas fa-share-alt fa-lg" aria-hidden="true"></i> Share</a>
        <a id="top" style="display:none" class="icon" href="#" onclick="$('html, body').animate({ scrollTop: 0 }, 'fast');"><i class="fas fa-chevron-up fa-lg" aria-hidden="true"></i> Top</a>
    </div>

  </div>
</div>

        
        <footer id="footer">
  <div class="footer-left">
    Copyright &copy; 2018 Tiny
  </div>
  <div class="footer-right">
    <nav>
      <ul>
         
          <li><a href="/">Home</a></li>
         
          <li><a href="/archives/">Writing</a></li>
         
          <li><a href="https://www.jianshu.com/u/4215db84d54e">JianShu</a></li>
         
          <li><a href="https://github.com/LavenderStream">GitHub</a></li>
         
          <li><a href="/about/">About</a></li>
        
      </ul>
    </nav>
  </div>
</footer>

    </div>
</body>
</html>
<!-- styles -->
<link rel="stylesheet" href="/lib/font-awesome/css/all.min.css">
<link rel="stylesheet" href="/lib/justified-gallery/css/justifiedGallery.min.css">

<!-- jquery -->
<script src="/lib/jquery/jquery.min.js"></script>
<script src="/lib/justified-gallery/js/jquery.justifiedGallery.min.js"></script>
<script src="/js/main.js"></script>
<script src="/js/plugin.js"></script>

<!-- search -->

<!-- Google Analytics -->

<!-- Baidu Analytics -->

<!-- Disqus Comments -->


