<!DOCTYPE html>
<html lang=en>
<head><meta name="generator" content="Hexo 3.8.0">
    <!-- so meta -->
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="HandheldFriendly" content="True">
    <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
    <meta name="description" content="FBREADER 源码阅读笔记前言这篇文章是我在读源码时候的笔记。是我的一个习惯吧！在阅读源码的时候会记录一下思路，省得自己会忘记，相当于“保护现场”了吧。由于是一边看代码一边记录，一定会有很多的错误，请大家见谅。 一、代码导入在 https://github.com/geometer/FBReaderJ 这个地址上就是fbreader的java项目。 版本库上面的项目是eclipse编写的，所以">
<meta name="keywords" content="top">
<meta property="og:type" content="article">
<meta property="og:title" content="Android -- FBReader 阅读笔记 （一）">
<meta property="og:url" content="https://lavenderstream.github.io/2017/06/07/Android-FBReader-阅读笔记/index.html">
<meta property="og:site_name" content="Tiny hexo">
<meta property="og:description" content="FBREADER 源码阅读笔记前言这篇文章是我在读源码时候的笔记。是我的一个习惯吧！在阅读源码的时候会记录一下思路，省得自己会忘记，相当于“保护现场”了吧。由于是一边看代码一边记录，一定会有很多的错误，请大家见谅。 一、代码导入在 https://github.com/geometer/FBReaderJ 这个地址上就是fbreader的java项目。 版本库上面的项目是eclipse编写的，所以">
<meta property="og:locale" content="en">
<meta property="og:image" content="http://upload-images.jianshu.io/upload_images/1285832-b85eda8375ed7eba.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240">
<meta property="og:image" content="http://upload-images.jianshu.io/upload_images/1285832-64150c323157d15b.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240">
<meta property="og:image" content="http://upload-images.jianshu.io/upload_images/1285832-5f91e1961d40a697.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240">
<meta property="og:image" content="http://upload-images.jianshu.io/upload_images/1285832-fef31aaa09c24d3b.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240">
<meta property="og:image" content="http://upload-images.jianshu.io/upload_images/1285832-9f467aaa18ed9b94.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240">
<meta property="og:image" content="http://upload-images.jianshu.io/upload_images/1285832-0f11ada01dfdcc4e.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240">
<meta property="og:image" content="http://upload-images.jianshu.io/upload_images/1285832-c99fa50150a7cae8.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240">
<meta property="og:image" content="http://upload-images.jianshu.io/upload_images/1285832-536bb4e37ccc3d4d.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240">
<meta property="og:image" content="http://upload-images.jianshu.io/upload_images/1285832-fce1a35e1d34fcca.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240">
<meta property="og:image" content="http://upload-images.jianshu.io/upload_images/1285832-61bf63d9a9c654d6.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240">
<meta property="og:image" content="http://upload-images.jianshu.io/upload_images/1285832-8ba92e761ff95a45.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240">
<meta property="og:image" content="http://upload-images.jianshu.io/upload_images/1285832-494b2e8a2f176862.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240">
<meta property="og:image" content="http://upload-images.jianshu.io/upload_images/1285832-9d1fe7bbd2f273e4.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240">
<meta property="og:image" content="http://upload-images.jianshu.io/upload_images/1285832-8f2047c238f09216.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240">
<meta property="og:image" content="http://upload-images.jianshu.io/upload_images/1285832-da2718c32da2c4c5.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240">
<meta property="og:image" content="http://upload-images.jianshu.io/upload_images/1285832-293224e691cf1053.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240">
<meta property="og:image" content="http://upload-images.jianshu.io/upload_images/1285832-6db0ded4df8dd286.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240">
<meta property="og:image" content="http://upload-images.jianshu.io/upload_images/1285832-aad6afda339e53dd.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240">
<meta property="og:image" content="http://upload-images.jianshu.io/upload_images/1285832-84ea417bf7ba3a04.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240">
<meta property="og:image" content="http://upload-images.jianshu.io/upload_images/1285832-c4dbe0cfdaebc3d6.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240">
<meta property="og:image" content="http://upload-images.jianshu.io/upload_images/1285832-74a9c42083f5c1fa.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240">
<meta property="og:image" content="http://upload-images.jianshu.io/upload_images/1285832-73fff0f4033aa646.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240">
<meta property="og:updated_time" content="2018-10-27T16:58:03.294Z">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="Android -- FBReader 阅读笔记 （一）">
<meta name="twitter:description" content="FBREADER 源码阅读笔记前言这篇文章是我在读源码时候的笔记。是我的一个习惯吧！在阅读源码的时候会记录一下思路，省得自己会忘记，相当于“保护现场”了吧。由于是一边看代码一边记录，一定会有很多的错误，请大家见谅。 一、代码导入在 https://github.com/geometer/FBReaderJ 这个地址上就是fbreader的java项目。 版本库上面的项目是eclipse编写的，所以">
<meta name="twitter:image" content="http://upload-images.jianshu.io/upload_images/1285832-b85eda8375ed7eba.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240">
    
    
        
          
              <link rel="shortcut icon" href="/images/favicon.ico">
          
        
        
          
            <link rel="icon" type="image/png" href="/images/favicon-192x192.png" sizes="192x192">
          
        
        
          
            <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon.png">
          
        
    
    <!-- title -->
    <title>Android -- FBReader 阅读笔记 （一）</title>
    <!-- styles -->
    <link rel="stylesheet" href="/css/style.css">
    <!-- persian styles -->
    
      <link rel="stylesheet" href="/css/rtl.css">
    
    <!-- rss -->
    
    
</head>

<body class="max-width mx-auto px3 ltr">
    
      <div id="header-post">
    <a id="menu-icon" href="#"><i class="fas fa-bars fa-lg"></i></a>
    <a id="menu-icon-tablet" href="#"><i class="fas fa-bars fa-lg"></i></a>
    <a id="top-icon-tablet" href="#" onclick="$('html, body').animate({ scrollTop: 0 }, 'fast');" style="display:none;"><i class="fas fa-chevron-up fa-lg"></i></a>
    <span id="menu">
    <span id="nav">
      <ul>
          
          
          <li><a href="/">Home</a></li>
          
          
          <li><a href="/archives/">Writing</a></li>
          
          
          <li><a href="https://www.jianshu.com/u/4215db84d54e" target="_blank">JianShu</a></li>
          
          
          <li><a href="https://github.com/LavenderStream" target="_blank">GitHub</a></li>
          
          
          <li><a href="/about/">About</a></li>
          
      </ul>
    </span>
    <br>
    <span id="actions">
      <ul>
          
          <li><a class="icon" href="/2017/06/14/Android-FBReader-阅读笔记-（二）/"><i class="fas fa-chevron-left" aria-hidden="true" onmouseover="$('#i-prev').toggle();" onmouseout="$('#i-prev').toggle();"></i></a></li>
          
          
          <li><a class="icon" href="/2017/05/19/AndroidStudio-自动生成ViewModel的IDE插件/"><i class="fas fa-chevron-right" aria-hidden="true" onmouseover="$('#i-next').toggle();" onmouseout="$('#i-next').toggle();"></i></a></li>
          
          <li><a class="icon" href="#" onclick="$('html, body').animate({ scrollTop: 0 }, 'fast');"><i class="fas fa-chevron-up" aria-hidden="true" onmouseover="$('#i-top').toggle();" onmouseout="$('#i-top').toggle();"></i></a></li>
        <li><a class="icon" href="#"><i class="fas fa-share-alt" aria-hidden="true" onmouseover="$('#i-share').toggle();" onmouseout="$('#i-share').toggle();" onclick="$('#share').toggle();return false;"></i></a></li>
      </ul>
      <span id="i-prev" class="info" style="display:none;">Previous post</span>
      <span id="i-next" class="info" style="display:none;">Next post</span>
      <span id="i-top" class="info" style="display:none;">Back to top</span>
      <span id="i-share" class="info" style="display:none;">Share post</span>
    </span>
    <br>
    <div id="share" style="display: none">
      <ul>
  <li><a class="icon" href="http://www.facebook.com/sharer.php?u=https://lavenderstream.github.io/2017/06/07/Android-FBReader-阅读笔记/"><i class="fab fa-facebook " aria-hidden="true"></i></a></li>
  <li><a class="icon" href="https://twitter.com/share?url=https://lavenderstream.github.io/2017/06/07/Android-FBReader-阅读笔记/&text=Android -- FBReader 阅读笔记 （一）"><i class="fab fa-twitter " aria-hidden="true"></i></a></li>
  <li><a class="icon" href="http://www.linkedin.com/shareArticle?url=https://lavenderstream.github.io/2017/06/07/Android-FBReader-阅读笔记/&title=Android -- FBReader 阅读笔记 （一）"><i class="fab fa-linkedin " aria-hidden="true"></i></a></li>
  <li><a class="icon" href="https://pinterest.com/pin/create/bookmarklet/?url=https://lavenderstream.github.io/2017/06/07/Android-FBReader-阅读笔记/&is_video=false&description=Android -- FBReader 阅读笔记 （一）"><i class="fab fa-pinterest " aria-hidden="true"></i></a></li>
  <li><a class="icon" href="mailto:?subject=Android -- FBReader 阅读笔记 （一）&body=Check out this article: https://lavenderstream.github.io/2017/06/07/Android-FBReader-阅读笔记/"><i class="fas fa-envelope " aria-hidden="true"></i></a></li>
  <li><a class="icon" href="https://getpocket.com/save?url=https://lavenderstream.github.io/2017/06/07/Android-FBReader-阅读笔记/&title=Android -- FBReader 阅读笔记 （一）"><i class="fab fa-get-pocket " aria-hidden="true"></i></a></li>
  <li><a class="icon" href="http://reddit.com/submit?url=https://lavenderstream.github.io/2017/06/07/Android-FBReader-阅读笔记/&title=Android -- FBReader 阅读笔记 （一）"><i class="fab fa-reddit " aria-hidden="true"></i></a></li>
  <li><a class="icon" href="http://www.stumbleupon.com/submit?url=https://lavenderstream.github.io/2017/06/07/Android-FBReader-阅读笔记/&title=Android -- FBReader 阅读笔记 （一）"><i class="fab fa-stumbleupon " aria-hidden="true"></i></a></li>
  <li><a class="icon" href="http://digg.com/submit?url=https://lavenderstream.github.io/2017/06/07/Android-FBReader-阅读笔记/&title=Android -- FBReader 阅读笔记 （一）"><i class="fab fa-digg " aria-hidden="true"></i></a></li>
  <li><a class="icon" href="http://www.tumblr.com/share/link?url=https://lavenderstream.github.io/2017/06/07/Android-FBReader-阅读笔记/&name=Android -- FBReader 阅读笔记 （一）&description="><i class="fab fa-tumblr " aria-hidden="true"></i></a></li>
</ul>

    </div>
    <div id="toc">
      <ol class="toc"><li class="toc-item toc-level-1"><a class="toc-link" href="#FBREADER-源码阅读笔记"><span class="toc-number">1.</span> <span class="toc-text">FBREADER 源码阅读笔记</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#前言"><span class="toc-number">1.1.</span> <span class="toc-text">前言</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#一、代码导入"><span class="toc-number">1.2.</span> <span class="toc-text">一、代码导入</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#1、目的"><span class="toc-number">1.2.1.</span> <span class="toc-text">1、目的</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#2、导入"><span class="toc-number">1.2.2.</span> <span class="toc-text">2、导入</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#3、运行"><span class="toc-number">1.2.3.</span> <span class="toc-text">3、运行</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#二、源码目录"><span class="toc-number">1.3.</span> <span class="toc-text">二、源码目录</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#三、无目的的瞎看"><span class="toc-number">1.4.</span> <span class="toc-text">三、无目的的瞎看</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#四、怎样获得book对象"><span class="toc-number">1.5.</span> <span class="toc-text">四、怎样获得book对象</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#这里留一个问题，-这个booktree是怎么来的？-先不着急分析他"><span class="toc-number">1.5.1.</span> <span class="toc-text">这里留一个问题， 这个booktree是怎么来的？ 先不着急分析他</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#五、怎么跳转到Fbreader这个activity"><span class="toc-number">1.6.</span> <span class="toc-text">五、怎么跳转到Fbreader这个activity</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#六、跳转到固定章节"><span class="toc-number">1.7.</span> <span class="toc-text">六、跳转到固定章节</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#七、字体加大与缩小"><span class="toc-number">1.8.</span> <span class="toc-text">七、字体加大与缩小</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#八、音量键功能"><span class="toc-number">1.9.</span> <span class="toc-text">八、音量键功能</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#九、更换背景，字体颜色"><span class="toc-number">1.10.</span> <span class="toc-text">九、更换背景，字体颜色</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#十、动画类型"><span class="toc-number">1.11.</span> <span class="toc-text">十、动画类型</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#十一、点击区域"><span class="toc-number">1.12.</span> <span class="toc-text">十一、点击区域</span></a></li></ol></li></ol>
    </div>
  </span>
</div>

    
    <div class="content index py4">
        
        <article class="post" itemscope="" itemtype="http://schema.org/BlogPosting">
  <header>
    
    <h1 class="posttitle" itemprop="name headline">
        Android -- FBReader 阅读笔记 （一）
    </h1>



    <div class="meta">
      <span class="author" itemprop="author" itemscope="" itemtype="http://schema.org/Person">
        <span itemprop="name">Tiny</span>
      </span>
      
    <div class="postdate">
        <time datetime="2017-06-07T02:49:00.000Z" itemprop="datePublished">2017-06-07</time>
    </div>


      
    <div class="article-category">
        <i class="fas fa-archive"></i>
        <a class="category-link" href="/categories/Android/">Android</a>
    </div>


      
    <div class="article-tag">
        <i class="fas fa-tag"></i>
        <a class="tag-link" href="/tags/top/">top</a>
    </div>


    </div>
  </header>
  

  <div class="content" itemprop="articleBody">
    <h1 id="FBREADER-源码阅读笔记"><a href="#FBREADER-源码阅读笔记" class="headerlink" title="FBREADER 源码阅读笔记"></a>FBREADER 源码阅读笔记</h1><h2 id="前言"><a href="#前言" class="headerlink" title="前言"></a>前言</h2><p>这篇文章是我在读源码时候的笔记。是我的一个习惯吧！在阅读源码的时候会记录一下思路，省得自己会忘记，相当于“保护现场”了吧。由于是一边看代码一边记录，一定会有很多的错误，请大家见谅。</p>
<h2 id="一、代码导入"><a href="#一、代码导入" class="headerlink" title="一、代码导入"></a>一、代码导入</h2><p>在 <a href="https://github.com/geometer/FBReaderJ" target="_blank" rel="noopener">https://github.com/geometer/FBReaderJ</a> 这个地址上就是fbreader的java项目。</p>
<p>版本库上面的项目是eclipse编写的，所以第一步，想办法把这个项目变成AS上开发的</p>
<p>（因为种种原因，我并没有clone github上的源码，在我们svn存在着之前的一个fbreader版本，是2.0的）</p>
<h3 id="1、目的"><a href="#1、目的" class="headerlink" title="1、目的"></a>1、目的</h3><p>导入fbreader这个项目是想在自己的程序中加入阅读器的功能。但从头开始开发时间长，并且没做过。所以参考了fbreader，在源码的基础上做二次开发。</p>
<p>代码同步下来之后，发现。fbreader并不是一个开源库（SDK）,而是一个完整的项目，部分功能使用了jni开发，并且支持插件化，通过aidl，进行组件之间的通讯</p>
<p>因为要导入现有的项目（重构ing），想法是将fbreader整个项目编译成aar，然后导入现有项目。因为时间短，起初可以先把整个fbreader导入，之后对fbreader研究之后，或去掉相应模块或者重新开发</p>
<h3 id="2、导入"><a href="#2、导入" class="headerlink" title="2、导入"></a>2、导入</h3><p>导入过程比较繁琐，又没什么技术含量。主要就是将之前ant构建的项目换成gradle构建。</p>
<p>这里设计jni和aidl的目录结构有所变化，按照android studio上面的结构统一创建就好</p>
<p>（这里我犯了一个错误，fbreader的主项目千万别改报名，就按照之前的来，否则要改掉很多文件的import，相当费事儿。千万别改，千万别改，千万别改）</p>
<h3 id="3、运行"><a href="#3、运行" class="headerlink" title="3、运行"></a>3、运行</h3><p>先用ndk-build编出so， 然后在导入或者直接用android studio 带c++ 一起编， 都可以。反正 studio 也支持编译c语言了。</p>
<p>这里我直接使用ndk-build 编出so库，然后将so库添加到我的项目中去。省着clean项目的时候还要去重新编译，挺耗时间的。</p>
<h2 id="二、源码目录"><a href="#二、源码目录" class="headerlink" title="二、源码目录"></a>二、源码目录</h2><p>源码中的目录结构，其实我是在公司的svn里看到的，不知道谁写的，看时间，写这个文章的时候我刚上大学。</p>
<p>我就直接撸过来了。<br><img src="http://upload-images.jianshu.io/upload_images/1285832-b85eda8375ed7eba.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240" alt=""></p>
<p>用红笔画掉的是fbreader的一些三方以来，fbreader是主要的源码目录，</p>
<p>app 是我用来模仿公司的主项目的，其实就是一句startActivity。</p>
<p>以下是源码的一些目录<br><img src="http://upload-images.jianshu.io/upload_images/1285832-64150c323157d15b.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240" alt=""></p>
<p>jni 的文件目录</p>
<p><img src="http://upload-images.jianshu.io/upload_images/1285832-5f91e1961d40a697.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240" alt=""></p>
<p>整个项目的， 大概看一看</p>
<p><img src="http://upload-images.jianshu.io/upload_images/1285832-fef31aaa09c24d3b.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240" alt=""></p>
<h2 id="三、无目的的瞎看"><a href="#三、无目的的瞎看" class="headerlink" title="三、无目的的瞎看"></a>三、无目的的瞎看</h2><p>网上的资源不是很多，项目也较老了。再加上从未接触过阅读相关的项目。扎铁了老心。没有头绪就从头看代码吧。</p>
<p>再 AndroidManifest 能知道应用的主activity是 <strong>org.geometerplus.android.fbreader.FBReader</strong></p>
<p>(这里强插一句， 想运行fbreader这个项目，application是要继承自FBReaderApplication；还要修改FBReaderIntents类的第一行的包名，保持与项目的包名一致)</p>
<p>在FBReader先无目的看一下 <strong>FBReader::onCreate</strong></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">onCreate</span><span class="params">(Bundle icicle)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">super</span>.onCreate(icicle);</span><br><span class="line">        <span class="comment">// 捕获错误</span></span><br><span class="line">        Thread.setDefaultUncaughtExceptionHandler(<span class="keyword">new</span> UncaughtExceptionHandler(<span class="keyword">this</span>));</span><br><span class="line"></span><br><span class="line">        bindService(</span><br><span class="line">                <span class="keyword">new</span> Intent(<span class="keyword">this</span>, DataService.class),</span><br><span class="line">                DataConnection,</span><br><span class="line">                DataService.BIND_AUTO_CREATE</span><br><span class="line">        );</span><br><span class="line"></span><br><span class="line">        <span class="keyword">final</span> Config config = Config.Instance();</span><br><span class="line">        config.runOnConnect(<span class="keyword">new</span> Runnable() &#123;</span><br><span class="line">            <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">run</span><span class="params">()</span> </span>&#123;</span><br><span class="line">                config.requestAllValuesForGroup(<span class="string">"Options"</span>);</span><br><span class="line">                config.requestAllValuesForGroup(<span class="string">"Style"</span>);</span><br><span class="line">                config.requestAllValuesForGroup(<span class="string">"LookNFeel"</span>);</span><br><span class="line">                config.requestAllValuesForGroup(<span class="string">"Fonts"</span>);</span><br><span class="line">                config.requestAllValuesForGroup(<span class="string">"Colors"</span>);</span><br><span class="line">                config.requestAllValuesForGroup(<span class="string">"Files"</span>);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">final</span> ZLAndroidLibrary zlibrary = getZLibrary();</span><br><span class="line">        myShowStatusBarFlag = zlibrary.ShowStatusBarOption.getValue();</span><br><span class="line"></span><br><span class="line">        requestWindowFeature(Window.FEATURE_NO_TITLE);</span><br><span class="line">        setContentView(R.layout.main);</span><br><span class="line">        myRootView = (RelativeLayout) findViewById(R.id.root_view);</span><br><span class="line">        myMainView = (ZLAndroidWidget) findViewById(R.id.main_view);</span><br><span class="line">        <span class="comment">// setting keyboard default mode</span></span><br><span class="line">        setDefaultKeyMode(DEFAULT_KEYS_SEARCH_LOCAL);</span><br><span class="line"></span><br><span class="line">        zlibrary.setActivity(<span class="keyword">this</span>);</span><br><span class="line"></span><br><span class="line">        myFBReaderApp = (FBReaderApp) FBReaderApp.Instance();</span><br><span class="line">        <span class="keyword">if</span> (myFBReaderApp == <span class="keyword">null</span>) &#123;</span><br><span class="line">            myFBReaderApp = <span class="keyword">new</span> FBReaderApp(<span class="keyword">new</span> BookCollectionShadow());</span><br><span class="line">        &#125;</span><br><span class="line">        getCollection().bindToService(<span class="keyword">this</span>, <span class="keyword">null</span>);</span><br><span class="line">        myBook = <span class="keyword">null</span>;</span><br><span class="line"></span><br><span class="line">        myFBReaderApp.setWindow(<span class="keyword">this</span>);</span><br><span class="line">        myFBReaderApp.initWindow();</span><br><span class="line"></span><br><span class="line">        myFBReaderApp.setExternalFileOpener(<span class="keyword">new</span> ExternalFileOpener(<span class="keyword">this</span>));</span><br><span class="line"></span><br><span class="line">        getWindow().setFlags(</span><br><span class="line">                WindowManager.LayoutParams.FLAG_FULLSCREEN,</span><br><span class="line">                myShowStatusBarFlag ? <span class="number">0</span> : WindowManager.LayoutParams.FLAG_FULLSCREEN</span><br><span class="line">        );</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (myFBReaderApp.getPopupById(TextSearchPopup.ID) == <span class="keyword">null</span>) &#123;</span><br><span class="line">            <span class="keyword">new</span> TextSearchPopup(myFBReaderApp);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">if</span> (myFBReaderApp.getPopupById(NavigationPopup.ID) == <span class="keyword">null</span>) &#123;</span><br><span class="line">            <span class="keyword">new</span> NavigationPopup(myFBReaderApp);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">if</span> (myFBReaderApp.getPopupById(SelectionPopup.ID) == <span class="keyword">null</span>) &#123;</span><br><span class="line">            <span class="keyword">new</span> SelectionPopup(myFBReaderApp);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        myFBReaderApp.addAction(ActionCode.SHOW_LIBRARY, <span class="keyword">new</span> ShowLibraryAction(<span class="keyword">this</span>, myFBReaderApp));</span><br><span class="line">        myFBReaderApp.addAction(ActionCode.SHOW_PREFERENCES, <span class="keyword">new</span> ShowPreferencesAction(<span class="keyword">this</span>, myFBReaderApp));</span><br><span class="line">        myFBReaderApp.addAction(ActionCode.SHOW_BOOK_INFO, <span class="keyword">new</span> ShowBookInfoAction(<span class="keyword">this</span>, myFBReaderApp));</span><br><span class="line">        myFBReaderApp.addAction(ActionCode.SHOW_TOC, <span class="keyword">new</span> ShowTOCAction(<span class="keyword">this</span>, myFBReaderApp));</span><br><span class="line">        myFBReaderApp.addAction(ActionCode.SHOW_BOOKMARKS, <span class="keyword">new</span> ShowBookmarksAction(<span class="keyword">this</span>, myFBReaderApp));</span><br><span class="line">        myFBReaderApp.addAction(ActionCode.SHOW_NETWORK_LIBRARY, <span class="keyword">new</span> ShowNetworkLibraryAction(<span class="keyword">this</span>, myFBReaderApp));</span><br><span class="line"></span><br><span class="line">        myFBReaderApp.addAction(ActionCode.SHOW_MENU, <span class="keyword">new</span> ShowMenuAction(<span class="keyword">this</span>, myFBReaderApp));</span><br><span class="line">        myFBReaderApp.addAction(ActionCode.SHOW_NAVIGATION, <span class="keyword">new</span> ShowNavigationAction(<span class="keyword">this</span>, myFBReaderApp));</span><br><span class="line">        myFBReaderApp.addAction(ActionCode.SEARCH, <span class="keyword">new</span> SearchAction(<span class="keyword">this</span>, myFBReaderApp));</span><br><span class="line">        myFBReaderApp.addAction(ActionCode.SHARE_BOOK, <span class="keyword">new</span> ShareBookAction(<span class="keyword">this</span>, myFBReaderApp));</span><br><span class="line"></span><br><span class="line">        myFBReaderApp.addAction(ActionCode.SELECTION_SHOW_PANEL, <span class="keyword">new</span> SelectionShowPanelAction(<span class="keyword">this</span>, myFBReaderApp));</span><br><span class="line">        myFBReaderApp.addAction(ActionCode.SELECTION_HIDE_PANEL, <span class="keyword">new</span> SelectionHidePanelAction(<span class="keyword">this</span>, myFBReaderApp));</span><br><span class="line">        myFBReaderApp.addAction(ActionCode.SELECTION_COPY_TO_CLIPBOARD, <span class="keyword">new</span> SelectionCopyAction(<span class="keyword">this</span>, myFBReaderApp));</span><br><span class="line">        myFBReaderApp.addAction(ActionCode.SELECTION_SHARE, <span class="keyword">new</span> SelectionShareAction(<span class="keyword">this</span>, myFBReaderApp));</span><br><span class="line">        myFBReaderApp.addAction(ActionCode.SELECTION_TRANSLATE, <span class="keyword">new</span> SelectionTranslateAction(<span class="keyword">this</span>, myFBReaderApp));</span><br><span class="line">        myFBReaderApp.addAction(ActionCode.SELECTION_BOOKMARK, <span class="keyword">new</span> SelectionBookmarkAction(<span class="keyword">this</span>, myFBReaderApp));</span><br><span class="line"></span><br><span class="line">        myFBReaderApp.addAction(ActionCode.PROCESS_HYPERLINK, <span class="keyword">new</span> ProcessHyperlinkAction(<span class="keyword">this</span>, myFBReaderApp));</span><br><span class="line">        myFBReaderApp.addAction(ActionCode.OPEN_VIDEO, <span class="keyword">new</span> OpenVideoAction(<span class="keyword">this</span>, myFBReaderApp));</span><br><span class="line"></span><br><span class="line">        myFBReaderApp.addAction(ActionCode.SHOW_CANCEL_MENU, <span class="keyword">new</span> ShowCancelMenuAction(<span class="keyword">this</span>, myFBReaderApp));</span><br><span class="line"></span><br><span class="line">        myFBReaderApp.addAction(ActionCode.SET_SCREEN_ORIENTATION_SYSTEM, <span class="keyword">new</span> SetScreenOrientationAction(<span class="keyword">this</span>, myFBReaderApp, ZLibrary.SCREEN_ORIENTATION_SYSTEM));</span><br><span class="line">        myFBReaderApp.addAction(ActionCode.SET_SCREEN_ORIENTATION_SENSOR, <span class="keyword">new</span> SetScreenOrientationAction(<span class="keyword">this</span>, myFBReaderApp, ZLibrary.SCREEN_ORIENTATION_SENSOR));</span><br><span class="line">        myFBReaderApp.addAction(ActionCode.SET_SCREEN_ORIENTATION_PORTRAIT, <span class="keyword">new</span> SetScreenOrientationAction(<span class="keyword">this</span>, myFBReaderApp, ZLibrary.SCREEN_ORIENTATION_PORTRAIT));</span><br><span class="line">        myFBReaderApp.addAction(ActionCode.SET_SCREEN_ORIENTATION_LANDSCAPE, <span class="keyword">new</span> SetScreenOrientationAction(<span class="keyword">this</span>, myFBReaderApp, ZLibrary.SCREEN_ORIENTATION_LANDSCAPE));</span><br><span class="line">        <span class="keyword">if</span> (ZLibrary.Instance().supportsAllOrientations()) &#123;</span><br><span class="line">            myFBReaderApp.addAction(ActionCode.SET_SCREEN_ORIENTATION_REVERSE_PORTRAIT, <span class="keyword">new</span> SetScreenOrientationAction(<span class="keyword">this</span>, myFBReaderApp, ZLibrary.SCREEN_ORIENTATION_REVERSE_PORTRAIT));</span><br><span class="line">            myFBReaderApp.addAction(ActionCode.SET_SCREEN_ORIENTATION_REVERSE_LANDSCAPE, <span class="keyword">new</span> SetScreenOrientationAction(<span class="keyword">this</span>, myFBReaderApp, ZLibrary.SCREEN_ORIENTATION_REVERSE_LANDSCAPE));</span><br><span class="line">        &#125;</span><br><span class="line">        myFBReaderApp.addAction(ActionCode.OPEN_WEB_HELP, <span class="keyword">new</span> OpenWebHelpAction(<span class="keyword">this</span>, myFBReaderApp));</span><br><span class="line">        myFBReaderApp.addAction(ActionCode.INSTALL_PLUGINS, <span class="keyword">new</span> InstallPluginsAction(<span class="keyword">this</span>, myFBReaderApp));</span><br><span class="line"></span><br><span class="line">        <span class="keyword">final</span> Intent intent = getIntent();</span><br><span class="line">        <span class="keyword">final</span> String action = intent.getAction();</span><br><span class="line"></span><br><span class="line">        myOpenBookIntent = intent;</span><br><span class="line">        <span class="keyword">if</span> ((intent.getFlags() &amp; Intent.FLAG_ACTIVITY_LAUNCHED_FROM_HISTORY) == <span class="number">0</span>) &#123;</span><br><span class="line">            <span class="keyword">if</span> (FBReaderIntents.Action.CLOSE.equals(action)) &#123;</span><br><span class="line">                myCancelIntent = intent;</span><br><span class="line">                myOpenBookIntent = <span class="keyword">null</span>;</span><br><span class="line">            &#125; <span class="keyword">else</span> <span class="keyword">if</span> (FBReaderIntents.Action.PLUGIN_CRASH.equals(action)) &#123;</span><br><span class="line">                myFBReaderApp.ExternalBook = <span class="keyword">null</span>;</span><br><span class="line">                myOpenBookIntent = <span class="keyword">null</span>;</span><br><span class="line">                getCollection().bindToService(<span class="keyword">this</span>, <span class="keyword">new</span> Runnable() &#123;</span><br><span class="line">                    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">run</span><span class="params">()</span> </span>&#123;</span><br><span class="line">                        myFBReaderApp.openBook(<span class="keyword">null</span>, <span class="keyword">null</span>, <span class="keyword">null</span>);</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>
<p>onCreate的代码好长一堆，还什么都看不懂。最后一段貌似是openBook 的操作， 但是intent和action 都是空的，根本不执行FBReader也不存在父类，只能是在<strong>onResume()</strong>中了</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">FBReader::onResume()</span><br></pre></td></tr></table></figure>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">onResume</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    <span class="keyword">super</span>.onResume();</span><br><span class="line"></span><br><span class="line">    SyncOperations.enableSync(<span class="keyword">this</span>, <span class="keyword">true</span>);</span><br><span class="line"></span><br><span class="line">    myStartTimer = <span class="keyword">true</span>;</span><br><span class="line">    Config.Instance().runOnConnect(<span class="keyword">new</span> Runnable() &#123;</span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">run</span><span class="params">()</span> </span>&#123;</span><br><span class="line">            <span class="keyword">final</span> <span class="keyword">int</span> brightnessLevel =</span><br><span class="line">                    getZLibrary().ScreenBrightnessLevelOption.getValue();</span><br><span class="line">            <span class="keyword">if</span> (brightnessLevel != <span class="number">0</span>) &#123;</span><br><span class="line">                setScreenBrightness(brightnessLevel);</span><br><span class="line">            &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                setScreenBrightnessAuto();</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">if</span> (getZLibrary().DisableButtonLightsOption.getValue()) &#123;</span><br><span class="line">                setButtonLight(<span class="keyword">false</span>);</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            getCollection().bindToService(FBReader.<span class="keyword">this</span>, <span class="keyword">new</span> Runnable() &#123;</span><br><span class="line">                <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">run</span><span class="params">()</span> </span>&#123;</span><br><span class="line">                    <span class="keyword">final</span> BookModel model = myFBReaderApp.Model;</span><br><span class="line">                    <span class="keyword">if</span> (model == <span class="keyword">null</span> || model.Book == <span class="keyword">null</span>) &#123;</span><br><span class="line">                        <span class="keyword">return</span>;</span><br><span class="line">                    &#125;</span><br><span class="line">                    onPreferencesUpdate(myFBReaderApp.Collection.getBookById(model.Book.getId()));</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;);</span><br><span class="line"></span><br><span class="line">    registerReceiver(myBatteryInfoReceiver, <span class="keyword">new</span> IntentFilter(Intent.ACTION_BATTERY_CHANGED));</span><br><span class="line">    IsPaused = <span class="keyword">false</span>;</span><br><span class="line">    myResumeTimestamp = System.currentTimeMillis();</span><br><span class="line">    <span class="keyword">if</span> (OnResumeAction != <span class="keyword">null</span>) &#123;</span><br><span class="line">        <span class="keyword">final</span> Runnable action = OnResumeAction;</span><br><span class="line">        OnResumeAction = <span class="keyword">null</span>;</span><br><span class="line">        action.run();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    registerReceiver(mySyncUpdateReceiver, <span class="keyword">new</span> IntentFilter(SyncOperations.UPDATED));</span><br><span class="line"></span><br><span class="line">    SetScreenOrientationAction.setOrientation(<span class="keyword">this</span>, ZLibrary.Instance().getOrientationOption().getValue());</span><br><span class="line"></span><br><span class="line">    LogUtils.d(<span class="string">"FBReader -&gt; onResume cancelIntent: "</span> + myCancelIntent);</span><br><span class="line">    LogUtils.d(<span class="string">"FBReader -&gt; onResume myOpenBookIntent: "</span> + myOpenBookIntent);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (myCancelIntent != <span class="keyword">null</span>) &#123;</span><br><span class="line">        <span class="keyword">final</span> Intent intent = myCancelIntent;</span><br><span class="line">        myCancelIntent = <span class="keyword">null</span>;</span><br><span class="line">        getCollection().bindToService(<span class="keyword">this</span>, <span class="keyword">new</span> Runnable() &#123;</span><br><span class="line">            <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">run</span><span class="params">()</span> </span>&#123;</span><br><span class="line">                runCancelAction(intent);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;);</span><br><span class="line">        <span class="keyword">return</span>;</span><br><span class="line">    &#125; <span class="keyword">else</span> <span class="keyword">if</span> (myOpenBookIntent != <span class="keyword">null</span>) &#123;</span><br><span class="line">        <span class="comment">// it's maybe run here</span></span><br><span class="line">        <span class="keyword">final</span> Intent intent = myOpenBookIntent;</span><br><span class="line">        myOpenBookIntent = <span class="keyword">null</span>;</span><br><span class="line">        getCollection().bindToService(<span class="keyword">this</span>, <span class="keyword">new</span> Runnable() &#123;</span><br><span class="line">            <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">run</span><span class="params">()</span> </span>&#123;</span><br><span class="line">                openBook(intent, <span class="keyword">null</span>, <span class="keyword">true</span>);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;);</span><br><span class="line">    &#125; <span class="keyword">else</span> <span class="keyword">if</span> (myFBReaderApp.getCurrentServerBook() != <span class="keyword">null</span>) &#123;</span><br><span class="line">        getCollection().bindToService(<span class="keyword">this</span>, <span class="keyword">new</span> Runnable() &#123;</span><br><span class="line">            <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">run</span><span class="params">()</span> </span>&#123;</span><br><span class="line">                myFBReaderApp.useSyncInfo(<span class="keyword">true</span>);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;);</span><br><span class="line">    &#125; <span class="keyword">else</span> <span class="keyword">if</span> (myFBReaderApp.Model == <span class="keyword">null</span> &amp;&amp; myFBReaderApp.ExternalBook != <span class="keyword">null</span>) &#123;</span><br><span class="line">        getCollection().bindToService(<span class="keyword">this</span>, <span class="keyword">new</span> Runnable() &#123;</span><br><span class="line">            <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">run</span><span class="params">()</span> </span>&#123;</span><br><span class="line">                myFBReaderApp.openBook(myFBReaderApp.ExternalBook, <span class="keyword">null</span>, <span class="keyword">null</span>);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;);</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        getCollection().bindToService(<span class="keyword">this</span>, <span class="keyword">new</span> Runnable() &#123;</span><br><span class="line">            <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">run</span><span class="params">()</span> </span>&#123;</span><br><span class="line">                myFBReaderApp.useSyncInfo(<span class="keyword">true</span>);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    PopupPanel.restoreVisibilities(myFBReaderApp);</span><br><span class="line">    ApiServerImplementation.sendEvent(<span class="keyword">this</span>, ApiListener.EVENT_READ_MODE_OPENED);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>通过一顿的输出log并且debug代码，发现执行了onResume中最后的几个分支语句的第二个分支。</p>
<p>bindToService 这个是什么？ 先不管它，往下看</p>
<p>接下来调用了</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">FBReader::openBook(Intent intent, <span class="keyword">final</span> Runnable action, <span class="keyword">boolean</span> force)</span><br></pre></td></tr></table></figure>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">synchronized</span> <span class="keyword">void</span> <span class="title">openBook</span><span class="params">(Intent intent, <span class="keyword">final</span> Runnable action, <span class="keyword">boolean</span> force)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">if</span> (!force &amp;&amp; myBook != <span class="keyword">null</span>) &#123;</span><br><span class="line">            <span class="keyword">return</span>;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        myBook = FBReaderIntents.getBookExtra(intent);</span><br><span class="line">        <span class="keyword">final</span> Bookmark bookmark = FBReaderIntents.getBookmarkExtra(intent);</span><br><span class="line">        LogUtils.d(<span class="string">"FBReader -&gt; openBook myBook: "</span> + myBook);</span><br><span class="line">        <span class="keyword">if</span> (myBook == <span class="keyword">null</span>) &#123;</span><br><span class="line">            <span class="keyword">final</span> Uri data = intent.getData();</span><br><span class="line">            LogUtils.d(<span class="string">"FBReader -&gt; openBook data: "</span> + data);</span><br><span class="line">            <span class="keyword">if</span> (data != <span class="keyword">null</span>) &#123;</span><br><span class="line">                myBook = createBookForFile(ZLFile.createFileByPath(data.getPath()));</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">if</span> (myBook != <span class="keyword">null</span>) &#123;</span><br><span class="line">            ZLFile file = myBook.File;</span><br><span class="line">            LogUtils.d(<span class="string">"FBReader -&gt; openBook file path: "</span> + file.getPath());</span><br><span class="line">            LogUtils.d(<span class="string">"FBReader -&gt; openBook file exists: "</span> + file.exists());</span><br><span class="line">            <span class="keyword">if</span> (!file.exists()) &#123;</span><br><span class="line">                <span class="keyword">if</span> (file.getPhysicalFile() != <span class="keyword">null</span>) &#123;</span><br><span class="line">                    file = file.getPhysicalFile();</span><br><span class="line">                &#125;</span><br><span class="line">                UIUtil.showErrorMessage(<span class="keyword">this</span>, <span class="string">"fileNotFound"</span>, file.getPath());</span><br><span class="line">                myBook = <span class="keyword">null</span>;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">        <span class="comment">// 打开app 时 正常myBook为空 intent.getData 为空</span></span><br><span class="line">        <span class="comment">/*</span></span><br><span class="line"><span class="comment">        * 在主线程运行</span></span><br><span class="line"><span class="comment">		*</span></span><br><span class="line"><span class="comment">		* 正常打开时myBook， bookmark， action 三个参数都是空</span></span><br><span class="line"><span class="comment">		* */</span></span><br><span class="line">        Config.Instance().runOnConnect(<span class="keyword">new</span> Runnable() &#123;</span><br><span class="line">            <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">run</span><span class="params">()</span> </span>&#123;</span><br><span class="line">                LogUtils.d(<span class="string">"FBReader -&gt; openBook run thread: "</span> + Thread.currentThread());</span><br><span class="line">                LogUtils.d(<span class="string">"FBReader -&gt; openBook run myBook: "</span> + myBook);</span><br><span class="line">                LogUtils.d(<span class="string">"FBReader -&gt; openBook run bookmark: "</span> + bookmark);</span><br><span class="line">                LogUtils.d(<span class="string">"FBReader -&gt; openBook run action: "</span> + action);</span><br><span class="line">                myFBReaderApp.openBook(myBook, bookmark, action);</span><br><span class="line">                AndroidFontUtil.clearFontCache();</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;);</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>
<p>直接能跟到最后几行的 <strong>myFBReaderApp.openBook(myBook, bookmark, action);</strong> 这一句</p>
<p>log输出，这三个参数都是空的。执行了FBReaderApp的openBook方法</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">FBReaderApp::(Book book, <span class="keyword">final</span> Bookmark bookmark, Runnable postAction)</span><br></pre></td></tr></table></figure>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">openBook</span><span class="params">(Book book, <span class="keyword">final</span> Bookmark bookmark, Runnable postAction)</span> </span>&#123;</span><br><span class="line">		LogUtils.d(<span class="string">"FBReaderApp -&gt; openBook: "</span> + Model);</span><br><span class="line">		<span class="keyword">if</span> (Model != <span class="keyword">null</span>) &#123;</span><br><span class="line">			<span class="keyword">if</span> (book == <span class="keyword">null</span> || bookmark == <span class="keyword">null</span> &amp;&amp; book.File.equals(Model.Book.File)) &#123;</span><br><span class="line">				<span class="keyword">return</span>;</span><br><span class="line">			&#125;</span><br><span class="line">		&#125;</span><br><span class="line"></span><br><span class="line">		<span class="keyword">if</span> (book == <span class="keyword">null</span>) &#123;</span><br><span class="line">			book = getCurrentServerBook();</span><br><span class="line">			<span class="keyword">if</span> (book == <span class="keyword">null</span>) &#123;</span><br><span class="line">				showBookNotFoundMessage();</span><br><span class="line">				book = Collection.getRecentBook(<span class="number">0</span>);</span><br><span class="line">			&#125;</span><br><span class="line">			<span class="keyword">if</span> (book == <span class="keyword">null</span> || !book.File.exists()) &#123;</span><br><span class="line">				<span class="comment">// get helpfile</span></span><br><span class="line">				book = Collection.getBookByFile(BookUtil.getHelpFile());</span><br><span class="line">			&#125;</span><br><span class="line">			<span class="keyword">if</span> (book == <span class="keyword">null</span>) &#123;</span><br><span class="line">				<span class="keyword">return</span>;</span><br><span class="line">			&#125;</span><br><span class="line">		&#125;</span><br><span class="line">		<span class="keyword">final</span> Book bookToOpen = book;</span><br><span class="line">		bookToOpen.addLabel(Book.READ_LABEL);</span><br><span class="line">		Collection.saveBook(bookToOpen);</span><br><span class="line"></span><br><span class="line">		LogUtils.d(<span class="string">"FBReaderApp -&gt; openBook bookToOpen: "</span> + bookToOpen);</span><br><span class="line"></span><br><span class="line">		<span class="keyword">final</span> SynchronousExecutor executor = createExecutor(<span class="string">"loadingBook"</span>);</span><br><span class="line">		executor.execute(<span class="keyword">new</span> Runnable() &#123;</span><br><span class="line">			<span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">run</span><span class="params">()</span> </span>&#123;</span><br><span class="line">				openBookInternal(bookToOpen, bookmark, <span class="keyword">false</span>);</span><br><span class="line">			&#125;</span><br><span class="line">		&#125;, postAction);</span><br><span class="line">	&#125;</span><br></pre></td></tr></table></figure>
<p>三个参数，大体上能猜测出是什么意思，但是，并不是很清晰。<br>执行到getCurrentServerBook一句时，但我们第一次启动应用是，此时的book对象是空，即使是getCurrentServerBook执行完之后还是空的。之后便去找到这个帮助文档getHelpFile。 然后转化成book对象。<br>之后，貌似创建了线程。</p>
<p>SynchronousExecutor这个东西是个接口由<strong>ZLApplication:: createExecutor(String key)</strong> 创建</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">ZLApplication:: createExecutor(String key)</span><br></pre></td></tr></table></figure>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">protected</span> SynchronousExecutor <span class="title">createExecutor</span><span class="params">(String key)</span> </span>&#123;</span><br><span class="line">       <span class="keyword">if</span> (myWindow != <span class="keyword">null</span>) &#123;</span><br><span class="line">           <span class="keyword">return</span> myWindow.createExecutor(key);</span><br><span class="line">       &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">           <span class="keyword">return</span> myDummyExecutor;</span><br><span class="line">       &#125;</span><br><span class="line">   &#125;</span><br></pre></td></tr></table></figure>
<p>这里调用了myWindow的createExecutor方法，myWindow（ZLApplicationWindow）是 一个接口，FBReader实现了这个接口。<br>接着，调用了UIUtil的createExecutor方法</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">UIUtil::createExecutor(<span class="keyword">final</span> Activity activity, <span class="keyword">final</span> String key)</span><br></pre></td></tr></table></figure>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> ZLApplication.<span class="function">SynchronousExecutor <span class="title">createExecutor</span><span class="params">(<span class="keyword">final</span> Activity activity, <span class="keyword">final</span> String key)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">new</span> ZLApplication.SynchronousExecutor() &#123;</span><br><span class="line">        <span class="comment">// 获得相应的文字资源</span></span><br><span class="line">        <span class="keyword">private</span> <span class="keyword">final</span> ZLResource myResource =</span><br><span class="line">                ZLResource.resource(<span class="string">"dialog"</span>).getResource(<span class="string">"waitMessage"</span>);</span><br><span class="line">        <span class="keyword">private</span> <span class="keyword">final</span> String myMessage = myResource.getResource(key).getValue();</span><br><span class="line">        <span class="keyword">private</span> <span class="keyword">volatile</span> ProgressDialog myProgress;</span><br><span class="line"></span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">execute</span><span class="params">(<span class="keyword">final</span> Runnable action, <span class="keyword">final</span> Runnable uiPostAction)</span> </span>&#123;</span><br><span class="line">            activity.runOnUiThread(<span class="keyword">new</span> Runnable() &#123;</span><br><span class="line">                <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">run</span><span class="params">()</span> </span>&#123;</span><br><span class="line">                    <span class="comment">// 在ui线程中创建一个对话框</span></span><br><span class="line">                    myProgress = ProgressDialog.show(activity, <span class="keyword">null</span>, myMessage, <span class="keyword">true</span>, <span class="keyword">false</span>);</span><br><span class="line">                    <span class="comment">// 在线程中执行第一个参数</span></span><br><span class="line">                    <span class="keyword">final</span> Thread runner = <span class="keyword">new</span> Thread() &#123;</span><br><span class="line">                        <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">run</span><span class="params">()</span> </span>&#123;</span><br><span class="line">                            <span class="comment">// 在线程中运行第一个参数，也就是打开图书（在）</span></span><br><span class="line">                            action.run();</span><br><span class="line">                            <span class="comment">// 执行完之后，关闭这个对话框</span></span><br><span class="line">                            activity.runOnUiThread(<span class="keyword">new</span> Runnable() &#123;</span><br><span class="line">                                <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">run</span><span class="params">()</span> </span>&#123;</span><br><span class="line">                                    <span class="keyword">try</span> &#123;</span><br><span class="line">                                        myProgress.dismiss();</span><br><span class="line">                                        myProgress = <span class="keyword">null</span>;</span><br><span class="line">                                    &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">                                        e.printStackTrace();</span><br><span class="line">                                    &#125;</span><br><span class="line">                                    <span class="keyword">if</span> (uiPostAction != <span class="keyword">null</span>) &#123;</span><br><span class="line">                                        uiPostAction.run();</span><br><span class="line">                                    &#125;</span><br><span class="line">                                &#125;</span><br><span class="line">                            &#125;);</span><br><span class="line">                        &#125;</span><br><span class="line">                    &#125;;</span><br><span class="line">                    runner.setPriority(Thread.MAX_PRIORITY);</span><br><span class="line">                    runner.start();</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">setMessage</span><span class="params">(<span class="keyword">final</span> ProgressDialog progress, <span class="keyword">final</span> String message)</span> </span>&#123;</span><br><span class="line">            <span class="keyword">if</span> (progress == <span class="keyword">null</span>) &#123;</span><br><span class="line">                <span class="keyword">return</span>;</span><br><span class="line">            &#125;</span><br><span class="line">            activity.runOnUiThread(<span class="keyword">new</span> Runnable() &#123;</span><br><span class="line">                <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">run</span><span class="params">()</span> </span>&#123;</span><br><span class="line">                    progress.setMessage(message);</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">executeAux</span><span class="params">(String key, Runnable runnable)</span> </span>&#123;</span><br><span class="line">            setMessage(myProgress, myResource.getResource(key).getValue());</span><br><span class="line">            runnable.run();</span><br><span class="line">            setMessage(myProgress, myMessage);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>主要看execute方法，这里先显示一个进度框，然后执行第一个参数<strong>action</strong>，然后关闭进度框，这个action 就是在 <strong>FBReaderApp::openBook(Book book, final Bookmark bookmark, Runnable postAction)</strong>中的</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">FBReaderApp::openBookInternal(bookToOpen, bookmark, <span class="keyword">false</span>);</span><br></pre></td></tr></table></figure>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 打开内部的图书</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">synchronized</span> <span class="keyword">void</span> <span class="title">openBookInternal</span><span class="params">(Book book, Bookmark bookmark, <span class="keyword">boolean</span> force)</span> </span>&#123;</span><br><span class="line">    <span class="comment">// 可能是跳转书签, 书签为空</span></span><br><span class="line">    LogUtils.d(<span class="string">"FBReaderApp -&gt; openBookInternal bookmark: "</span> + bookmark);</span><br><span class="line">    <span class="keyword">if</span> (!force &amp;&amp; Model != <span class="keyword">null</span> &amp;&amp; book.equals(Model.Book)) &#123;</span><br><span class="line">        <span class="keyword">if</span> (bookmark != <span class="keyword">null</span>) &#123;</span><br><span class="line">            gotoBookmark(bookmark, <span class="keyword">false</span>);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    onViewChanged();</span><br><span class="line">    storePosition();</span><br><span class="line"></span><br><span class="line">    BookTextView.setModel(<span class="keyword">null</span>);</span><br><span class="line">    FootnoteView.setModel(<span class="keyword">null</span>);</span><br><span class="line">    clearTextCaches();</span><br><span class="line">    Model = <span class="keyword">null</span>;</span><br><span class="line">    ExternalBook = <span class="keyword">null</span>;</span><br><span class="line">    System.gc();</span><br><span class="line">    System.gc();</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 猜测是根据book，加载一个用来读取这个book的插件</span></span><br><span class="line">    <span class="keyword">final</span> FormatPlugin plugin = book.getPluginOrNull();</span><br><span class="line">    <span class="comment">// 此时，阅读默认帮助文档时，插件为fb2</span></span><br><span class="line">    LogUtils.d(<span class="string">"FBReaderApp -&gt; openBookInternal plugin: "</span> + plugin);</span><br><span class="line">    <span class="keyword">if</span> (plugin <span class="keyword">instanceof</span> ExternalFormatPlugin) &#123;</span><br><span class="line">        ExternalBook = book;</span><br><span class="line">        <span class="keyword">final</span> Bookmark bm;</span><br><span class="line">        <span class="keyword">if</span> (bookmark != <span class="keyword">null</span>) &#123;</span><br><span class="line">            bm = bookmark;</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            ZLTextPosition pos = getStoredPosition(book);</span><br><span class="line">            <span class="keyword">if</span> (pos == <span class="keyword">null</span>) &#123;</span><br><span class="line">                pos = <span class="keyword">new</span> ZLTextFixedPosition(<span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>);</span><br><span class="line">            &#125;</span><br><span class="line">            bm = <span class="keyword">new</span> Bookmark(book, <span class="string">""</span>, pos, pos, <span class="string">""</span>, <span class="keyword">false</span>);</span><br><span class="line">        &#125;</span><br><span class="line">        myExternalFileOpener.openFile((ExternalFormatPlugin) plugin, book, bm);</span><br><span class="line">        <span class="keyword">return</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        <span class="comment">// 创建一个BookModel， 通过判断插件的type</span></span><br><span class="line">        Model = BookModel.createModel(book);</span><br><span class="line">        <span class="comment">// BookCollectionShadow 暂时不懂</span></span><br><span class="line">        Collection.saveBook(book);</span><br><span class="line">        ZLTextHyphenator.Instance().load(book.getLanguage());</span><br><span class="line">        <span class="comment">// 设置显示时的一些属性</span></span><br><span class="line">        BookTextView.setModel(Model.getTextModel());</span><br><span class="line">        setBookmarkHighlightings(BookTextView, <span class="keyword">null</span>);</span><br><span class="line">        gotoStoredPosition();</span><br><span class="line">        <span class="keyword">if</span> (bookmark == <span class="keyword">null</span>) &#123;</span><br><span class="line">            setView(BookTextView);</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            gotoBookmark(bookmark, <span class="keyword">false</span>);</span><br><span class="line">        &#125;</span><br><span class="line">        Collection.addBookToRecentList(book);</span><br><span class="line">        <span class="keyword">final</span> StringBuilder title = <span class="keyword">new</span> StringBuilder(book.getTitle());</span><br><span class="line">        <span class="keyword">if</span> (!book.authors().isEmpty()) &#123;</span><br><span class="line">            <span class="keyword">boolean</span> first = <span class="keyword">true</span>;</span><br><span class="line">            <span class="keyword">for</span> (Author a : book.authors()) &#123;</span><br><span class="line">                title.append(first ? <span class="string">" ("</span> : <span class="string">", "</span>);</span><br><span class="line">                title.append(a.DisplayName);</span><br><span class="line">                first = <span class="keyword">false</span>;</span><br><span class="line">            &#125;</span><br><span class="line">            title.append(<span class="string">")"</span>);</span><br><span class="line">        &#125;</span><br><span class="line">        setTitle(title.toString());</span><br><span class="line">    &#125; <span class="keyword">catch</span> (BookReadingException e) &#123;</span><br><span class="line">        processException(e);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    getViewWidget().reset();</span><br><span class="line">    getViewWidget().repaint();</span><br><span class="line"></span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        <span class="keyword">for</span> (FileEncryptionInfo info : book.getPlugin().readEncryptionInfos(book)) &#123;</span><br><span class="line">            <span class="keyword">if</span> (info != <span class="keyword">null</span> &amp;&amp; !EncryptionMethod.isSupported(info.Method)) &#123;</span><br><span class="line">                showErrorMessage(<span class="string">"unsupportedEncryptionMethod"</span>, book.File.getPath());</span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125; <span class="keyword">catch</span> (BookReadingException e) &#123;</span><br><span class="line">        <span class="comment">// ignore</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>目前能读懂的都在注释上，貌似在执行 <strong>setView(BookTextView)</strong>时，就会进行渲染的操作了</p>
<p>把帮助文档当成图书的话， 第一次出现对书的解析应该就是在BookUtil的getHelpFile的方法中</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">BookUtil::getHelpFile()</span><br></pre></td></tr></table></figure>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">static</span> ZLResourceFile <span class="title">getHelpFile</span><span class="params">()</span> </span>&#123;</span><br><span class="line">		<span class="keyword">final</span> Locale locale = Locale.getDefault();</span><br><span class="line">		<span class="comment">// 获取local，取得帮助文档</span></span><br><span class="line">		ZLResourceFile file = ZLResourceFile.createResourceFile(</span><br><span class="line">			<span class="string">"data/help/MiniHelp."</span> + locale.getLanguage() + <span class="string">"_"</span> + locale.getCountry() + <span class="string">".fb2"</span></span><br><span class="line">		);</span><br><span class="line">		<span class="keyword">if</span> (file.exists()) &#123;</span><br><span class="line">			<span class="keyword">return</span> file;</span><br><span class="line">		&#125;</span><br><span class="line"></span><br><span class="line">		file = ZLResourceFile.createResourceFile(</span><br><span class="line">			<span class="string">"data/help/MiniHelp."</span> + locale.getLanguage() + <span class="string">".fb2"</span></span><br><span class="line">		);</span><br><span class="line">		<span class="keyword">if</span> (file.exists()) &#123;</span><br><span class="line">			<span class="keyword">return</span> file;</span><br><span class="line">		&#125;</span><br><span class="line"></span><br><span class="line">		<span class="keyword">return</span> ZLResourceFile.createResourceFile(<span class="string">"data/help/MiniHelp.en.fb2"</span>);</span><br><span class="line">	&#125;</span><br></pre></td></tr></table></figure>
<p>通过固定的路径，调用了ZLResourceFile 的 createResourceFile</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">ZLResourceFile :: createResourceFile(String path)</span><br></pre></td></tr></table></figure>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">static</span> ZLResourceFile <span class="title">createResourceFile</span><span class="params">(String path)</span> </span>&#123;</span><br><span class="line">	ZLResourceFile file = ourCache.get(path);</span><br><span class="line">	<span class="keyword">if</span> (file == <span class="keyword">null</span>) &#123;</span><br><span class="line">		file = ZLibrary.Instance().createResourceFile(path);</span><br><span class="line">		ourCache.put(path, file);</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">return</span> file;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>这里有个简单的缓存，然后调用了ZLibrary的createResourceFile方法。ZLibrary是个抽象类，ZLAndroidLibrary 实现了它， 并在application中进行了初始化操作。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">ZLAndroidLibrary::createResourceFile(String path)</span><br></pre></td></tr></table></figure>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Override</span></span><br><span class="line">  <span class="function"><span class="keyword">public</span> ZLResourceFile <span class="title">createResourceFile</span><span class="params">(String path)</span> </span>&#123;</span><br><span class="line">      <span class="keyword">return</span> <span class="keyword">new</span> AndroidAssetsFile(path);</span><br><span class="line">  &#125;</span><br></pre></td></tr></table></figure>
<p>这里，通过文件的路径，创建了一个AndroidAssetsFile。AndroidAssetsFile继承了ZLResourceFile，是ZLFile的子类。</p>
<p><img src="http://upload-images.jianshu.io/upload_images/1285832-9f467aaa18ed9b94.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240" alt=""></p>
<p>ZLFile 是fbreader对所有文件的同意描述。上图是继承树。</p>
<p>以下是从网络上摘取的资料</p>
<ul>
<li><p>ResourceFile类专门用来处理资源文件，这一章中要解析的assets文件夹下的资源文件都可以ZLResourceFile类来处理</p>
</li>
<li><p>ZLResourceFile类专门用来处理资源文件，这一章中要解析的assets文件夹下的资源文件都可以ZLResourceFile类来处理。</p>
</li>
<li><p>ZLPhysicalFile类专门用来处理普通文件，eoub文件就可以用一个ZLPhysicalFile类来代表。</p>
</li>
<li><p>ZLZipEntryFile类用来处理epub文件内部的xml文件，这个类会在第五章“epub文件处理 – 解压epub文件”中出现。</p>
</li>
</ul>
<p>这三个文件类都实现了getInputStream抽象方法，不用的文件类会通过这个方法获得针对当前文件类的字节流类。</p>
<p>AndroidAssetsFile类（ZLResourceFile类的子类）的getInputStream方法会返回AssetInputStream类，这个类可以将资源文件转换成byte数组。</p>
<p>ZLPhysicalFile类的getInputStream方法会返回FileInputStream类，这个类可以将普通的文件转换成byte数组。</p>
<p>ZLZipEntryFile类的getInputStream方法会返回FileInputStream类，这个类可以将epub内部压缩过的xml文件转换成可以正常解析的byte数组</p>
<p>下面看一下AndroidAssetsFile的getInputStream方法。可以猜测，读取帮助文档的时候调用getInputStream会返回这个文件的InputStream</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">AndroidAssetsFile:: getInputStream()</span><br></pre></td></tr></table></figure>
<figure class="highlight aspectj"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"> <span class="meta">@Override</span></span><br><span class="line"><span class="keyword">public</span> <span class="function">InputStream <span class="title">getInputStream</span><span class="params">()</span> <span class="keyword">throws</span> IOException </span>&#123;</span><br><span class="line">     <span class="keyword">return</span> myApplication.getAssets().open(getPath());</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>得到ZLResourceFile 对象之后，我们回到<strong>FBReaderApp::openBook</strong> 这个方法中。<br>可以看到通过</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">book = Collection.getBookByFile(BookUtil.getHelpFile());</span><br></pre></td></tr></table></figure>
<p>将ZLResourceFile对象转成了Book 对象了。<br>Collection是一个接口IBookCollection， 这里是BookCollectionShadow实现了这个接口，在FBReaderApp的onCreate方法，我们可以看到这句</p>
<p><img src="http://upload-images.jianshu.io/upload_images/1285832-0f11ada01dfdcc4e.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240" alt=""></p>
<p>BookCollectionShadow又是什么呢？我们还要往下分析</p>
<p>上面的代码中创建了一个FBReaderApp对象， 至于这个对象是干什么的，现在还不知道。<br>接下来，getCollection 并 调用了 bindToService方法</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">FBReader::getCollection()</span><br></pre></td></tr></table></figure>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">private</span> BookCollectionShadow <span class="title">getCollection</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> (BookCollectionShadow) myFBReaderApp.Collection;</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>
<p>调用的正是这个主activity的一个方法。返回的对象是FBReaderApp 的 Collection变量，这个正式刚才创建的BookCollectionShadow 实现了IBookCollection接口。</p>
<p>接着调用了BookCollectionShadow的bindToService方法</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">BookCollectionShadow::bindToService(Context context, Runnable onBindAction)</span><br></pre></td></tr></table></figure>
<figure class="highlight verilog"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line">public synchronized <span class="keyword">void</span> bindToService(Context <span class="keyword">context</span>, Runnable onBindAction) &#123;</span><br><span class="line">       <span class="keyword">if</span> (myInterface != <span class="literal">null</span> &amp;&amp; myContext == <span class="keyword">context</span>) &#123;</span><br><span class="line">		<span class="comment">// not first connect</span></span><br><span class="line">		<span class="keyword">if</span> (onBindAction != <span class="literal">null</span>) &#123;</span><br><span class="line">			Config<span class="variable">.Instance</span>()<span class="variable">.runOnConnect</span>(onBindAction);</span><br><span class="line">		&#125;</span><br><span class="line">	&#125; <span class="keyword">else</span> &#123;</span><br><span class="line">		<span class="comment">// first connect</span></span><br><span class="line">		<span class="keyword">if</span> (onBindAction != <span class="literal">null</span>) &#123;</span><br><span class="line">			myOnBindActions<span class="variable">.add</span>(onBindAction);</span><br><span class="line">		&#125;</span><br><span class="line">		<span class="keyword">context</span><span class="variable">.bindService</span>(</span><br><span class="line">			FBReaderIntents<span class="variable">.internalIntent</span>(FBReaderIntents<span class="variable">.Action</span><span class="variable">.LIBRARY_SERVICE</span>),</span><br><span class="line">			<span class="keyword">this</span>,</span><br><span class="line">			LibraryService<span class="variable">.BIND_AUTO_CREATE</span></span><br><span class="line">		);</span><br><span class="line">		myContext = <span class="keyword">context</span>;</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>这里执行了一句很熟悉的<strong>context.bindService</strong>方法，这里用到了aidl。这方面的问题就不记录了，跟主向无关。<br>bindService方法有三个参数，第二个参数传了BookCollectionShadow本身， 我们知道，bindService的第二个参数传的是ServiceConnection接口，在这里面， 我们可以调用aidl文件生命的方法，进行跨进程的通讯。也不知道fbreader为什么弄这么多进程是想干什么。</p>
<p><img src="http://upload-images.jianshu.io/upload_images/1285832-c99fa50150a7cae8.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240" alt=""></p>
<p>果然BookCollectionShadow实现了ServiceConnection，并且myInterface真是那个aidl的全局变量， 我们可以通过它，完成与服务端的沟通。</p>
<hr>
<h2 id="四、怎样获得book对象"><a href="#四、怎样获得book对象" class="headerlink" title="四、怎样获得book对象"></a>四、怎样获得book对象</h2><p>经过一下午的瞎看，大致的熟悉了一下fbreader的源码。</p>
<p>带着问题学习总是最快的，那么，fbreader到底是怎样解析epub文件的呢。我们得找一个入口。在项目中，长按菜单键，会弹出一个功能列表，会看到一个本地书柜，一顿操作之后，我们可以找到一个我事先导入的一个电子书</p>
<p><img src="http://upload-images.jianshu.io/upload_images/1285832-536bb4e37ccc3d4d.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240" alt=""></p>
<p>最后我们会来到这个界面</p>
<p><img src="http://upload-images.jianshu.io/upload_images/1285832-fce1a35e1d34fcca.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240" alt=""></p>
<p>在茫茫码海中怎么找到这个activity，用这样一条命令<br><figure class="highlight coq"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">adb shell dumpsys activity <span class="built_in">top</span> | <span class="type">grep</span> ACTIVITY --color</span><br></pre></td></tr></table></figure></p>
<p><img src="http://upload-images.jianshu.io/upload_images/1285832-61bf63d9a9c654d6.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240" alt=""></p>
<p>在这个activitiy中， mybook是通过intent传入的，所以找上个页面<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">![](http://upload-images.jianshu.io/upload_images/1285832-748d5e53cba5441a.png)</span><br><span class="line"></span><br><span class="line">ListActivity是什么？ 没用过，TreeActivity自己写的， 太复杂。想着在LibraryActivity中能找到一些方法</span><br></pre></td></tr></table></figure></p>
<p>LibraryActivity::onListItemClick(ListView listView, View view, int position, long rowId)<br><figure class="highlight aspectj"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">```</span><br><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="keyword">protected</span> <span class="function"><span class="keyword">void</span> <span class="title">onListItemClick</span><span class="params">(ListView listView, View view, <span class="keyword">int</span> position, <span class="keyword">long</span> rowId)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">final</span> LibraryTree tree = (LibraryTree)getListAdapter().getItem(position);</span><br><span class="line">    <span class="keyword">final</span> Book book = tree.getBook();</span><br><span class="line">    LogUtils.d(<span class="string">"LibraryActivity -&gt; onListItemClick book: "</span> + book);</span><br><span class="line">    <span class="keyword">if</span> (book != <span class="keyword">null</span>) &#123;</span><br><span class="line">        showBookInfo(book);</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        openTree(tree);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>在这个方法中， 是通过<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">```</span><br><span class="line">public Book getBook() &#123;</span><br><span class="line">	return null;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>这尼玛返回空！！！<br> tree是LibraryTree的一个实例，在TreeAdapter的getItem(int position) 方法中得到的<br><figure class="highlight arduino"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> FBTree getItem(<span class="keyword">int</span> <span class="built_in">position</span>) &#123;</span><br><span class="line">	<span class="built_in">return</span> myItems.<span class="built_in">get</span>(<span class="built_in">position</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>存放在了叫<figure class="highlight plain"><figcaption><span>final List<fbtree> myItems;```这样的一个list之中。</fbtree></span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">一路尾随，不是跟踪myItems， 看一下TreeAdapter的replaceAll方法</span><br><span class="line"></span><br><span class="line">![](http://upload-images.jianshu.io/upload_images/1285832-34f72c5912915c2c.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240)</span><br><span class="line"></span><br><span class="line">根据名字我们能判断。得到现在树的子树，然后添加到myItem中去的。那么我们知道现在的树， 或者现在树的子树是什么，应该就可以得到答案了。</span><br><span class="line"></span><br><span class="line">现在的树集成关系是这样的</span><br><span class="line">![](http://upload-images.jianshu.io/upload_images/1285832-5bb780b3dd24cca2.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240)</span><br><span class="line"></span><br><span class="line">又在onListItemClick方法中强装成LibraryTree， 我们只需关注LibraryTree的之类就行了</span><br><span class="line"></span><br><span class="line">这个树通过getTreeByKey得到</span><br></pre></td></tr></table></figure></p>
<p>LibraryActivity::getTreeByKey(FBTree.Key key)<br><figure class="highlight aspectj"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">```</span><br><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="keyword">protected</span> <span class="function">LibraryTree <span class="title">getTreeByKey</span><span class="params">(FBTree.Key key)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">return</span> key != <span class="keyword">null</span> ? myRootTree.getLibraryTree(key) : myRootTree;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">private</span> <span class="keyword">synchronized</span> <span class="function"><span class="keyword">void</span> <span class="title">deleteRootTree</span><span class="params">()</span> </span>&#123;</span><br></pre></td></tr></table></figure></p>
<p>最后我们要找的这棵树实际跟<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">myRootTree在onCreate的时候创建</span><br></pre></td></tr></table></figure></p>
<p>LibraryActivity::onCreate(Bundle icicle)<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"></span><br></pre></td></tr></table></figure></p>
<p>@Override<br>protected void onCreate(Bundle icicle) {<br>    super.onCreate(icicle);<br>    Log.d(TAG, “start onCreate function: “);<br>    mySelectedBook = FBReaderIntents.getBookExtra(getIntent());<br>    new LibraryTreeAdapter(this);<br>    getListView().setTextFilterEnabled(true);<br>    getListView().setOnCreateContextMenuListener(this);<br>    deleteRootTree();<br>    myCollection.bindToService(this, new Runnable() {<br>        public void run() {<br>            setProgressBarIndeterminateVisibility(!myCollection.status().IsCompleted);<br>            myRootTree = new RootTree(myCollection);<br>            myCollection.addListener(LibraryActivity.this);<br>            init(getIntent());<br>        }<br>    });<br>}<br><figure class="highlight clean"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">在倒数第二行add的接口的回掉在这里</span><br><span class="line"></span><br><span class="line">![](http:<span class="comment">//upload-images.jianshu.io/upload_images/1285832-60b8eb000aceeeb5.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240)</span></span><br><span class="line">在```onBookEvent中一定是这个树的来源```，看来我们要去另一个进程里看看了</span><br><span class="line"></span><br><span class="line">这个服务和之前的一样LibraryService。我们跟进LibraryService</span><br></pre></td></tr></table></figure></p>
<p>@Override<br>public IBinder onBind(Intent intent) {<br>    return myLibrary;<br>}<br><figure class="highlight less"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">返回的真是<span class="selector-tag">aidl</span>的一个接口</span><br><span class="line"></span><br><span class="line">!<span class="selector-attr">[]</span>(<span class="attribute">http</span>:<span class="comment">//upload-images.jianshu.io/upload_images/1285832-89620d920299568d.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240)</span></span><br><span class="line"></span><br><span class="line">以上是接口创建的一部分代码</span><br><span class="line"></span><br><span class="line">![](<span class="attribute">http</span>:<span class="comment">//upload-images.jianshu.io/upload_images/1285832-1c0cd3f0f572740c.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240)</span></span><br><span class="line"></span><br><span class="line">在reset中搞了一个Config.Instance().runOnConnect不知道是干嘛用的，反正是调用了以下的方法</span><br><span class="line"></span><br><span class="line">![](<span class="attribute">http</span>:<span class="comment">//upload-images.jianshu.io/upload_images/1285832-a28e8fafc6062a50.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240)</span></span><br><span class="line"></span><br><span class="line">我注意到底下的两个广播，很明显是做进程间通讯。然后， 我在BookCollectionShadow中找到了这个广播的接收者</span><br></pre></td></tr></table></figure></p>
<p>private final BroadcastReceiver myReceiver = new BroadcastReceiver() {<br>    public void onReceive(Context context, Intent intent) {<br>        if (!hasListeners()) {<br>            return;<br>        }<br>        try {<br>            final String type = intent.getStringExtra(“type”);<br>            LogUtils.d(“BookCollectionShadow -&gt; onReceive type: “ + type);<br>            if (LibraryService.BOOK_EVENT_ACTION.equals(intent.getAction())) {<br>                final Book book = SerializerUtil.deserializeBook(intent.getStringExtra(“book”));<br>                fireBookEvent(BookEvent.valueOf(type), book);<br>            } else {<br>                fireBuildEvent(Status.valueOf(type));<br>            }<br>        } catch (Exception e) {<br>            // ignore<br>        }<br>    }<br>};<br><figure class="highlight clean"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">接下来看log</span><br><span class="line"></span><br><span class="line">![](http:<span class="comment">//upload-images.jianshu.io/upload_images/1285832-06ada923f3db31b6.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240)</span></span><br><span class="line">通过这个&lt;entry xmlns:dc=<span class="string">"http://purl.org/dc/elements/1.1/"</span> xmlns:calibre=<span class="string">"http://calibre.kovidgoyal.net/2009/metadata"</span>&gt; 搞成一本书？？？</span><br><span class="line"></span><br><span class="line">这个先别管，我的疑惑是tree.getBook() 怎么返回空？</span><br><span class="line"></span><br><span class="line">经过上面的弯路， 我们知道了最后回掉的是```LibraryActivity:: onBookEvent(BookEvent event, Book book)```这个方法</span><br></pre></td></tr></table></figure></p>
<p>@Override<br>public void onBookEvent(BookEvent event, Book book) {<br>    if (getCurrentTree().onBookEvent(event, book)) {<br>        getListAdapter().replaceAll(getCurrentTree().subtrees(), true);<br>    }<br>}<br><figure class="highlight groovy"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">再跟一下里面的方法</span><br><span class="line"></span><br><span class="line">```java</span><br><span class="line"><span class="keyword">public</span> <span class="keyword">boolean</span> onBookEvent(BookEvent event, Book book) &#123;</span><br><span class="line">	<span class="keyword">switch</span> (event) &#123;</span><br><span class="line"><span class="symbol">		default:</span></span><br><span class="line">		<span class="keyword">case</span> <span class="string">Added:</span></span><br><span class="line">			<span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">		<span class="keyword">case</span> <span class="string">Removed:</span></span><br><span class="line">			<span class="keyword">return</span> removeBook(book);</span><br><span class="line">		<span class="keyword">case</span> <span class="string">Updated:</span></span><br><span class="line">		&#123;</span><br><span class="line">			<span class="keyword">boolean</span> changed = <span class="literal">false</span>;</span><br><span class="line">			<span class="keyword">for</span> (FBTree <span class="string">tree :</span> <span class="keyword">this</span>) &#123;</span><br><span class="line">				<span class="keyword">if</span> (tree <span class="keyword">instanceof</span> BookTree) &#123;</span><br><span class="line">					<span class="keyword">final</span> Book b = ((BookTree)tree).Book;</span><br><span class="line">					<span class="keyword">if</span> (b.equals(book)) &#123;</span><br><span class="line">						b.updateFrom(book);</span><br><span class="line">						changed = <span class="literal">true</span>;</span><br><span class="line">					&#125;</span><br><span class="line">				&#125;</span><br><span class="line">			&#125;</span><br><span class="line">			<span class="keyword">return</span> changed;</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>我们看到了booktree这个东西，原来我们正经使用的是booktree的getBook，所以get得到的肯定是一本书</p>
<h3 id="这里留一个问题，-这个booktree是怎么来的？-先不着急分析他"><a href="#这里留一个问题，-这个booktree是怎么来的？-先不着急分析他" class="headerlink" title="这里留一个问题， 这个booktree是怎么来的？ 先不着急分析他"></a>这里留一个问题， 这个booktree是怎么来的？ 先不着急分析他</h3><p>我们发现book 是从booktree 得到的， 而booktree中的book 是构造是传进来的。</p>
<p>而这些又是在FilteredTree的抽象发方法createSubtree， 得到的</p>
<p><img src="http://upload-images.jianshu.io/upload_images/1285832-8ba92e761ff95a45.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240" alt=""></p>
<p>接着往上看FilteredTree这个类<br><img src="http://upload-images.jianshu.io/upload_images/1285832-494b2e8a2f176862.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240" alt=""></p>
<p>终于找到主进程里的book了， 原来是调用进程里的 Collection.books(query);方法， 来获得一个book的列表。</p>
<h2 id="五、怎么跳转到Fbreader这个activity"><a href="#五、怎么跳转到Fbreader这个activity" class="headerlink" title="五、怎么跳转到Fbreader这个activity"></a>五、怎么跳转到Fbreader这个activity</h2><p>本来想看看怎么解析epub的，但是感觉目前还消化不了。</p>
<p>我们要把这个完整的项目当成一个sdk来使用，虽然说整个加到工程中fbreader的5M左右了，但是没有办法，时间紧任务重。我倒是很赞同自己去写个阅读器，但是条件不允许。</p>
<p>我们要使用这个项目， 就得找到一个书， 然后跳转到这个activity让他显示。</p>
<p>经过以上的分析， 可以看到，在查找书的时候 已经就装成book对象了。反正要是我写，我肯定在查找文件的时候返回的url， 然后根据这个去解析成book的对象。</p>
<p>记得最早之前分析过，在FBReader的onResume是启动的关键<br><figure class="highlight gradle"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">private</span> <span class="keyword">synchronized</span> <span class="keyword">void</span> openBook(Intent intent, <span class="keyword">final</span> Runnable action, <span class="keyword">boolean</span> force) &#123;</span><br><span class="line">        <span class="keyword">if</span> (!force &amp;&amp; myBook != <span class="keyword">null</span>) &#123;</span><br><span class="line">            <span class="keyword">return</span>;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        myBook = FBReaderIntents.getBookExtra(intent);</span><br><span class="line">        <span class="keyword">final</span> Bookmark bookmark = FBReaderIntents.getBookmarkExtra(intent);</span><br><span class="line">        LogUtils.d(<span class="string">"FBReader -&gt; openBook myBook: "</span> + myBook);</span><br><span class="line">        <span class="keyword">if</span> (myBook == <span class="keyword">null</span>) &#123;</span><br><span class="line">            <span class="keyword">final</span> Uri data = intent.getData();</span><br><span class="line">            LogUtils.d(<span class="string">"FBReader -&gt; openBook data: "</span> + data);</span><br><span class="line">            <span class="keyword">if</span> (data != <span class="keyword">null</span>) &#123;</span><br><span class="line">                myBook = createBookForFile(ZLFile.createFileByPath(data.getPath()));</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">if</span> (myBook != <span class="keyword">null</span>) &#123;</span><br><span class="line">            ZLFile <span class="keyword">file</span> = myBook.<span class="keyword">File</span>;</span><br><span class="line">            LogUtils.d(<span class="string">"FBReader -&gt; openBook file path: "</span> + <span class="keyword">file</span>.getPath());</span><br><span class="line">            LogUtils.d(<span class="string">"FBReader -&gt; openBook file exists: "</span> + <span class="keyword">file</span>.exists());</span><br><span class="line">            <span class="keyword">if</span> (!<span class="keyword">file</span>.exists()) &#123;</span><br><span class="line">                <span class="keyword">if</span> (<span class="keyword">file</span>.getPhysicalFile() != <span class="keyword">null</span>) &#123;</span><br><span class="line">                    <span class="keyword">file</span> = <span class="keyword">file</span>.getPhysicalFile();</span><br><span class="line">                &#125;</span><br><span class="line">                UIUtil.showErrorMessage(<span class="keyword">this</span>, <span class="string">"fileNotFound"</span>, <span class="keyword">file</span>.getPath());</span><br><span class="line">                myBook = <span class="keyword">null</span>;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br></pre></td></tr></table></figure></p>
<p>这里，但书为空的时时候，在intent.getData去 拿到url， 传到ZLFile里去。也就是说，我在start这个activity 传一个url 进去， 于是我这样写了一段<br><figure class="highlight aspectj"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 打开一本电子书</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> context 上下文</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> path    epub 资源的绝对路径</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> <span class="function"><span class="keyword">void</span> <span class="title">openBookActivity</span><span class="params">(Context context, String path)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">final</span> Intent intent = <span class="keyword">new</span> Intent(context, FBReader.class)</span><br><span class="line">            .setAction(FBReaderIntents.Action.VIEW)</span><br><span class="line">            .addFlags(Intent.FLAG_ACTIVITY_CLEAR_TOP);</span><br><span class="line">    intent.setData(Uri.parse(path));</span><br><span class="line">    context.startActivity(intent);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>这样就可以了。 我翻了几页之后， 默认就会保存阅读的位置。那么我想重新阅读这个文章应该怎么办。继续撸代码</p>
<p>在<figure class="highlight plain"><figcaption><span>book, Bookmark bookmark, boolean force)```方法中，第一次打开书是会执行```gotoStoredPosition();```这样一个方法，从字面的意思是去到存储的位置</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">具体的方法是这样的</span><br></pre></td></tr></table></figure></p>
<p>FBReaderApp::gotoStoredPosition()<br><figure class="highlight aspectj"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">```</span><br><span class="line"><span class="keyword">private</span> <span class="function"><span class="keyword">void</span> <span class="title">gotoStoredPosition</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    myStoredPositionBook = Model != <span class="keyword">null</span> ? Model.Book : <span class="keyword">null</span>;</span><br><span class="line">    <span class="keyword">if</span> (myStoredPositionBook == <span class="keyword">null</span>) &#123;</span><br><span class="line">        <span class="keyword">return</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    myStoredPosition = getStoredPosition(myStoredPositionBook);</span><br><span class="line">    BookTextView.gotoPosition(myStoredPosition);</span><br><span class="line">    savePosition();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>是调用了BookTextView的gotoPosition这个方法。那我们看看能否在FBReader这个类上搞点事情。在openBook方法中<br><figure class="highlight gradle"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">private</span> <span class="keyword">synchronized</span> <span class="keyword">void</span> openBook(Intent intent, <span class="keyword">final</span> Runnable action, <span class="keyword">boolean</span> force) &#123;</span><br><span class="line">       <span class="keyword">if</span> (!force &amp;&amp; myBook != <span class="keyword">null</span>) &#123;</span><br><span class="line">           <span class="keyword">return</span>;</span><br><span class="line">       &#125;</span><br><span class="line"></span><br><span class="line">       myBook = FBReaderIntents.getBookExtra(intent);</span><br><span class="line">       <span class="keyword">final</span> Bookmark bookmark = FBReaderIntents.getBookmarkExtra(intent);</span><br><span class="line">       LogUtils.d(<span class="string">"FBReader -&gt; openBook myBook: "</span> + myBook);</span><br><span class="line">       <span class="keyword">if</span> (myBook == <span class="keyword">null</span>) &#123;</span><br><span class="line">           <span class="keyword">final</span> Uri data = intent.getData();</span><br><span class="line">           LogUtils.d(<span class="string">"FBReader -&gt; openBook data: "</span> + data);</span><br><span class="line">           <span class="keyword">if</span> (data != <span class="keyword">null</span>) &#123;</span><br><span class="line">               myBook = createBookForFile(ZLFile.createFileByPath(data.getPath()));</span><br><span class="line">           &#125;</span><br><span class="line">       &#125;</span><br><span class="line"></span><br><span class="line">       LogUtils.d(<span class="string">"FBReader -&gt; openBook mybook: "</span> + myBook);</span><br><span class="line">       <span class="keyword">if</span> (myBook != <span class="keyword">null</span>) &#123;</span><br><span class="line">           ZLFile <span class="keyword">file</span> = myBook.<span class="keyword">File</span>;</span><br><span class="line">           LogUtils.d(<span class="string">"FBReader -&gt; openBook file path: "</span> + <span class="keyword">file</span>.getPath());</span><br><span class="line">           LogUtils.d(<span class="string">"FBReader -&gt; openBook file exists: "</span> + <span class="keyword">file</span>.exists());</span><br><span class="line">           <span class="keyword">if</span> (!<span class="keyword">file</span>.exists()) &#123;</span><br><span class="line">               <span class="keyword">if</span> (<span class="keyword">file</span>.getPhysicalFile() != <span class="keyword">null</span>) &#123;</span><br><span class="line">                   <span class="keyword">file</span> = <span class="keyword">file</span>.getPhysicalFile();</span><br><span class="line">               &#125;</span><br><span class="line">               UIUtil.showErrorMessage(<span class="keyword">this</span>, <span class="string">"fileNotFound"</span>, <span class="keyword">file</span>.getPath());</span><br><span class="line">               myBook = <span class="keyword">null</span>;</span><br><span class="line">           &#125;</span><br><span class="line">       &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">       <span class="comment">// 打开app 时 正常myBook为空 intent.getData 为空</span></span><br><span class="line">       <span class="comment">/*</span></span><br><span class="line"><span class="comment">       * 在主线程运行</span></span><br><span class="line"><span class="comment">	*</span></span><br><span class="line"><span class="comment">	* 正常打开时myBook， bookmark， action 三个参数都是空</span></span><br><span class="line"><span class="comment">	* */</span></span><br><span class="line">       Config.Instance().runOnConnect(<span class="keyword">new</span> Runnable() &#123;</span><br><span class="line">           <span class="keyword">public</span> <span class="keyword">void</span> run() &#123;</span><br><span class="line">               LogUtils.d(<span class="string">"FBReader -&gt; openBook run thread: "</span> + Thread.currentThread());</span><br><span class="line">               LogUtils.d(<span class="string">"FBReader -&gt; openBook run myBook: "</span> + myBook);</span><br><span class="line">               LogUtils.d(<span class="string">"FBReader -&gt; openBook run bookmark: "</span> + bookmark);</span><br><span class="line">               LogUtils.d(<span class="string">"FBReader -&gt; openBook run action: "</span> + action);</span><br><span class="line">               myFBReaderApp.openBook(myBook, bookmark, action);</span><br><span class="line">               <span class="comment">// // <span class="doctag">TODO:</span> 6/7/2017 回到首页</span></span><br><span class="line">               myFBReaderApp.BookTextView.gotoHome();</span><br><span class="line">           &#125;</span><br><span class="line">       &#125;);</span><br><span class="line">   &#125;</span><br></pre></td></tr></table></figure></p>
<p>在最后一句，这个activity中可以拿到myFBReaderApp，猜想是用来控制整个阅读器的类， 调用gotohome， 竟然可以了。通过这个就可以控制是否继续阅读还是从头开始</p>
<h2 id="六、跳转到固定章节"><a href="#六、跳转到固定章节" class="headerlink" title="六、跳转到固定章节"></a>六、跳转到固定章节</h2><p>一本书有很多章节，跳转到固定章节的时候不可能进行一步步的翻页操作。碰巧fbreader提供这样的功能，而且还有快速翻看</p>
<p>找打开一本书之后Model 字段就会赋值， ‘弹幕’一下这个字段， 看到里面确实存在了章节的信息</p>
<p><img src="http://upload-images.jianshu.io/upload_images/1285832-9d1fe7bbd2f273e4.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240" alt="Paste_Image.png"></p>
<p>我知道了章节，然后怎么去跳转，我们看下面这一段代码：<br><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">TOCActivity::openBookText(TOCTree tree)</span><br></pre></td></tr></table></figure></p>
<figure class="highlight mipsasm"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">void openBookText(TOCTree tree) &#123;</span><br><span class="line">	final TOCTree.Reference reference = tree.getReference()<span class="comment">;</span></span><br><span class="line">	if (reference != null) &#123;</span><br><span class="line">		finish()<span class="comment">;</span></span><br><span class="line">		final FBReaderApp fbreader = (FBReaderApp)ZLApplication.<span class="keyword">Instance();</span></span><br><span class="line"><span class="keyword">	</span>	fbreader.<span class="keyword">addInvisibleBookmark();</span></span><br><span class="line"><span class="keyword">	</span>	fbreader.<span class="keyword">BookTextView.gotoPosition(reference.ParagraphIndex, </span><span class="number">0</span>, <span class="number">0</span>)<span class="comment">;</span></span><br><span class="line">		fbreader.<span class="keyword">showBookTextView();</span></span><br><span class="line"><span class="keyword">	</span>	fbreader.storePosition()<span class="comment">;</span></span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>得到reference对象的ParagraphIndex， 然后去调用BookTextView的gotoPosition</p>
<p>在FBReaderApp中这样写试试</p>
<p><img src="http://upload-images.jianshu.io/upload_images/1285832-8f2047c238f09216.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240" alt=""></p>
<p>这样是可以达到预期效果的，但是有一定要值得注意：<br>在第一次读取书时，获取书的操作是个异步的， 也就是说，这个时候Model可能为空，所以在以后开发中，最好是用接口，将获取书的情况反到activity中， 这样，当书加载完成时再去做相应的跳转操作。</p>
<h2 id="七、字体加大与缩小"><a href="#七、字体加大与缩小" class="headerlink" title="七、字体加大与缩小"></a>七、字体加大与缩小</h2><p>源码中，改变字体大小的就在菜单的按键中</p>
<p><img src="http://upload-images.jianshu.io/upload_images/1285832-da2718c32da2c4c5.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240" alt=""></p>
<p>点击按键监听再这里，这么搞也是特殊，从未见过啊，不知道干嘛弄的这么复杂。像这样可以实现这个功能了。</p>
<p>这样只是增加与减少，万一需求上是给定几个固定的字号，然后调节怎么办？所以开始得看看源码</p>
<p><img src="http://upload-images.jianshu.io/upload_images/1285832-293224e691cf1053.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240" alt=""></p>
<p>跟进去发现，最终的action是存在于这个map， 实在主activity创建时put的，所以所有的操作都会交给ZLAction的子类去处理</p>
<p><img src="http://upload-images.jianshu.io/upload_images/1285832-6db0ded4df8dd286.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240" alt=""><br>也就是上面选中的这个类</p>
<figure class="highlight scala"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">ChangeFontSizeAction</span> <span class="keyword">extends</span> <span class="title">FBAction</span> </span>&#123;</span><br><span class="line">	<span class="keyword">private</span> <span class="keyword">final</span> int myDelta;</span><br><span class="line"></span><br><span class="line">	<span class="type">ChangeFontSizeAction</span>(<span class="type">FBReaderApp</span> fbreader, int delta) &#123;</span><br><span class="line">		<span class="keyword">super</span>(fbreader);</span><br><span class="line">		myDelta = delta;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="meta">@Override</span></span><br><span class="line">	<span class="keyword">protected</span> void run(<span class="type">Object</span> ... params) &#123;</span><br><span class="line">        <span class="keyword">final</span> <span class="type">ZLIntegerRangeOption</span> option =</span><br><span class="line">			<span class="type">Reader</span>.<span class="type">ViewOptions</span>.getTextStyleCollection().getBaseStyle().<span class="type">FontSizeOption</span>;</span><br><span class="line">		option.setValue(option.getValue() + myDelta);</span><br><span class="line"></span><br><span class="line">        <span class="type">LogUtils</span>.d(<span class="string">"ChangeFontSizeAction -&gt; run: "</span> + option.getValue());</span><br><span class="line">        <span class="type">Reader</span>.clearTextCaches();</span><br><span class="line">		<span class="type">Reader</span>.getViewWidget().repaint();</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>执行run方法后会设置字号，这里的option.setValue(option.getValue() + myDelta);就是对字号的设置。要是愿意的话可以复写FBAction或者直接使用run方法中的参数进行传值，当然，后一种要好一点。</p>
<h2 id="八、音量键功能"><a href="#八、音量键功能" class="headerlink" title="八、音量键功能"></a>八、音量键功能</h2><p>一个功能完整的阅读器，音量键也都会派上用场。fbreader音量键也不例外</p>
<figure class="highlight processing"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line">ZLAndroidWidget::@Override</span><br><span class="line">	<span class="keyword">public</span> <span class="built_in">boolean</span> onKeyDown(<span class="built_in">int</span> <span class="built_in">keyCode</span>, KeyEvent event) &#123;</span><br><span class="line">		<span class="keyword">final</span> ZLApplication application = ZLApplication.Instance();</span><br><span class="line">		<span class="keyword">final</span> ZLKeyBindings bindings = application.keyBindings();</span><br><span class="line"></span><br><span class="line">		<span class="keyword">if</span> (bindings.hasBinding(<span class="built_in">keyCode</span>, <span class="keyword">true</span>)</span><br><span class="line">				|| bindings.hasBinding(<span class="built_in">keyCode</span>, <span class="keyword">false</span>)) &#123;</span><br><span class="line">			<span class="keyword">if</span> (myKeyUnderTracking != <span class="number">-1</span>) &#123;</span><br><span class="line">				<span class="keyword">if</span> (myKeyUnderTracking == <span class="built_in">keyCode</span>) &#123;</span><br><span class="line">					<span class="keyword">return</span> <span class="keyword">true</span>;</span><br><span class="line">				&#125; <span class="keyword">else</span> &#123;</span><br><span class="line">					myKeyUnderTracking = <span class="number">-1</span>;</span><br><span class="line">				&#125;</span><br><span class="line">			&#125;</span><br><span class="line">			<span class="keyword">if</span> (bindings.hasBinding(<span class="built_in">keyCode</span>, <span class="keyword">true</span>)) &#123;</span><br><span class="line">				myKeyUnderTracking = <span class="built_in">keyCode</span>;</span><br><span class="line">				myTrackingStartTime = System.currentTimeMillis();</span><br><span class="line">				<span class="keyword">return</span> <span class="keyword">true</span>;</span><br><span class="line">			&#125; <span class="keyword">else</span> &#123;</span><br><span class="line">				<span class="keyword">return</span> application.runActionByKey(<span class="built_in">keyCode</span>, <span class="keyword">false</span>);</span><br><span class="line">			&#125;</span><br><span class="line">		&#125; <span class="keyword">else</span> &#123;</span><br><span class="line">			<span class="keyword">return</span> <span class="keyword">false</span>;</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br></pre></td></tr></table></figure>
<figure class="highlight processing"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">final</span> <span class="built_in">boolean</span> runActionByKey(<span class="built_in">int</span> <span class="built_in">key</span>, <span class="built_in">boolean</span> longPress) &#123;</span><br><span class="line">    <span class="keyword">final</span> <span class="keyword">String</span> actionId = keyBindings().getBinding(<span class="built_in">key</span>, longPress);</span><br><span class="line">    <span class="keyword">if</span> (actionId != <span class="keyword">null</span>) &#123;</span><br><span class="line">        <span class="keyword">final</span> ZLAction action = myIdToActionMap.<span class="built_in">get</span>(actionId);</span><br><span class="line">        <span class="keyword">return</span> action != <span class="keyword">null</span> &amp;&amp; action.checkAndRun();</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">false</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>程序在runActionByKey方法中控制这按键</p>
<p>key 是当前案件的键码，会对所有按键处理，如果你接键盘的话。<br>longPress 字面意思是是否长按，但是我试过永远的短按，永远的false</p>
<p>以后处理案件就可在这里处理，或者深入到action里面进行处理。</p>
<h2 id="九、更换背景，字体颜色"><a href="#九、更换背景，字体颜色" class="headerlink" title="九、更换背景，字体颜色"></a>九、更换背景，字体颜色</h2><p>更换背景以及字体颜色，也是实现夜间模式的一个套路。首先我们定位到PreferenceActivity，冷不丁一看，我去，这不是系统里的settings嘛。这么长的init至于么？<br><img src="http://upload-images.jianshu.io/upload_images/1285832-aad6afda339e53dd.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240" alt=""></p>
<p>这么长的代码就不全粘贴了，大概在400多行，有这么一段。是添加背景和墙纸的<br>我们跟到这个类中BackgroundPreference</p>
<p>在onBindView下面是跳转到颜色选择器的代码，在PreferenceActivity中的onActivityResult方法中返回</p>
<figure class="highlight kotlin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="keyword">protected</span> void onActivityResult(int requestCode, int resultCode, Intent <span class="keyword">data</span>) &#123;</span><br><span class="line">    <span class="keyword">if</span> (myNetworkContext.onActivityResult(requestCode, resultCode, <span class="keyword">data</span>)) &#123;</span><br><span class="line">        <span class="keyword">return</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> (resultCode != RESULT_OK) &#123;</span><br><span class="line">        <span class="keyword">return</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> (BACKGROUND_REQUEST_CODE == requestCode) &#123;</span><br><span class="line">        <span class="keyword">if</span> (myBackgroundPreference != <span class="literal">null</span>) &#123;</span><br><span class="line">            myBackgroundPreference.update(<span class="keyword">data</span>);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    myChooserCollection.update(requestCode, <span class="keyword">data</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>中间部分， 调用了yBackgroundPreference.update(data);</p>
<figure class="highlight processing"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> update(Intent data) &#123;</span><br><span class="line">	<span class="keyword">final</span> <span class="keyword">String</span> value = data.getStringExtra(VALUE_KEY);</span><br><span class="line">    LogUtils.d(<span class="string">"BackgroundPreference -&gt; update: "</span> + value);</span><br><span class="line">    <span class="keyword">if</span> (value != <span class="keyword">null</span>) &#123;</span><br><span class="line">		myProfile.WallpaperOption.setValue(value);</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">final</span> <span class="built_in">int</span> <span class="built_in">color</span> = data.getIntExtra(COLOR_KEY, <span class="number">-1</span>);</span><br><span class="line">    LogUtils.d(<span class="string">"BackgroundPreference -&gt; update: "</span> + <span class="built_in">color</span>);</span><br><span class="line">    <span class="keyword">if</span> (<span class="built_in">color</span> != <span class="number">-1</span>) &#123;</span><br><span class="line">		myProfile.BackgroundOption.setValue(<span class="keyword">new</span> ZLColor(<span class="built_in">color</span>));</span><br><span class="line">	&#125;</span><br><span class="line">	notifyChanged();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>继续往里跟，方向设置颜色或者是壁纸图片， 只是设置了WallpaperOption的value。我们能在ColorProfile类中找到这些参数，那么我们怎么在主activity获取并且改变它呢</p>
<p>还是最重要的<figure class="highlight plain"><figcaption><span>的实例 ViewOptions，通过它我们就能拿到ColorProfile， 图下设置背景为红色</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">```</span><br><span class="line"> myFBReaderApp.ViewOptions.getColorProfile().BackgroundOption.setValue(new ZLColor(255, 0, 0));</span><br></pre></td></tr></table></figure></p>
<p>但是直接这么写，没有变化，仔细想想。我只设置了颜色，但是没有通知重绘，自然就没有变化。</p>
<p>那么，颜色选择怎么通知到这个activity的呢，只能是Intent传的，我们看下FBReader 的onActivityResult(int requestCode, int resultCode, Intent data)<br><figure class="highlight aspectj"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="keyword">protected</span> <span class="function"><span class="keyword">void</span> <span class="title">onActivityResult</span><span class="params">(<span class="keyword">int</span> requestCode, <span class="keyword">int</span> resultCode, Intent data)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">switch</span> (requestCode) &#123;</span><br><span class="line">        <span class="keyword">case</span> REQUEST_PREFERENCES:</span><br><span class="line">            <span class="keyword">if</span> (resultCode != RESULT_DO_NOTHING &amp;&amp; data != <span class="keyword">null</span>) &#123;</span><br><span class="line">                <span class="keyword">final</span> Book book = FBReaderIntents.getBookExtra(data);</span><br><span class="line">                <span class="keyword">if</span> (book != <span class="keyword">null</span>) &#123;</span><br><span class="line">                    getCollection().bindToService(<span class="keyword">this</span>, <span class="keyword">new</span> Runnable() &#123;</span><br><span class="line">                        <span class="keyword">public</span> <span class="function"><span class="keyword">void</span> <span class="title">run</span><span class="params">()</span> </span>&#123;</span><br><span class="line">                            onPreferencesUpdate(book);</span><br><span class="line">                        &#125;</span><br><span class="line">                    &#125;);</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">        <span class="keyword">case</span> REQUEST_CANCEL_MENU:</span><br><span class="line">            runCancelAction(data);</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>ok, 确实有我需要的东西，这个方法调用了onPreferencesUpdate<br><figure class="highlight armasm"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="symbol">private</span> void onPreferencesUpdate(<span class="keyword">Book </span><span class="keyword">book) </span>&#123;</span><br><span class="line">     <span class="keyword">AndroidFontUtil.clearFontCache();</span></span><br><span class="line"><span class="keyword"> </span>    myFBReaderApp.onBookUpdated(<span class="keyword">book);</span></span><br><span class="line"><span class="keyword"> </span>&#125;</span><br></pre></td></tr></table></figure></p>
<figure class="highlight haxe"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">\    <span class="keyword">public</span> void onBookUpdated(Book book) &#123;</span><br><span class="line">        <span class="keyword">if</span> (Model == <span class="literal">null</span> || Model.Book == <span class="literal">null</span> || !Model.Book.equals(book)) &#123;</span><br><span class="line">            <span class="keyword">return</span>;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        final <span class="keyword">String</span> <span class="keyword">new</span><span class="type">Encoding</span> = book.getEncodingNoDetection();</span><br><span class="line">        final <span class="keyword">String</span> oldEncoding = Model.Book.getEncodingNoDetection();</span><br><span class="line"></span><br><span class="line">        Model.Book.updateFrom(book);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (<span class="keyword">new</span><span class="type">Encoding</span> != <span class="literal">null</span> &amp;&amp; !<span class="keyword">new</span><span class="type">Encoding</span>.equals(oldEncoding)) &#123;</span><br><span class="line">            reloadBook();</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            ZLTextHyphenator.Instance().load(Model.Book.getLanguage());</span><br><span class="line">            clearTextCaches();</span><br><span class="line">            getViewWidget().repaint();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>
<p>起到决定性作用的就行最后一句 getViewWidget().repaint();</p>
<p>那么，更改背景颜色就是<br>（上面的代码都是等书加载完毕之后，显示在view中在去设置的， 不然书都没加载完，自然也就设置不了）</p>
<p><img src="http://upload-images.jianshu.io/upload_images/1285832-84ea417bf7ba3a04.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240" alt=""><br>BackgroundOption 是背景色<br>RegularTextOption 是文字的颜色</p>
<h2 id="十、动画类型"><a href="#十、动画类型" class="headerlink" title="十、动画类型"></a>十、动画类型</h2><p>下面开始研究应用的翻页动画。<br>我们修改颜色实际上是修改了ZLAndroidWidget。我们可以跟进这个类看一下代码</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">ZLAndroidWidget::getAnimationProvider()</span><br></pre></td></tr></table></figure>
<figure class="highlight scala"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">private</span> <span class="type">AnimationProvider</span> getAnimationProvider() &#123;</span><br><span class="line">		<span class="keyword">final</span> <span class="type">ZLView</span>.<span class="type">Animation</span> <span class="class"><span class="keyword">type</span> </span>= <span class="type">ZLApplication</span>.<span class="type">Instance</span>().getCurrentView()</span><br><span class="line">				.getAnimationType();</span><br><span class="line">		<span class="keyword">if</span> (myAnimationProvider == <span class="literal">null</span> || myAnimationType != <span class="class"><span class="keyword">type</span>) </span>&#123;</span><br><span class="line">			myAnimationType = <span class="class"><span class="keyword">type</span></span>;</span><br><span class="line">			switch (<span class="class"><span class="keyword">type</span>) </span>&#123;</span><br><span class="line">			<span class="keyword">case</span> none:</span><br><span class="line">				myAnimationProvider = <span class="keyword">new</span> <span class="type">NoneAnimationProvider</span>(myBitmapManager);</span><br><span class="line">				<span class="keyword">break</span>;</span><br><span class="line">			<span class="keyword">case</span> curl:</span><br><span class="line">				myAnimationProvider = <span class="keyword">new</span> <span class="type">CurlAnimationProvider</span>(myBitmapManager);</span><br><span class="line">				<span class="keyword">break</span>;</span><br><span class="line">			<span class="keyword">case</span> slide:</span><br><span class="line">				myAnimationProvider = <span class="keyword">new</span> <span class="type">SlideAnimationProvider</span>(</span><br><span class="line">						myBitmapManager);</span><br><span class="line">				<span class="keyword">break</span>;</span><br><span class="line">			<span class="keyword">case</span> shift:</span><br><span class="line">				myAnimationProvider = <span class="keyword">new</span> <span class="type">ShiftAnimationProvider</span>(</span><br><span class="line">						myBitmapManager);</span><br><span class="line">				<span class="keyword">break</span>;</span><br><span class="line">			<span class="keyword">case</span> left2right:</span><br><span class="line">				myAnimationProvider = <span class="keyword">new</span> <span class="type">Left2RightAnimationProvider</span>(</span><br><span class="line">						myBitmapManager);</span><br><span class="line">				<span class="keyword">break</span>;</span><br><span class="line">			<span class="keyword">case</span> simulation:</span><br><span class="line">				<span class="comment">// myAnimationProvider = new SimulateAnimationProvider(</span></span><br><span class="line">				<span class="comment">// myBitmapManager);</span></span><br><span class="line">				myAnimationProvider = <span class="keyword">new</span> <span class="type">EmulateAnimationProvider</span>(</span><br><span class="line">						myBitmapManager);</span><br><span class="line">				<span class="keyword">break</span>;</span><br><span class="line">			&#125;</span><br><span class="line">		&#125;</span><br><span class="line">		<span class="keyword">return</span> myAnimationProvider;</span><br><span class="line">	&#125;</span><br></pre></td></tr></table></figure>
<p>代码跟你的不一样，正常，这个我改过了。<br>在绘制动画的时候，也就是onDrawInScrolling(Canvas canvas)这个方法被调用的时候，都会获取一下当前的动画。</p>
<p>那么在设置动画的时候调用的是PreferenceActivity这个activity，再init一堆东西里看以看到，这样一句话</p>
<p><img src="http://upload-images.jianshu.io/upload_images/1285832-c4dbe0cfdaebc3d6.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240" alt=""></p>
<p>原来是改变的是pageTurningOptions这个东西，我们再看主activity中能不能找到这个对象。回到FBReader当中。我们可以这样设置动画<br><figure class="highlight css"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="selector-tag">myFBReaderApp</span><span class="selector-class">.PageTurningOptions</span><span class="selector-class">.Animation</span><span class="selector-class">.setValue</span>(<span class="selector-tag">ZLView</span><span class="selector-class">.Animation</span><span class="selector-class">.left2right</span>);</span><br></pre></td></tr></table></figure></p>
<p>因为是执行每一次翻页的动作都会get一下当前的动画，所以也就不需要重绘当前页面，写这样一句就好。</p>
<h2 id="十一、点击区域"><a href="#十一、点击区域" class="headerlink" title="十一、点击区域"></a>十一、点击区域</h2><p>市场上的阅读类应用。基本都是点击左面上一页，右面下一页。中间会弹出一个设置菜单。<br>我发现我的这个version的代码，点击中间是没有任何反应的，所以。继续撸码。</p>
<p>关于点击时间， 首先去看ZLAndroidWidget的onTouchEvent方法<br><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">ZLAndroidWidget::onTouchEvent(MotionEvent event)</span><br></pre></td></tr></table></figure></p>
<figure class="highlight groovy"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">boolean</span> onTouchEvent(MotionEvent event) &#123;</span><br><span class="line">	<span class="keyword">int</span> x = (<span class="keyword">int</span>) event.getX();</span><br><span class="line">	<span class="keyword">int</span> y = (<span class="keyword">int</span>) event.getY();</span><br><span class="line">	<span class="keyword">final</span> ZLView view = ZLApplication.Instance().getCurrentView();</span><br><span class="line">	<span class="keyword">switch</span> (event.getAction()) &#123;</span><br><span class="line">	<span class="keyword">case</span> MotionEvent.<span class="string">ACTION_UP:</span></span><br><span class="line">		<span class="keyword">if</span> (myPendingDoubleTap) &#123;</span><br><span class="line">            view.onFingerDoubleTap(x, y);</span><br><span class="line">		&#125; <span class="keyword">else</span> <span class="keyword">if</span> (myLongClickPerformed) &#123;</span><br><span class="line">            view.onFingerReleaseAfterLongPress(x, y);</span><br><span class="line">		&#125; <span class="keyword">else</span> &#123;</span><br><span class="line">			<span class="keyword">if</span> (myPendingLongClickRunnable != <span class="literal">null</span>) &#123;</span><br><span class="line">				removeCallbacks(myPendingLongClickRunnable);</span><br><span class="line">				myPendingLongClickRunnable = <span class="literal">null</span>;</span><br><span class="line">			&#125;</span><br><span class="line">			<span class="keyword">if</span> (myPendingPress) &#123;</span><br><span class="line">				<span class="keyword">if</span> (view.isDoubleTapSupported()) &#123;</span><br><span class="line">					<span class="keyword">if</span> (myPendingShortClickRunnable == <span class="literal">null</span>) &#123;</span><br><span class="line">						myPendingShortClickRunnable = <span class="keyword">new</span> ShortClickRunnable();</span><br><span class="line">					&#125;</span><br><span class="line">					postDelayed(myPendingShortClickRunnable,</span><br><span class="line">							ViewConfiguration.getDoubleTapTimeout());</span><br><span class="line">				&#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                    view.onFingerSingleTap(x, y);</span><br><span class="line">				&#125;</span><br><span class="line">			&#125; <span class="keyword">else</span> &#123;</span><br><span class="line">				view.onFingerRelease(x, y);</span><br><span class="line">			&#125;</span><br><span class="line">		&#125;</span><br><span class="line">		myPendingDoubleTap = <span class="literal">false</span>;</span><br><span class="line">		myPendingPress = <span class="literal">false</span>;</span><br><span class="line">		myScreenIsTouched = <span class="literal">false</span>;</span><br><span class="line">		<span class="keyword">break</span>;</span><br><span class="line">	<span class="keyword">case</span> MotionEvent.<span class="string">ACTION_DOWN:</span></span><br><span class="line">		<span class="keyword">if</span> (myPendingShortClickRunnable != <span class="literal">null</span>) &#123;</span><br><span class="line">			removeCallbacks(myPendingShortClickRunnable);</span><br><span class="line">			myPendingShortClickRunnable = <span class="literal">null</span>;</span><br><span class="line">			myPendingDoubleTap = <span class="literal">true</span>;</span><br><span class="line">		&#125; <span class="keyword">else</span> &#123;</span><br><span class="line">			postLongClickRunnable();</span><br><span class="line">			myPendingPress = <span class="literal">true</span>;</span><br><span class="line">		&#125;</span><br><span class="line">		myScreenIsTouched = <span class="literal">true</span>;</span><br><span class="line">		myPressedX = x;</span><br><span class="line">		myPressedY = y;</span><br><span class="line">		<span class="keyword">break</span>;</span><br><span class="line">	<span class="keyword">case</span> MotionEvent.<span class="string">ACTION_MOVE:</span> &#123;</span><br><span class="line">		<span class="keyword">final</span> <span class="keyword">int</span> slop = ViewConfiguration.get(getContext())</span><br><span class="line">				.getScaledTouchSlop();</span><br><span class="line">		<span class="keyword">final</span> <span class="keyword">boolean</span> isAMove = Math.abs(myPressedX - x) &gt; slop</span><br><span class="line">				|| Math.abs(myPressedY - y) &gt; slop;</span><br><span class="line">		<span class="keyword">if</span> (isAMove) &#123;</span><br><span class="line">			myPendingDoubleTap = <span class="literal">false</span>;</span><br><span class="line">		&#125;</span><br><span class="line">		<span class="keyword">if</span> (myLongClickPerformed) &#123;</span><br><span class="line">			view.onFingerMoveAfterLongPress(x, y);</span><br><span class="line">		&#125; <span class="keyword">else</span> &#123;</span><br><span class="line">			<span class="keyword">if</span> (myPendingPress) &#123;</span><br><span class="line">				<span class="keyword">if</span> (isAMove) &#123;</span><br><span class="line">					<span class="keyword">if</span> (myPendingShortClickRunnable != <span class="literal">null</span>) &#123;</span><br><span class="line">						removeCallbacks(myPendingShortClickRunnable);</span><br><span class="line">						myPendingShortClickRunnable = <span class="literal">null</span>;</span><br><span class="line">					&#125;</span><br><span class="line">					<span class="keyword">if</span> (myPendingLongClickRunnable != <span class="literal">null</span>) &#123;</span><br><span class="line">						removeCallbacks(myPendingLongClickRunnable);</span><br><span class="line">					&#125;</span><br><span class="line">					view.onFingerPress(myPressedX, myPressedY);</span><br><span class="line">					myPendingPress = <span class="literal">false</span>;</span><br><span class="line">				&#125;</span><br><span class="line">			&#125;</span><br><span class="line">			<span class="keyword">if</span> (!myPendingPress) &#123;</span><br><span class="line">				view.onFingerMove(x, y);</span><br><span class="line">			&#125;</span><br><span class="line">		&#125;</span><br><span class="line">		<span class="keyword">break</span>;</span><br><span class="line">	&#125;</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>当按键抬起的时候， 将手指的位置传给了     view.onFingerSingleTap(x, y);<br>view就是FBView这个类。<br><figure class="highlight aspectj"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="keyword">public</span> <span class="function"><span class="keyword">boolean</span> <span class="title">onFingerSingleTap</span><span class="params">(<span class="keyword">int</span> x, <span class="keyword">int</span> y)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (<span class="keyword">super</span>.onFingerSingleTap(x, y)) &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">true</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">final</span> ZLTextRegion hyperlinkRegion = findRegion(x, y, MAX_SELECTION_DISTANCE, ZLTextRegion.HyperlinkFilter);</span><br><span class="line">    <span class="keyword">if</span> (hyperlinkRegion != <span class="keyword">null</span>) &#123;</span><br><span class="line">        <span class="comment">// click link</span></span><br><span class="line">        selectRegion(hyperlinkRegion);</span><br><span class="line">        myReader.getViewWidget().reset();</span><br><span class="line">        myReader.getViewWidget().repaint();</span><br><span class="line">        myReader.runAction(ActionCode.PROCESS_HYPERLINK);</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">true</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">final</span> ZLTextRegion videoRegion = findRegion(x, y, <span class="number">0</span>, ZLTextRegion.VideoFilter);</span><br><span class="line">    <span class="keyword">if</span> (videoRegion != <span class="keyword">null</span>) &#123;</span><br><span class="line">        <span class="comment">// click video</span></span><br><span class="line">        selectRegion(videoRegion);</span><br><span class="line">        myReader.getViewWidget().reset();</span><br><span class="line">        myReader.getViewWidget().repaint();</span><br><span class="line">        myReader.runAction(ActionCode.OPEN_VIDEO, (ZLTextVideoRegionSoul) videoRegion.getSoul());</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">true</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">final</span> ZLTextHighlighting highlighting = findHighlighting(x, y, MAX_SELECTION_DISTANCE);</span><br><span class="line">    <span class="keyword">if</span> (highlighting <span class="keyword">instanceof</span> BookmarkHighlighting) &#123;</span><br><span class="line">        myReader.runAction(</span><br><span class="line">                ActionCode.SELECTION_BOOKMARK,</span><br><span class="line">                ((BookmarkHighlighting) highlighting).Bookmark</span><br><span class="line">        );</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">true</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    String actionId = getZoneMap()</span><br><span class="line">            .getActionByCoordinates(x, y, getContextWidth(), getContextHeight(),</span><br><span class="line">                    isDoubleTapSupported() ? TapZoneMap.Tap.singleNotDoubleTap : TapZoneMap.Tap.singleTap);</span><br><span class="line">    myReader.runAction(actionId, x, y);</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">true</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>这段的最后一句就是或坐标的区域</p>
<p>一路跟下去， 发现<figure class="highlight plain"><figcaption><span>这样一个类，看它的构造</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">```</span><br><span class="line">	private TapZoneMap(String name) &#123;</span><br><span class="line">		Name = name;</span><br><span class="line">		myOptionGroupName = &quot;TapZones:&quot; + name;</span><br><span class="line"></span><br><span class="line">        LogUtils.d(&quot;TapZoneMap -&gt; TapZoneMap: &quot; + name);</span><br><span class="line">        myHeight = new ZLIntegerRangeOption(myOptionGroupName, &quot;Height&quot;, 2, 5, 3);</span><br><span class="line">		myWidth = new ZLIntegerRangeOption(myOptionGroupName, &quot;Width&quot;, 2, 5, 3);</span><br><span class="line">		final ZLFile mapFile = ZLFile.createFileByPath(</span><br><span class="line">			&quot;default/tapzones/&quot; + name.toLowerCase() + &quot;.xml&quot;</span><br><span class="line">		);</span><br><span class="line">		new Reader().readQuietly(mapFile);</span><br><span class="line">	&#125;</span><br></pre></td></tr></table></figure></p>
<p>是读了一个文件，我们在资源文件中找下</p>
<p><img src="http://upload-images.jianshu.io/upload_images/1285832-74a9c42083f5c1fa.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240" alt=""><br>果然在这里躺着一堆的文件，应该是按照屏幕的方向 选择默认的配置文件，这里默认的就是right_to_left.xml，我们打开看看。<br><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">tapZones</span> <span class="attr">v</span>=<span class="string">"3"</span> <span class="attr">h</span>=<span class="string">"3"</span>&gt;</span></span><br><span class="line">	<span class="tag">&lt;<span class="name">zone</span> <span class="attr">x</span>=<span class="string">"0"</span> <span class="attr">y</span>=<span class="string">"0"</span> <span class="attr">action</span>=<span class="string">"previousPage"</span> <span class="attr">action2</span>=<span class="string">"navigate"</span>/&gt;</span></span><br><span class="line">	<span class="tag">&lt;<span class="name">zone</span> <span class="attr">x</span>=<span class="string">"0"</span> <span class="attr">y</span>=<span class="string">"1"</span> <span class="attr">action</span>=<span class="string">"previousPage"</span>/&gt;</span></span><br><span class="line">	<span class="tag">&lt;<span class="name">zone</span> <span class="attr">x</span>=<span class="string">"0"</span> <span class="attr">y</span>=<span class="string">"2"</span> <span class="attr">action</span>=<span class="string">"previousPage"</span> <span class="attr">action2</span>=<span class="string">"menu"</span>/&gt;</span></span><br><span class="line">	<span class="tag">&lt;<span class="name">zone</span> <span class="attr">x</span>=<span class="string">"1"</span> <span class="attr">y</span>=<span class="string">"0"</span> <span class="attr">action2</span>=<span class="string">"navigate"</span>/&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">zone</span> <span class="attr">x</span>=<span class="string">"1"</span> <span class="attr">y</span>=<span class="string">"1"</span> <span class="attr">action2</span>=<span class="string">"menu"</span>/&gt;</span></span><br><span class="line">	<span class="tag">&lt;<span class="name">zone</span> <span class="attr">x</span>=<span class="string">"1"</span> <span class="attr">y</span>=<span class="string">"2"</span> <span class="attr">action2</span>=<span class="string">"menu"</span>/&gt;</span></span><br><span class="line">	<span class="tag">&lt;<span class="name">zone</span> <span class="attr">x</span>=<span class="string">"2"</span> <span class="attr">y</span>=<span class="string">"0"</span> <span class="attr">action</span>=<span class="string">"nextPage"</span> <span class="attr">action2</span>=<span class="string">"navigate"</span>/&gt;</span></span><br><span class="line">	<span class="tag">&lt;<span class="name">zone</span> <span class="attr">x</span>=<span class="string">"2"</span> <span class="attr">y</span>=<span class="string">"1"</span> <span class="attr">action</span>=<span class="string">"nextPage"</span>/&gt;</span></span><br><span class="line">	<span class="tag">&lt;<span class="name">zone</span> <span class="attr">x</span>=<span class="string">"2"</span> <span class="attr">y</span>=<span class="string">"2"</span> <span class="attr">action</span>=<span class="string">"nextPage"</span> <span class="attr">action2</span>=<span class="string">"menu"</span>/&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">tapZones</span>&gt;</span></span><br></pre></td></tr></table></figure></p>
<p><img src="http://upload-images.jianshu.io/upload_images/1285832-73fff0f4033aa646.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240" alt=""></p>
<p>猜测一下，fbreader应该是把屏幕分成3 x 3的区域，大概就是上面图片的意思。用这个坐标代表，我要点击屏幕中间的，自然我就加了一个1，1的坐标。</p>
<p>得到区域后，执行了<figure class="highlight plain"><figcaption><span>myReader.runAction(actionId, x, y);``` 这个方法。</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">跟音量键的一样，他会把事件分发的```ShowMenuAction```这个类里面。</span><br></pre></td></tr></table></figure></p>
<p>class ShowMenuAction extends FBAndroidAction {<br>    ShowMenuAction(FBReader baseActivity, FBReaderApp fbreader) {<br>        super(baseActivity, fbreader);<br>    }</p>
<pre><code>@Override
protected void run(Object ... params) {
    BaseActivity.openOptionsMenu();
    //BaseActivity.menu();
}
</code></pre><p>}<br><code>`</code><br>源码里调用的是openOptionsMenu，这个baseactivity就是我们的FBReader这个类。我改成自己的方法， 就可以定制自己的菜单栏了，然后抛弃源码提供的菜单栏。</p>
<p>ps：代码看到这里差不多可以进行定制了， 但是，代码里确实是有些无用的东西， 要是能把这些东西去掉的话，做一下精简。应该会更好。</p>

  </div>
</article>



        
          <div id="footer-post-container">
  <div id="footer-post">

    <div id="nav-footer" style="display: none">
      <ul>
         
          <li><a href="/">Home</a></li>
         
          <li><a href="/archives/">Writing</a></li>
         
          <li><a href="https://www.jianshu.com/u/4215db84d54e">JianShu</a></li>
         
          <li><a href="https://github.com/LavenderStream">GitHub</a></li>
         
          <li><a href="/about/">About</a></li>
        
      </ul>
    </div>

    <div id="toc-footer" style="display: none">
      <ol class="toc"><li class="toc-item toc-level-1"><a class="toc-link" href="#FBREADER-源码阅读笔记"><span class="toc-number">1.</span> <span class="toc-text">FBREADER 源码阅读笔记</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#前言"><span class="toc-number">1.1.</span> <span class="toc-text">前言</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#一、代码导入"><span class="toc-number">1.2.</span> <span class="toc-text">一、代码导入</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#1、目的"><span class="toc-number">1.2.1.</span> <span class="toc-text">1、目的</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#2、导入"><span class="toc-number">1.2.2.</span> <span class="toc-text">2、导入</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#3、运行"><span class="toc-number">1.2.3.</span> <span class="toc-text">3、运行</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#二、源码目录"><span class="toc-number">1.3.</span> <span class="toc-text">二、源码目录</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#三、无目的的瞎看"><span class="toc-number">1.4.</span> <span class="toc-text">三、无目的的瞎看</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#四、怎样获得book对象"><span class="toc-number">1.5.</span> <span class="toc-text">四、怎样获得book对象</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#这里留一个问题，-这个booktree是怎么来的？-先不着急分析他"><span class="toc-number">1.5.1.</span> <span class="toc-text">这里留一个问题， 这个booktree是怎么来的？ 先不着急分析他</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#五、怎么跳转到Fbreader这个activity"><span class="toc-number">1.6.</span> <span class="toc-text">五、怎么跳转到Fbreader这个activity</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#六、跳转到固定章节"><span class="toc-number">1.7.</span> <span class="toc-text">六、跳转到固定章节</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#七、字体加大与缩小"><span class="toc-number">1.8.</span> <span class="toc-text">七、字体加大与缩小</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#八、音量键功能"><span class="toc-number">1.9.</span> <span class="toc-text">八、音量键功能</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#九、更换背景，字体颜色"><span class="toc-number">1.10.</span> <span class="toc-text">九、更换背景，字体颜色</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#十、动画类型"><span class="toc-number">1.11.</span> <span class="toc-text">十、动画类型</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#十一、点击区域"><span class="toc-number">1.12.</span> <span class="toc-text">十一、点击区域</span></a></li></ol></li></ol>
    </div>

    <div id="share-footer" style="display: none">
      <ul>
  <li><a class="icon" href="http://www.facebook.com/sharer.php?u=https://lavenderstream.github.io/2017/06/07/Android-FBReader-阅读笔记/"><i class="fab fa-facebook fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" href="https://twitter.com/share?url=https://lavenderstream.github.io/2017/06/07/Android-FBReader-阅读笔记/&text=Android -- FBReader 阅读笔记 （一）"><i class="fab fa-twitter fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" href="http://www.linkedin.com/shareArticle?url=https://lavenderstream.github.io/2017/06/07/Android-FBReader-阅读笔记/&title=Android -- FBReader 阅读笔记 （一）"><i class="fab fa-linkedin fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" href="https://pinterest.com/pin/create/bookmarklet/?url=https://lavenderstream.github.io/2017/06/07/Android-FBReader-阅读笔记/&is_video=false&description=Android -- FBReader 阅读笔记 （一）"><i class="fab fa-pinterest fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" href="mailto:?subject=Android -- FBReader 阅读笔记 （一）&body=Check out this article: https://lavenderstream.github.io/2017/06/07/Android-FBReader-阅读笔记/"><i class="fas fa-envelope fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" href="https://getpocket.com/save?url=https://lavenderstream.github.io/2017/06/07/Android-FBReader-阅读笔记/&title=Android -- FBReader 阅读笔记 （一）"><i class="fab fa-get-pocket fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" href="http://reddit.com/submit?url=https://lavenderstream.github.io/2017/06/07/Android-FBReader-阅读笔记/&title=Android -- FBReader 阅读笔记 （一）"><i class="fab fa-reddit fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" href="http://www.stumbleupon.com/submit?url=https://lavenderstream.github.io/2017/06/07/Android-FBReader-阅读笔记/&title=Android -- FBReader 阅读笔记 （一）"><i class="fab fa-stumbleupon fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" href="http://digg.com/submit?url=https://lavenderstream.github.io/2017/06/07/Android-FBReader-阅读笔记/&title=Android -- FBReader 阅读笔记 （一）"><i class="fab fa-digg fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" href="http://www.tumblr.com/share/link?url=https://lavenderstream.github.io/2017/06/07/Android-FBReader-阅读笔记/&name=Android -- FBReader 阅读笔记 （一）&description="><i class="fab fa-tumblr fa-lg" aria-hidden="true"></i></a></li>
</ul>

    </div>

    <div id="actions-footer">
        <a id="menu" class="icon" href="#" onclick="$('#nav-footer').toggle();return false;"><i class="fas fa-bars fa-lg" aria-hidden="true"></i> Menu</a>
        <a id="toc" class="icon" href="#" onclick="$('#toc-footer').toggle();return false;"><i class="fas fa-list fa-lg" aria-hidden="true"></i> TOC</a>
        <a id="share" class="icon" href="#" onclick="$('#share-footer').toggle();return false;"><i class="fas fa-share-alt fa-lg" aria-hidden="true"></i> Share</a>
        <a id="top" style="display:none" class="icon" href="#" onclick="$('html, body').animate({ scrollTop: 0 }, 'fast');"><i class="fas fa-chevron-up fa-lg" aria-hidden="true"></i> Top</a>
    </div>

  </div>
</div>

        
        <footer id="footer">
    <div class="footer-left">
        Copyright &copy; 2018 by Tiny
    </div>
    <div class="footer-right">
        <nav>
            <ul>
                
                
                <li><a href="/">Home</a></li>
                
                
                <li><a href="/archives/">Writing</a></li>
                
                
                <li><a href="https://www.jianshu.com/u/4215db84d54e" target="_blank">JianShu</a></li>
                
                
                <li><a href="https://github.com/LavenderStream" target="_blank">GitHub</a></li>
                
                
                <li><a href="/about/">About</a></li>
                
            </ul>
        </nav>
    </div>
</footer>

    </div>
</body>
</html>
<!-- styles -->
<link rel="stylesheet" href="/lib/font-awesome/css/all.min.css">
<link rel="stylesheet" href="/lib/justified-gallery/css/justifiedGallery.min.css">

<!-- jquery -->
<script src="/lib/jquery/jquery.min.js"></script>
<script src="/lib/justified-gallery/js/jquery.justifiedGallery.min.js"></script>
<script src="/js/main.js"></script>
<script src="/js/plugin.js"></script>

<!-- search -->

<!-- Google Analytics -->

<!-- Baidu Analytics -->

<!-- Disqus Comments -->


